<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Iframe Diagnostic</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 80vh; }
        .panel { background: #2a2a2a; padding: 20px; border-radius: 8px; overflow: auto; }
        iframe { width: 100%; height: 300px; border: 3px solid #ff0000; background: #ffff00; }
        .diagnostic { font-family: monospace; font-size: 12px; line-height: 1.4; }
        .diagnostic div { margin: 3px 0; padding: 2px 5px; border-radius: 3px; }
        .info { background: #2d4a5a; }
        .success { background: #2d5a2d; }
        .error { background: #5a2d2d; }
        .warning { background: #5a4a2d; }
        button { background: #666; color: white; border: none; padding: 8px 15px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #888; }
        .status { background: #333; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üî¨ First Principles Iframe Diagnostic</h1>
    
    <div class="status">
        <strong>Iframe Element Status:</strong> <span id="iframeStatus">Checking...</span><br>
        <strong>Current SRC:</strong> <span id="currentSrc">None</span><br>
        <strong>Network Requests:</strong> <span id="networkStatus">Monitoring...</span>
    </div>
    
    <button onclick="testDataURI()">Test Data URI</button>
    <button onclick="testSameOrigin()">Test Same Origin</button>
    <button onclick="testExternal()">Test External</button>
    <button onclick="inspectIframe()">Inspect Iframe</button>
    <button onclick="clearDiagnostic()">Clear</button>

    <div class="container">
        <div class="panel">
            <h3>üñºÔ∏è Iframe (Yellow background = no content loaded)</h3>
            <iframe id="diagnosticIframe" src="about:blank"></iframe>
            
            <div style="margin-top: 20px;">
                <strong>Manual SRC test:</strong><br>
                <input type="text" id="manualSrc" placeholder="Enter URL to test" style="width: 300px; padding: 5px; background: #333; color: white; border: 1px solid #666;">
                <button onclick="loadManualSrc()">Load</button>
            </div>
        </div>
        
        <div class="panel">
            <h3>üìä Diagnostic Log</h3>
            <div id="diagnostic" class="diagnostic"></div>
        </div>
    </div>

    <script>
        const iframe = document.getElementById('diagnosticIframe');
        const diagnostic = document.getElementById('diagnostic');
        const iframeStatus = document.getElementById('iframeStatus');
        const currentSrc = document.getElementById('currentSrc');
        const networkStatus = document.getElementById('networkStatus');
        
        let requestCount = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${timestamp}] ${message}`;
            diagnostic.appendChild(div);
            diagnostic.scrollTop = diagnostic.scrollHeight;
            console.log(`[DIAGNOSTIC] ${message}`);
        }

        function clearDiagnostic() {
            diagnostic.innerHTML = '';
        }

        function updateStatus() {
            iframeStatus.textContent = iframe ? 'Exists' : 'Missing';
            currentSrc.textContent = iframe.src || 'None';
        }

        // Monitor iframe events
        iframe.addEventListener('load', function() {
            log('‚úÖ IFRAME LOAD EVENT FIRED', 'success');
            log(`üìç Loaded URL: ${iframe.src}`, 'success');
            updateStatus();
            
            // Try to access iframe content
            try {
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                log(`üìÑ Iframe document title: "${doc.title}"`, 'success');
                log(`üåê Iframe location: ${iframe.contentWindow.location.href}`, 'success');
                log(`üìè Iframe document body height: ${doc.body ? doc.body.scrollHeight : 'No body'}px`, 'info');
            } catch (e) {
                log(`‚ùå Cannot access iframe content: ${e.message}`, 'error');
            }
        });

        iframe.addEventListener('error', function() {
            log('‚ùå IFRAME ERROR EVENT FIRED', 'error');
            updateStatus();
        });

        // Listen for messages from iframe
        window.addEventListener('message', function(event) {
            log(`üì® Message from iframe: ${JSON.stringify(event.data)}`, 'success');
            log(`üìç Message origin: ${event.origin}`, 'info');
        });

        // Test functions
        function testDataURI() {
            log('üß™ Testing Data URI (should always work)...', 'info');
            iframe.src = 'data:text/html,<html><body style="background:lime;color:black;padding:20px;text-align:center;"><h1>DATA URI TEST</h1><p>If you see this, Data URI works!</p><script>window.parent.postMessage({type:"dataUriTest", success:true}, "*");</script></body></html>';
            requestCount++;
        }

        function testSameOrigin() {
            log('üß™ Testing Same Origin page...', 'info');
            iframe.src = '/simple_test.html';
            requestCount++;
        }

        function testExternal() {
            log('üß™ Testing External URL (should be blocked)...', 'info');
            iframe.src = 'https://www.google.com';
            requestCount++;
        }

        function inspectIframe() {
            log('üîç IFRAME INSPECTION:', 'info');
            log(`- Element exists: ${!!iframe}`, 'info');
            log(`- Current src: "${iframe.src}"`, 'info');
            log(`- Computed width: ${getComputedStyle(iframe).width}`, 'info');
            log(`- Computed height: ${getComputedStyle(iframe).height}`, 'info');
            log(`- Display style: ${getComputedStyle(iframe).display}`, 'info');
            log(`- Visibility: ${getComputedStyle(iframe).visibility}`, 'info');
            log(`- Position in DOM: ${iframe.parentNode ? 'Has parent' : 'Orphaned'}`, iframe.parentNode ? 'success' : 'error');
            log(`- Total requests attempted: ${requestCount}`, 'info');
        }

        function loadManualSrc() {
            const src = document.getElementById('manualSrc').value.trim();
            if (!src) {
                log('‚ö†Ô∏è Enter a URL to test', 'warning');
                return;
            }
            log(`üéØ Testing manual URL: ${src}`, 'info');
            iframe.src = src;
            requestCount++;
        }

        // Initial state
        log('üöÄ Diagnostic started', 'info');
        log('üîç First principles check: Does iframe element exist and can it display content?', 'info');
        updateStatus();
        
        // Auto-run data URI test after 2 seconds
        setTimeout(() => {
            log('‚è∞ Auto-running Data URI test...', 'info');
            testDataURI();
        }, 2000);
        
        // Check if there are any global errors
        window.addEventListener('error', function(e) {
            log(`üí• Global JavaScript error: ${e.message}`, 'error');
        });
    </script>
</body>
</html>