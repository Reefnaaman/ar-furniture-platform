<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - newfurniture.live</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <!-- Meta Tags -->
    <meta name="description" content="Admin dashboard for managing AR furniture platform">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#2c3e50">
    
    <!-- Force cache refresh -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 255, 0.05) 0%, transparent 50%),
                linear-gradient(135deg, #0a0c10 0%, #0d1117 50%, #111418 100%);
            color: #e6edf3;
            min-height: 100vh;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="0.5" fill="%23ffffff" opacity="0.02"/><circle cx="75" cy="75" r="0.3" fill="%23ffffff" opacity="0.02"/><circle cx="50" cy="10" r="0.4" fill="%23ffffff" opacity="0.01"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>'),
                linear-gradient(180deg, rgba(88, 166, 255, 0.02) 0%, transparent 100%);
            pointer-events: none;
            z-index: -1;
        }
        
        .header {
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
            color: #e6edf3;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-family: 'Inter', sans-serif;
            font-size: 32px;
            font-weight: 300;
            letter-spacing: 3px;
            background: linear-gradient(135deg, #ffffff 0%, #a8a8a8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .nav-button {
            background: rgba(240, 246, 252, 0.1);
            color: #e6edf3;
            border: 1px solid rgba(240, 246, 252, 0.2);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            font-size: 14px;
        }
        
        .nav-button:hover {
            background: rgba(240, 246, 252, 0.15);
            border-color: rgba(240, 246, 252, 0.3);
            transform: translateY(-1px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                gap: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                gap: 8px;
            }
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.9) 0%, rgba(30, 35, 42, 0.8) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(240, 246, 252, 0.15);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 1px 0 rgba(255, 255, 255, 0.05) inset;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.5), transparent);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 1px 0 rgba(255, 255, 255, 0.1) inset;
            border-color: rgba(88, 166, 255, 0.3);
        }
        
        .stat-label {
            color: #7d8590;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #e6edf3;
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-icon {
            float: right;
            font-size: 2rem;
            opacity: 0.4;
        }
        
        @media (max-width: 768px) {
            .stat-icon {
                font-size: 1.5rem;
            }
            .stat-value {
                font-size: 1.8rem !important;
            }
            .stat-label {
                font-size: 0.8rem !important;
            }
        }
        
        @media (max-width: 480px) {
            .stat-icon {
                font-size: 1.2rem;
            }
            .stat-value {
                font-size: 1.5rem !important;
            }
            .stat-label {
                font-size: 0.7rem !important;
                line-height: 1.2;
            }
        }
        
        .models-section {
            margin-top: 40px;
            margin-bottom: 40px;
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.9) 0%, rgba(30, 35, 42, 0.8) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(240, 246, 252, 0.15);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 1px 0 rgba(255, 255, 255, 0.05) inset;
            position: relative;
            overflow: hidden;
        }
        
        .models-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.6), rgba(120, 200, 255, 0.6), transparent);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #e6edf3;
        }
        
        .refresh-button {
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .refresh-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(88, 166, 255, 0.3);
        }

        .section-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .action-button.secondary {
            background: linear-gradient(135deg, #f85149, #ff6b6b);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-button.secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(248, 81, 73, 0.3);
            background: linear-gradient(135deg, #ff6b6b, #f85149);
        }
        
        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .model-card {
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.95) 0%, rgba(30, 35, 42, 0.9) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 1px 0 rgba(255, 255, 255, 0.05) inset;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .model-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.4), transparent);
            z-index: 1;
        }
        
        .model-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.6),
                0 2px 0 rgba(88, 166, 255, 0.2) inset;
            border-color: rgba(88, 166, 255, 0.4);
        }
        
        .model-card:hover::before {
            background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.8), rgba(120, 200, 255, 0.6), transparent);
        }
        
        .model-preview {
            position: relative;
            height: 200px;
            background: linear-gradient(135deg, #0d1117 0%, #21262d 100%);
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
        }
        
        .model-viewer {
            width: 100%;
            height: 100%;
        }
        
        .model-info {
            padding: 16px;
        }
        
        .model-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e6edf3;
            margin-bottom: 8px;
        }
        
        .model-description {
            color: #7d8590;
            font-size: 0.9rem;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .model-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: #7d8590;
        }
        
        .model-id {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: rgba(240, 246, 252, 0.1);
            color: #79c0ff;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        
        .model-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #58a6ff;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #7d8590;
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Legacy styles removed - using card-actions-consolidated instead */
        
        .action-button {
            padding: 6px 10px;
            border: 1px solid rgba(240, 246, 252, 0.2);
            background: rgba(240, 246, 252, 0.05);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            color: #e6edf3;
            display: inline-block;
            flex: 1;
            text-align: center;
        }
        
        .action-button:hover {
            border-color: rgba(88, 166, 255, 0.5);
            background: rgba(88, 166, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .action-button.delete {
            color: #f85149;
            border-color: rgba(248, 81, 73, 0.3);
            background: rgba(248, 81, 73, 0.1);
        }
        
        .action-button.delete:hover {
            background: rgba(248, 81, 73, 0.2);
            border-color: rgba(248, 81, 73, 0.5);
        }
        
        .action-button.variant-btn {
            background: rgba(255, 165, 0, 0.1);
            border-color: rgba(255, 165, 0, 0.3);
            color: #ffa500;
        }
        
        .action-button.variant-btn:hover {
            background: rgba(255, 165, 0, 0.2);
            border-color: rgba(255, 165, 0, 0.5);
        }
        
        /* Consolidated Button Layout */
        .card-actions-consolidated {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }
        
        .action-button.primary {
            background: rgba(88, 166, 255, 0.15);
            border-color: rgba(88, 166, 255, 0.3);
            color: #58a6ff;
        }
        
        .action-button.primary:hover {
            background: rgba(88, 166, 255, 0.25);
            border-color: rgba(88, 166, 255, 0.5);
        }
        
        .action-button.settings {
            background: rgba(163, 113, 247, 0.15);
            border-color: rgba(163, 113, 247, 0.3);
            color: #a371f7;
        }
        
        .action-button.settings:hover {
            background: rgba(163, 113, 247, 0.25);
            border-color: rgba(163, 113, 247, 0.5);
        }
        
        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .settings-modal-content {
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.95) 0%, rgba(30, 35, 42, 0.9) 100%);
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 16px;
            padding: 0;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .settings-modal-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
            background: rgba(88, 166, 255, 0.05);
        }
        
        .settings-modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e6edf3;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-modal-body {
            padding: 20px 24px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .settings-section {
            margin-bottom: 24px;
        }
        
        .settings-section:last-child {
            margin-bottom: 0;
        }
        
        .settings-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #7d8590;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .settings-action {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(240, 246, 252, 0.05);
            border: 1px solid rgba(240, 246, 252, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        
        .settings-action:hover {
            background: rgba(240, 246, 252, 0.08);
            border-color: rgba(240, 246, 252, 0.2);
        }
        
        .settings-action-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .settings-action-label {
            color: #e6edf3;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .settings-action-desc {
            color: #7d8590;
            font-size: 0.85rem;
        }
        
        .settings-action-button {
            padding: 6px 12px;
            font-size: 0.85rem;
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 6px;
            background: rgba(240, 246, 252, 0.05);
            color: #e6edf3;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .settings-action-button:hover {
            background: rgba(240, 246, 252, 0.1);
            border-color: rgba(240, 246, 252, 0.3);
        }
        
        .settings-action-button.danger {
            background: rgba(248, 81, 73, 0.1);
            border-color: rgba(248, 81, 73, 0.3);
            color: #f85149;
        }
        
        .settings-action-button.danger:hover {
            background: rgba(248, 81, 73, 0.2);
            border-color: rgba(248, 81, 73, 0.5);
        }
        
        .settings-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(240, 246, 252, 0.1);
            display: flex;
            justify-content: flex-end;
        }
        
        .settings-close-button {
            padding: 8px 16px;
            background: rgba(240, 246, 252, 0.1);
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 6px;
            color: #7d8590;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .settings-close-button:hover {
            background: rgba(240, 246, 252, 0.15);
            border-color: rgba(240, 246, 252, 0.3);
            color: #e6edf3;
        }

        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            margin-right: 6px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px;
            color: #999;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #666;
        }
        
        
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(22, 27, 34, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(240, 246, 252, 0.2);
            padding: 20px;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #e6edf3;
        }
        
        .password-input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(240, 246, 252, 0.2);
            background: rgba(240, 246, 252, 0.05);
            color: #e6edf3;
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #58a6ff;
            background: rgba(240, 246, 252, 0.1);
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .modal-button.primary {
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            color: white;
            font-weight: 500;
        }
        
        .modal-button.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(88, 166, 255, 0.3);
        }
        
        .modal-button.secondary {
            background: rgba(240, 246, 252, 0.1);
            color: #e6edf3;
            border: 1px solid rgba(240, 246, 252, 0.2);
        }
        
        .modal-button.secondary:hover {
            background: rgba(240, 246, 252, 0.15);
            border-color: rgba(240, 246, 252, 0.3);
        }

        /* Export Modal Styles */
        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #e6edf3;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            background: rgba(13, 17, 23, 0.8);
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 8px;
            color: #e6edf3;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: rgba(88, 166, 255, 0.5);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-col {
            flex: 1;
        }

        .color-picker {
            height: 40px;
            padding: 4px;
            cursor: pointer;
        }

        .checkbox-label {
            display: flex !important;
            align-items: center;
            gap: 8px;
            margin-bottom: 0 !important;
            cursor: pointer;
            font-weight: 400 !important;
        }

        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin: 0;
            transform: scale(1.2);
        }

        .qr-options {
            background: rgba(13, 17, 23, 0.6);
            border: 1px solid rgba(240, 246, 252, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin-top: 8px;
        }

        .export-status {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin: 16px 0;
        }

        .status-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .status-text {
            color: #58a6ff;
            font-weight: 500;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid rgba(240, 246, 252, 0.1);
        }
        
        .copy-button {
            cursor: pointer;
            color: #667eea;
            margin-left: 10px;
            font-size: 1.2rem;
        }
        
        .copy-button:hover {
            color: #5568d3;
        }
        
        /* Futuristic Upload Styles */
        .futuristic-upload {
            max-width: 550px !important;
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.98) 0%, rgba(30, 35, 42, 0.95) 100%);
            border: 2px solid rgba(88, 166, 255, 0.2);
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        }
        
        .upload-header {
            text-align: center;
            margin-bottom: 10px;
            position: relative;
        }
        
        .upload-icon-container {
            display: flex;
            justify-content: center;
            margin-bottom: 12px;
        }
        
        .upload-icon-bg {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.2), rgba(120, 200, 255, 0.1));
            border: 2px solid rgba(88, 166, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: iconPulse 3s ease-in-out infinite;
        }
        
        @keyframes iconPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(88, 166, 255, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(88, 166, 255, 0); }
        }
        
        .upload-icon {
            width: 32px;
            height: 32px;
            color: #58a6ff;
        }
        
        .upload-title {
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(135deg, #e6edf3, #58a6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        
        .upload-subtitle {
            color: #7d8590;
            font-size: 0.95rem;
            font-weight: 400;
        }
        
        .futuristic-drop-zone {
            position: relative;
            margin-bottom: 12px;
        }
        
        .drop-zone-content {
            border: 2px dashed rgba(88, 166, 255, 0.3);
            border-radius: 16px;
            padding: 18px 15px;
            text-align: center;
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.02), rgba(120, 200, 255, 0.01));
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .drop-zone-content::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, transparent, rgba(88, 166, 255, 0.1), transparent);
            border-radius: 16px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .drop-zone-content:hover {
            border-color: rgba(88, 166, 255, 0.5);
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.05), rgba(120, 200, 255, 0.02));
        }
        
        .drop-zone-content:hover::before {
            opacity: 1;
        }
        
        .drop-animation {
            position: relative;
            display: inline-block;
            margin-bottom: 12px;
        }
        
        .drop-ring {
            width: 60px;
            height: 60px;
            border: 2px solid rgba(88, 166, 255, 0.3);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: ripple 2s ease-out infinite;
        }
        
        .drop-ring:nth-child(2) { animation-delay: 0.5s; }
        .drop-ring:nth-child(3) { animation-delay: 1s; }
        
        @keyframes ripple {
            0% {
                width: 20px;
                height: 20px;
                opacity: 1;
            }
            100% {
                width: 80px;
                height: 80px;
                opacity: 0;
            }
        }
        
        .upload-text {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 14px;
        }
        
        .primary-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e6edf3;
        }
        
        .secondary-text {
            font-size: 0.95rem;
            color: #7d8590;
        }
        
        .click-text {
            color: #58a6ff;
            font-weight: 500;
        }
        
        .format-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .format-badge {
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid rgba(88, 166, 255, 0.2);
        }
        
        .size-limit {
            color: #7d8590;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        .drag-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.15), rgba(120, 200, 255, 0.1));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }
        
        .futuristic-drop-zone.drag-over .drag-overlay {
            opacity: 1;
        }
        
        .drag-content {
            text-align: center;
            color: #58a6ff;
        }
        
        .drag-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            animation: bounce 0.6s ease infinite alternate;
        }
        
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }
        
        .file-preview-container {
            margin-bottom: 10px;
        }
        
        .file-preview-card {
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.1), rgba(120, 200, 255, 0.05));
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-icon {
            font-size: 2rem;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: #e6edf3;
            margin-bottom: 4px;
        }
        
        .file-size {
            color: #7d8590;
            font-size: 0.9rem;
        }
        
        .remove-file-btn {
            background: rgba(248, 81, 73, 0.1);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
            border-radius: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .remove-file-btn:hover {
            background: rgba(248, 81, 73, 0.2);
        }
        
        .input-group {
            position: relative;
            margin-bottom: 10px;
        }
        
        .futuristic-input {
            width: 100%;
            background: rgba(240, 246, 252, 0.03);
            border: 1px solid rgba(240, 246, 252, 0.1);
            color: #e6edf3;
            padding: 12px;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        
        .futuristic-input:focus {
            outline: none;
            border-color: rgba(88, 166, 255, 0.5);
            background: rgba(240, 246, 252, 0.05);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }
        
        .futuristic-input.textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .field-hint {
            color: #7d8590;
            font-size: 0.875rem;
            margin-top: 8px;
            display: block;
            font-style: italic;
            opacity: 0.8;
        }
        
        /* Product URL editing styles */
        .product-url-container {
            margin-top: 8px;
        }
        
        .product-url-btn {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            color: #58a6ff;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            width: 100%;
            text-align: left;
            word-break: break-all;
            line-height: 1.3;
            margin-top: 4px;
        }
        
        .product-url-btn:hover {
            background: rgba(88, 166, 255, 0.2);
            border-color: rgba(88, 166, 255, 0.5);
            transform: translateY(-1px);
        }
        
        .product-url-btn[data-empty="true"] {
            color: #7d8590;
            border-color: rgba(125, 133, 144, 0.3);
            background: rgba(125, 133, 144, 0.05);
        }
        
        .product-url-btn[data-empty="true"]:hover {
            color: #58a6ff;
            border-color: rgba(88, 166, 255, 0.5);
            background: rgba(88, 166, 255, 0.1);
        }
        
        .editable-title {
            cursor: pointer;
            position: relative;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        
        .editable-title:hover {
            background: rgba(88, 166, 255, 0.1);
        }
        
        .input-line {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            width: 0;
            background: linear-gradient(90deg, #58a6ff, #79c0ff);
            transition: width 0.3s ease;
            border-radius: 1px;
        }
        
        .futuristic-input:focus + .input-line {
            width: 100%;
        }
        
        /* Password Toggle Button Styles */
        .password-input-group {
            position: relative;
        }
        
        .password-toggle-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            z-index: 10;
            border-radius: 6px;
            transition: all 0.2s ease;
            color: #7d8590;
        }
        
        .password-toggle-btn:hover {
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
        }
        
        .password-toggle-btn .eye-icon {
            width: 18px;
            height: 18px;
        }
        
        .password-input-group .futuristic-input {
            padding-right: 50px;
        }
        
        .input-label {
            display: block;
            color: #7d8590;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .password-note {
            margin-top: 6px;
            padding-left: 4px;
        }
        
        .futuristic-primary {
            position: relative;
            overflow: hidden;
        }
        
        .button-text {
            position: relative;
            z-index: 2;
        }
        
        .button-glow {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }
        
        .futuristic-primary:hover .button-glow {
            left: 100%;
        }
        
        .upload-progress {
            margin-top: 25px;
        }
        
        .progress-label {
            color: #e6edf3;
            font-weight: 500;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .progress-track {
            flex: 1;
            height: 6px;
            background: rgba(240, 246, 252, 0.1);
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #79c0ff);
            border-radius: 3px;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-glow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.5), transparent);
            opacity: 0;
            animation: progressGlow 2s ease-in-out infinite;
        }
        
        @keyframes progressGlow {
            0%, 100% { opacity: 0; transform: translateX(-100%); }
            50% { opacity: 1; transform: translateX(100%); }
        }
        
        .progress-percentage {
            color: #58a6ff;
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 40px;
        }
        
        .customer-select {
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8"><path fill="%2358a6ff" d="M6 8L0 2h12L6 8z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 50px;
        }
        
        /* Customer Groups Styles */
        .customer-groups {
            margin-top: 30px;
        }
        
        .customer-group {
            margin-bottom: 40px;
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.6), rgba(30, 35, 42, 0.5));
            border: 1px solid rgba(240, 246, 252, 0.1);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .customer-group:hover {
            border-color: rgba(88, 166, 255, 0.2);
        }
        
        /* Sidebar Styles */
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, rgba(13, 17, 23, 0.95) 0%, rgba(22, 27, 34, 0.9) 100%);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(240, 246, 252, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow: hidden; /* Prevent sidebar itself from scrolling */
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        
        
        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
            text-align: center;
        }
        
        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e6edf3;
            margin-bottom: 5px;
        }
        
        .sidebar-subtitle {
            font-size: 0.85rem;
            color: #7d8590;
        }
        
        .sidebar-search {
            padding: 20px;
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
        }
        
        .search-input {
            width: 100%;
            background: rgba(22, 27, 34, 0.8);
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 12px;
            color: #e6edf3;
            padding: 12px 16px;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s ease;
        }
        
        .search-input:focus {
            border-color: rgba(88, 166, 255, 0.5);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }
        
        .search-input::placeholder {
            color: #7d8590;
        }
        
        
        .sidebar-section {
            padding: 20px;
        }
        
        .sidebar-customers {
            padding: 20px;
            flex: 1;
            overflow: hidden; /* Prevent this section from expanding */
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-customers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .sidebar-customers-title {
            font-size: 0.9rem;
            color: #7d8590;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        .add-customer-btn {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            color: #58a6ff;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .add-customer-btn:hover {
            background: rgba(88, 166, 255, 0.2);
        }
        
        .customer-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
            max-height: 200px; /* Smaller height to keep logout visible */
            overflow-y: auto;
            flex: 1; /* Allow it to grow within available space */
            min-height: 0; /* Important for flex scrolling */
        }
        
        .customer-item {
            padding: 12px 16px;
            margin-bottom: 6px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
        }
        
        .customer-item:hover {
            background: rgba(240, 246, 252, 0.05);
            border-color: rgba(240, 246, 252, 0.1);
        }
        
        .customer-item.active {
            background: rgba(88, 166, 255, 0.1);
            border-color: rgba(88, 166, 255, 0.3);
        }
        
        .customer-item-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .customer-name {
            color: #e6edf3;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .customer-count {
            background: rgba(88, 166, 255, 0.2);
            color: #58a6ff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .main-content {
            margin-left: 321px;
            flex: 1;
        }
        
        .add-customer-form {
            display: none;
            padding: 10px;
            background: rgba(22, 27, 34, 0.8);
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .add-customer-input {
            width: 100%;
            background: rgba(13, 17, 23, 0.8);
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 8px;
            color: #e6edf3;
            padding: 8px 12px;
            font-size: 0.85rem;
            outline: none;
            margin-bottom: 8px;
        }
        
        .add-customer-actions {
            display: flex;
            gap: 8px;
        }
        
        .add-customer-save,
        .add-customer-cancel {
            flex: 1;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .add-customer-save {
            background: rgba(46, 160, 67, 0.2);
            border: 1px solid rgba(46, 160, 67, 0.4);
            color: #3fb950;
        }
        
        .add-customer-cancel {
            background: rgba(248, 81, 73, 0.2);
            border: 1px solid rgba(248, 81, 73, 0.4);
            color: #f85149;
        }
        
        
        
        /* Assign Dropdown */
        .assign-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .assign-button {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            color: #ffa500;
        }
        
        .assign-button:hover {
            background: rgba(255, 165, 0, 0.2);
            border-color: rgba(255, 165, 0, 0.5);
        }
        
        .assign-dropdown-content {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            min-width: 200px;
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.95) 0%, rgba(30, 35, 42, 0.9) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            padding: 8px 0;
            margin-bottom: 8px;
        }
        
        .assign-dropdown.show .assign-dropdown-content {
            display: block;
        }
        
        .assign-option {
            padding: 10px 16px;
            color: #e6edf3;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
        }
        
        .assign-option:last-child {
            border-bottom: none;
        }
        
        .assign-option:hover {
            background: rgba(240, 246, 252, 0.1);
        }
        
        .assign-option.current {
            background: rgba(255, 165, 0, 0.1);
            color: #ffa500;
            font-weight: 500;
        }
        
        .assign-option.new-customer {
            background: rgba(46, 160, 67, 0.1);
            color: #3fb950;
            border-top: 1px solid rgba(240, 246, 252, 0.1);
            font-weight: 500;
        }
        
        .assign-option.new-customer:hover {
            background: rgba(46, 160, 67, 0.2);
        }

        .customer-header {
            padding: 20px 30px;
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.1), rgba(120, 200, 255, 0.05));
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .customer-header:hover {
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.15), rgba(120, 200, 255, 0.08));
        }
        
        .customer-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #e6edf3;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .customer-badge {
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .customer-stats {
            color: #7d8590;
            font-size: 0.9rem;
        }
        
        .expand-icon {
            color: #58a6ff;
            transition: transform 0.3s ease;
        }
        
        .customer-group.collapsed .expand-icon {
            transform: rotate(-90deg);
        }
        
        .customer-content {
            padding: 30px;
            display: none;
        }
        
        .customer-group:not(.collapsed) .customer-content {
            display: block;
        }
        
        /* Feedback Management Styles */
        .feedback-table {
            background: rgba(22, 27, 34, 0.9);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(240, 246, 252, 0.15);
        }
        
        .feedback-header {
            display: grid;
            grid-template-columns: 120px 150px 1fr 100px 200px 1fr;
            gap: 15px;
            background: rgba(13, 17, 23, 0.8);
            padding: 10px;
            font-weight: 600;
            color: #e6edf3;
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
        }
        
        .feedback-row {
            display: grid;
            grid-template-columns: 120px 150px 1fr 100px 200px 1fr;
            gap: 15px;
            padding: 10px;
            border-bottom: 1px solid rgba(240, 246, 252, 0.05);
            transition: background-color 0.2s ease;
        }
        
        .feedback-row:hover {
            background: rgba(240, 246, 252, 0.03);
        }
        
        .feedback-row.positive {
            border-left: 3px solid rgba(46, 160, 67, 0.6);
        }
        
        .feedback-row.negative {
            border-left: 3px solid rgba(248, 81, 73, 0.6);
        }
        
        .feedback-col {
            color: #e6edf3;
            display: flex;
            align-items: center;
        }
        
        .feedback-date {
            font-size: 0.85rem;
        }
        
        .feedback-time {
            display: block;
            font-size: 0.75rem;
            color: #7d8590;
            margin-top: 2px;
        }
        
        .feedback-customer {
            font-weight: 500;
            color: #58a6ff;
        }
        
        .feedback-model {
            font-size: 0.9rem;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .feedback-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .feedback-type-badge.positive {
            background: rgba(46, 160, 67, 0.15);
            color: #2ea043;
            border: 1px solid rgba(46, 160, 67, 0.3);
        }
        
        .feedback-type-badge.negative {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
        }
        
        .feedback-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .category-tag {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            border: 1px solid rgba(88, 166, 255, 0.2);
        }
        
        .feedback-comment {
            font-size: 0.85rem;
            line-height: 1.4;
            color: #c9d1d9;
            max-height: 60px;
            overflow-y: auto;
        }
        
        .feedback-comment em {
            color: #7d8590;
        }
        
        /* User Management Styles */
        .user-management-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .user-management-list.expanded {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .user-item {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(240, 246, 252, 0.05);
            transition: background 0.2s ease;
        }
        
        .user-item:hover {
            background: rgba(240, 246, 252, 0.03);
        }
        
        .user-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .user-name {
            color: #e6edf3;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .user-role {
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .user-details {
            font-size: 0.8rem;
            color: #7d8590;
            margin-bottom: 8px;
        }
        
        .user-actions {
            display: flex;
            gap: 8px;
        }
        
        .user-item-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            color: #e6edf3;
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        
        .user-role-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-role {
            color: #7d8590;
            font-size: 0.75rem;
            text-transform: capitalize;
        }
        
        .user-settings-btn {
            padding: 2px 4px;
            font-size: 0.7rem;
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 4px;
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .user-settings-btn:hover {
            background: rgba(88, 166, 255, 0.25);
            border-color: rgba(88, 166, 255, 0.5);
            transform: scale(1.1);
        }
        
        .user-views {
            color: #7d8590;
            font-size: 0.75rem;
            margin-top: 4px;
        }
        
        .edit-section {
            padding: 20px;
            margin-bottom: 10px;
            background: rgba(22, 27, 34, 0.6);
            border: 1px solid rgba(240, 246, 252, 0.1);
            border-radius: 12px;
        }
        
        .section-title {
            color: #e6edf3;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .user-edit-sections {
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Logout Section */
        .sidebar-logout {
            margin-top: auto;
            padding: 20px;
            border-top: 1px solid rgba(240, 246, 252, 0.1);
            background: linear-gradient(135deg, rgba(22, 27, 34, 0.5) 0%, rgba(30, 35, 42, 0.3) 100%);
            flex-shrink: 0; /* Prevent logout from shrinking */
        }
        
        .logout-user-info {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
        }
        
        .logout-username {
            color: #e6edf3;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .logout-role {
            color: #7d8590;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .logout-button {
            width: 100%;
            padding: 10px;
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.3);
            color: #f85149;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .logout-button:hover {
            background: rgba(248, 81, 73, 0.2);
            border-color: rgba(248, 81, 73, 0.5);
            transform: translateY(-1px);
        }
        
        /* Modern File Upload Styles */
        .modern-file-upload {
            position: relative;
            border: 2px dashed rgba(88, 166, 255, 0.3);
            border-radius: 12px;
            padding: 30px 20px;
            background: rgba(13, 17, 23, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .modern-file-upload:hover {
            border-color: rgba(88, 166, 255, 0.6);
            background: rgba(88, 166, 255, 0.05);
            transform: translateY(-1px);
        }
        
        .modern-file-upload.drag-over {
            border-color: #58a6ff;
            background: rgba(88, 166, 255, 0.1);
            transform: scale(1.02);
        }
        
        .upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            position: relative;
            z-index: 2;
        }
        
        .upload-icon-modern {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(88, 166, 255, 0.2), rgba(121, 192, 255, 0.1));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #58a6ff;
            transition: all 0.3s ease;
        }
        
        .modern-file-upload:hover .upload-icon-modern {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(88, 166, 255, 0.3);
        }
        
        .upload-text-modern {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .upload-primary {
            color: #e6edf3;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .upload-secondary {
            color: #7d8590;
            font-size: 0.85rem;
        }
        
        .upload-border {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(88, 166, 255, 0.1), transparent);
            transition: left 0.6s ease;
        }
        
        .modern-file-upload:hover .upload-border {
            left: 100%;
        }
        
        .file-name-modern {
            margin-top: 15px;
            padding: 12px 16px;
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 8px;
            color: #58a6ff;
            font-size: 0.9rem;
            text-align: center;
            font-weight: 500;
        }
        
        /* Variant Display Styles */
        .model-variants {
            margin: 15px 0;
            padding: 12px;
            background: rgba(88, 166, 255, 0.05);
            border: 1px solid rgba(88, 166, 255, 0.2);
            border-radius: 8px;
        }
        
        .variants-label {
            color: #e6edf3;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .variants-circles {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 15px 0;
            padding: 0;
        }
        
        .variant-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            position: relative;
        }
        
        .variant-circle:hover {
            transform: scale(1.2);
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .variant-circle.primary {
            border-color: #ffd700;
            border-width: 3px;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .variant-circle.primary:hover {
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.7);
        }
        
        .variant-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 8px;
        }
        
        .variant-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .variant-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .variant-name {
            font-size: 0.75rem;
            color: #c9d1d9;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .variant-url {
            font-size: 0.7rem;
        }
        
        .variant-url a {
            color: #58a6ff;
            text-decoration: none;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        
        .variant-url a:hover {
            opacity: 1;
        }
        
        .variant-url-button {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid rgba(88, 166, 255, 0.3);
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .variant-url-button:hover {
            background: rgba(88, 166, 255, 0.2);
            transform: scale(1.1);
        }
        
        .variant-delete {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .variant-wrapper:hover .variant-delete {
            display: flex;
        }
        
        .variant-delete:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }
        
        /* Variant Type Selection */
        .variant-type-options {
            display: flex;
            gap: 15px;
            margin: 15px 0;
        }
        
        .variant-type-option {
            flex: 1;
            padding: 10px;
            border: 2px solid rgba(88, 166, 255, 0.2);
            border-radius: 10px;
            background: rgba(13, 17, 23, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .variant-type-option:hover {
            border-color: rgba(88, 166, 255, 0.5);
            background: rgba(88, 166, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .variant-type-option.active {
            border-color: #58a6ff;
            background: rgba(88, 166, 255, 0.15);
            box-shadow: 0 4px 15px rgba(88, 166, 255, 0.3);
        }
        
        .type-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .type-label {
            color: #e6edf3;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }
        
        .type-desc {
            color: #7d8590;
            font-size: 0.8rem;
        }
        
        .variant-type-option.active .type-label {
            color: #58a6ff;
        }
        
        /* Page System Styles */
        .page {
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }
        
        /* Content wrapper for pages */
        .dashboard-content {
            padding: 30px;
        }
        
        .sidebar-nav-title {
            padding: 15px 20px 10px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #7d8590;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sidebar-nav-links {
            padding: 0 10px;
        }
        
        .sidebar-nav-link {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 4px;
            border: none;
            background: transparent;
            color: #e6edf3;
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .sidebar-nav-link:hover {
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
        }
        
        .sidebar-nav-link.active {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
            font-weight: 600;
        }
        
        /* Requests Admin Styles */
        
        .nav-icon {
            margin-right: 12px;
            font-size: 1.1em;
        }
        
        .nav-label {
            flex: 1;
        }
        
        
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
        }
        
        /* Filters Section */
        .filters-section {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(13, 17, 23, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(240, 246, 252, 0.1);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .filter-label {
            color: #7d8590;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .filter-select,
        .filter-input {
            padding: 8px 12px;
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 6px;
            background: rgba(13, 17, 23, 0.8);
            color: #e6edf3;
            font-size: 0.9rem;
            min-width: 140px;
        }
        
        .filter-select:focus,
        .filter-input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }
        
        .filter-input {
            min-width: 200px;
        }
        
        /* Images Grid */
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .image-card {
            background: rgba(13, 17, 23, 0.6);
            border: 1px solid rgba(240, 246, 252, 0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .image-card:hover {
            border-color: rgba(88, 166, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .image-preview {
            width: 100%;
            height: 160px;
            background: rgba(240, 246, 252, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .image-info {
            padding: 10px;
        }
        
        .image-title {
            color: #e6edf3;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 6px;
        }
        
        .image-meta {
            color: #7d8590;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }
        
        .image-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
        }
        
        .image-type-badge {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .image-delete-btn {
            background: none;
            border: none;
            color: #f85149;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 1rem;
        }
        
        .image-delete-btn:hover {
            background: rgba(248, 81, 73, 0.1);
        }
        
        /* Users Section */
        .users-section {
            background: rgba(13, 17, 23, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(240, 246, 252, 0.1);
            overflow: hidden;
        }
        
        .user-card {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(240, 246, 252, 0.1);
            transition: all 0.2s ease;
        }
        
        .user-card:last-child {
            border-bottom: none;
        }
        
        .user-card:hover {
            background: rgba(88, 166, 255, 0.05);
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(88, 166, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 15px;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            color: #e6edf3;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .user-role {
            color: #7d8590;
            font-size: 0.85rem;
        }
        
        .user-actions {
            display: flex;
            gap: 8px;
        }
        
        .user-action-btn {
            padding: 6px 12px;
            border: 1px solid rgba(240, 246, 252, 0.2);
            border-radius: 6px;
            background: transparent;
            color: #e6edf3;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }
        
        .user-action-btn:hover {
            border-color: #58a6ff;
            color: #58a6ff;
        }
        
        .user-action-btn.danger:hover {
            border-color: #f85149;
            color: #f85149;
        }
        
        .user-customer {
            color: #7d8590;
            font-size: 0.85em;
            margin-left: 8px;
        }
        
        .user-meta {
            display: flex;
            gap: 15px;
            margin-top: 5px;
            font-size: 0.8em;
        }
        
        .user-status {
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .status-active {
            background: rgba(46, 160, 67, 0.15);
            color: #2ea043;
        }
        
        .status-inactive {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
        }
        
        .user-created {
            color: #7d8590;
        }
        
        /* Customer Logo Management Styles */
        .customer-logo-section {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid rgba(240, 246, 252, 0.1);
            border-radius: 8px;
            background: rgba(13, 17, 23, 0.3);
        }
        
        .subsection-title {
            color: #7d8590;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .logo-management {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .current-logo {
            width: 80px;
            height: 80px;
            border: 2px dashed rgba(240, 246, 252, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: rgba(240, 246, 252, 0.02);
        }
        
        .current-logo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .logo-placeholder {
            color: #7d8590;
            font-size: 0.8rem;
            text-align: center;
            padding: 10px;
        }
        
        .logo-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }
        
        .logo-actions .action-button {
            padding: 8px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }
        
        /* Mobile Responsiveness for Settings Modal */
        @media (max-width: 768px) {
            .settings-modal {
                padding: 10px;
            }
            
            .settings-modal-content {
                max-width: 100%;
                margin: 0;
            }
            
            .settings-modal-header {
                padding: 16px 20px 12px;
            }
            
            .settings-modal-title {
                font-size: 1.1rem;
            }
            
            .settings-modal-body {
                padding: 16px 20px;
                max-height: 70vh;
            }
            
            .settings-section-title {
                font-size: 0.85rem;
            }
            
            .settings-action {
                padding: 10px 14px;
            }
            
            .settings-action-label {
                font-size: 0.9rem;
            }
            
            .settings-action-desc {
                font-size: 0.8rem;
            }
            
            .settings-action-button {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
            
            .card-actions-consolidated {
                gap: 6px;
            }
            
            .action-button {
                font-size: 0.7rem;
                padding: 5px 8px;
            }
        }
    </style>
</head>
<body style="display: none;">
    
    <!-- Admin Layout -->
    <div class="admin-layout">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Admin Panel</div>
                <div class="sidebar-subtitle">Furniture Management</div>
            </div>
            
            <div class="sidebar-search">
                <input type="text" class="search-input" placeholder="Search furniture or customers..." 
                       oninput="handleSearch(this.value)" />
            </div>
            
            <!-- Upload Buttons -->
            <div style="padding: 20px; border-bottom: 1px solid rgba(240, 246, 252, 0.1);">
                <button onclick="toggleUploadModal()" class="modal-button primary" style="width: 100%; padding: 12px; font-size: 0.9rem; background: rgba(88, 166, 255, 0.15); border: 1px solid rgba(88, 166, 255, 0.3); color: #58a6ff; border-radius: 12px; transition: all 0.2s ease; margin-bottom: 10px;">
                     Upload Furniture
                </button>
                <button onclick="toggleWallpaperUploadModal()" class="modal-button primary" style="width: 100%; padding: 12px; font-size: 0.9rem; background: rgba(163, 113, 247, 0.15); border: 1px solid rgba(163, 113, 247, 0.3); color: #a371f7; border-radius: 12px; transition: all 0.2s ease;">
                     Upload Wallpaper
                </button>
            </div>
            
            <!-- Navigation Links -->
            <div class="sidebar-section">
                <div class="sidebar-nav-title"> Pages</div>
                <div class="sidebar-nav-links">
                    <button class="sidebar-nav-link active" data-page="dashboard" onclick="navigateToPage('dashboard')">
                        <span class="nav-icon"></span>
                        <span class="nav-label">Dashboard</span>
                    </button>
                    <button class="sidebar-nav-link" data-page="images" onclick="navigateToPage('images')">
                        <span class="nav-icon"></span>
                        <span class="nav-label">Images</span>
                    </button>
                    <button class="sidebar-nav-link" data-page="users" onclick="navigateToPage('users')">
                        <span class="nav-icon"></span>
                        <span class="nav-label">Users</span>
                    </button>
                    <button class="sidebar-nav-link" data-page="feedback" onclick="navigateToPage('feedback')">
                        <span class="nav-icon"></span>
                        <span class="nav-label">Feedback</span>
                    </button>
                    <button class="sidebar-nav-link" data-page="requests" onclick="navigateToPage('requests')">
                        <span class="nav-icon"></span>
                        <span class="nav-label">Requests</span>
                    </button>
                </div>
            </div>
            
            <!-- Customers Section -->
            <div class="sidebar-customers" style="margin-top: 5px;">
                <div class="sidebar-customers-header">
                    <span class="sidebar-customers-title">Customers</span>
                    <button class="add-customer-btn" onclick="openUserModalForCustomer()">+ Add</button>
                </div>
                
                <!-- Add Customer Form -->
                <div class="add-customer-form" id="addCustomerForm">
                    <input type="text" class="add-customer-input" placeholder="Customer name" id="addCustomerNameInput" onkeydown="handleCustomerNameKeydown(event)" />
                    <div class="add-customer-actions">
                        <button class="add-customer-save" onclick="saveNewCustomer()">Save</button>
                        <button class="add-customer-cancel" onclick="hideAddCustomerForm()">Cancel</button>
                    </div>
                </div>
                
                <ul class="customer-list" id="customerList">
                    <!-- Customer items will be populated here -->
                </ul>
            </div>
            
            <!-- Logout Section -->
            <div class="sidebar-logout">
                <div class="logout-user-info">
                    <span class="logout-username" id="loggedInUsername">admin</span>
                    <span class="logout-role">Administrator</span>
                </div>
                <button class="logout-button" onclick="logout()">Sign Out</button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Dashboard Page -->
            <div class="page" id="dashboardPage" style="display: block;">
                <div class="header">
                    <div class="header-content">
                        <h1> Dashboard</h1>
                    </div>
                </div>
                
                <div class="dashboard-content">
                    <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-label">Total Furniture</div>
                        <div class="stat-value" id="totalModels">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-label">Total Views</div>
                        <div class="stat-value" id="totalViews">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-label">Storage Used</div>
                        <div class="stat-value" id="totalSize">-</div>
                    </div>
                    </div>
                    
                    <div class="models-section">
                        <div class="section-header">
                            <h2 class="section-title">Uploaded Furniture</h2>
                            <div class="section-actions">
                                <button class="action-button secondary" onclick="toggleExportModal()" title="Export Customer Integration Kit">
                                     Export Kit
                                </button>
                                <button class="refresh-button" onclick="loadModels()">Refresh</button>
                            </div>
                        </div>
                        
                        <div id="modelsContainer">
                            <div class="loading">Loading furniture...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Images Page -->
            <div class="page" id="imagesPage" style="display: none;">
                <div class="header">
                    <div class="header-content">
                        <h1> Images Library</h1>
                    </div>
                    <div class="header-actions">
                        <button onclick="showImageUploadModal()" class="action-button primary">
                             Upload Image
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-content">
                    <div class="filters-section">
                        <div class="filter-group">
                            <label class="filter-label">Filter by Type:</label>
                            <select id="imageTypeFilter" class="filter-select" onchange="filterImages()">
                                <option value="all">All Types</option>
                                <option value="logo">Company Logo</option>
                                <option value="customer_logo">Customer Logo</option>
                                <option value="brand">Brand Asset</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Filter by Customer:</label>
                            <select id="imageCustomerFilter" class="filter-select" onchange="filterImages()">
                                <option value="all">All Customers</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <input type="text" id="imageSearchFilter" class="filter-input" placeholder="Search images..." oninput="filterImages()">
                        </div>
                    </div>
                    
                    <div class="images-grid" id="imagesGrid">
                        <div class="loading">Loading images...</div>
                    </div>
                </div>
            </div>
            
            <!-- Users Page -->
            <div class="page" id="usersPage" style="display: none;">
                <div class="header">
                    <div class="header-content">
                        <h1> User Management</h1>
                    </div>
                    <div class="header-actions">
                        <button onclick="toggleUserModal()" class="action-button primary">
                             Add User
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-content">
                    <div class="users-section">
                        <div id="usersContainer">
                            <div class="loading">Loading users...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Feedback Page -->
            <div class="page" id="feedbackPage" style="display: none;">
                <div class="header">
                    <div class="header-content">
                        <h1> Customer Feedback</h1>
                    </div>
                    <div class="header-actions">
                        <button onclick="loadFeedback()" class="action-button primary">
                             Refresh
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-content">
                    <!-- Filter Section -->
                    <div class="stats-grid" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-label">Total Feedback</div>
                            <div class="stat-value" id="totalFeedback">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-label">Positive</div>
                            <div class="stat-value" id="positiveFeedback">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-label">Negative</div>
                            <div class="stat-value" id="negativeFeedback">-</div>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="section" style="margin-bottom: 30px;">
                        <div class="section-header">
                            <h2 class="section-title">Filter Feedback</h2>
                        </div>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
                            <select id="customerFilter" onchange="loadFeedback()" class="futuristic-input" style="width: auto; min-width: 200px;">
                                <option value="">All Customers</option>
                            </select>
                            <select id="typeFilter" onchange="loadFeedback()" class="futuristic-input" style="width: auto; min-width: 150px;">
                                <option value="">All Types</option>
                                <option value="positive"> Positive</option>
                                <option value="negative"> Negative</option>
                            </select>
                            <select id="modelFilter" onchange="loadFeedback()" class="futuristic-input" style="width: auto; min-width: 200px;">
                                <option value="">All Products</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Feedback Table -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Feedback Details</h2>
                        </div>
                        <div id="feedbackContainer">
                            <div class="loading">Loading feedback...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Requests Page -->
            <div class="page" id="requestsPage" style="display: none;">
                <div class="header">
                    <div class="header-content">
                        <h1> Customer Requests</h1>
                    </div>
                    <div class="header-actions">
                        <button onclick="loadRequests()" class="action-button primary">
                             Refresh
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-label">Total Requests</div>
                            <div class="stat-value" id="totalRequestsAdmin">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-label">Pending</div>
                            <div class="stat-value" id="pendingRequestsAdmin">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-label">In Progress</div>
                            <div class="stat-value" id="inProgressRequestsAdmin">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"></div>
                            <div class="stat-label">Completed</div>
                            <div class="stat-value" id="completedRequestsAdmin">0</div>
                        </div>
                    </div>
                    
                    <div class="filters-section">
                        <div class="filter-group">
                            <label class="filter-label">Filter by Status:</label>
                            <select id="statusFilterAdmin" onchange="loadRequests()" class="filter-select">
                                <option value="">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Filter by Customer:</label>
                            <select id="customerFilterAdmin" onchange="loadRequests()" class="filter-select">
                                <option value="">All Customers</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="requestsContainer">
                        <div class="loading">Loading requests...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <div class="password-modal" id="uploadModal">
        <div class="modal-content futuristic-upload">
            <div class="upload-header">
                <div class="upload-icon-container">
                    <div class="upload-icon-bg">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2L15.09 8.26L22 9L17 14.74L18.18 21.02L12 18L5.82 21.02L7 14.74L2 9L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
                <h3 class="upload-title">Upload New Furniture</h3>
                <p class="upload-subtitle">Transform your 3D furniture into AR experiences</p>
            </div>
            
            <form id="uploadForm">
                <div class="futuristic-drop-zone" id="dropZone">
                    <input type="file" id="fileInput" accept=".glb,.gltf" style="display: none;">
                    <div class="drop-zone-content">
                        <div class="drop-animation">
                            <div class="drop-ring"></div>
                            <div class="drop-ring"></div>
                            <div class="drop-ring"></div>
                        </div>
                        <div class="upload-text">
                            <span class="primary-text">Drag & drop your 3D furniture</span>
                            <span class="secondary-text">or <span class="click-text">click to browse</span></span>
                        </div>
                        <div class="format-info">
                            <span class="format-badge">GLB</span>
                            <span class="format-badge">GLTF</span>
                            <span class="size-limit">Max 100MB</span>
                        </div>
                    </div>
                    <div class="drag-overlay">
                        <div class="drag-content">
                            <div class="drag-icon"></div>
                            <span>Drop to upload</span>
                        </div>
                    </div>
                </div>
                
                <div class="file-preview-container" id="filePreviewContainer" style="display: none;">
                    <div class="file-preview-card">
                        <div class="file-icon"></div>
                        <div class="file-info">
                            <div class="file-name" id="previewFileName"></div>
                            <div class="file-size" id="previewFileSize"></div>
                        </div>
                        <button type="button" class="remove-file-btn" onclick="removeFile()"></button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="input-group">
                        <select id="customerSelect" class="futuristic-input customer-select">
                            <option value="napo:NAPO">NAPO</option>
                            <option value="unassigned:Unassigned">Unassigned</option>
                        </select>
                        <div class="input-line"></div>
                    </div>
                    
                    <div class="input-group">
                        <input type="text" id="titleInput" placeholder="Furniture Title" class="futuristic-input">
                        <div class="input-line"></div>
                    </div>
                </div>
                
                <div class="input-group">
                    <textarea id="descriptionInput" placeholder="Description (optional)" rows="2" class="futuristic-input textarea"></textarea>
                    <div class="input-line"></div>
                </div>
                
                <div class="input-group">
                    <input type="url" id="productUrlInput" placeholder="Product URL (where users return after AR)" class="futuristic-input">
                    <div class="input-line"></div>
                    <small class="field-hint">Example: https://yourstore.com/products/sofa-123</small>
                </div>
                
                
                <div class="modal-buttons">
                    <button type="button" class="modal-button secondary" onclick="closeUploadModal()">Cancel</button>
                    <button type="submit" class="modal-button primary futuristic-primary" id="uploadButton">
                        <span class="button-text">Upload Furniture</span>
                        <div class="button-glow"></div>
                    </button>
                </div>
            </form>
            
            <div id="uploadProgress" class="upload-progress" style="display: none;">
                <div class="progress-label" id="uploadStatus">Uploading...</div>
                <div class="progress-container">
                    <div class="progress-track">
                        <div id="progressBar" class="progress-fill"></div>
                        <div class="progress-glow"></div>
                    </div>
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallpaper Upload Modal -->
    <div class="password-modal" id="wallpaperUploadModal" style="display: none;">
        <div class="modal-content futuristic-upload" style="max-height: 85vh; overflow-y: auto; max-width: 600px;">
            <div class="upload-header" style="padding: 15px 20px 10px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="width: 32px; height: 32px; background: rgba(163, 113, 247, 0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        
                    </div>
                    <h3 style="margin: 0; font-size: 18px; color: #e6edf3;">Upload Wallpaper</h3>
                </div>
                <p style="margin: 0; color: #7d8590; font-size: 13px;">Create AR wallpaper from texture maps</p>
            </div>
            
            <form id="wallpaperUploadForm" style="padding: 0 20px 15px;">
                <!-- Basic Info Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                    <div style="margin-bottom: 0;">
                        <label style="display: block; color: #58a6ff; font-size: 13px; margin-bottom: 6px;">Customer</label>
                        <select class="futuristic-input" id="wallpaperCustomerSelect" required style="padding: 8px 12px; font-size: 14px; width: 100%;">
                            <option value="">Select Customer</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 0;">
                        <label style="display: block; color: #58a6ff; font-size: 13px; margin-bottom: 6px;">Title</label>
                        <input type="text" class="futuristic-input" id="wallpaperTitle" placeholder="e.g., Vintage Brick" required style="padding: 8px 12px; font-size: 14px; width: 100%;">
                    </div>
                </div>

                <!-- Texture Upload Section -->
                <div style="margin-bottom: 15px;">
                    <h4 style="color: #a371f7; margin-bottom: 8px; font-size: 15px;"> Textures</h4>
                    <p style="color: #7d8590; font-size: 12px; margin-bottom: 12px;">Albedo required, others optional</p>
                    
                    <!-- Texture Grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <!-- Albedo Texture -->
                        <div>
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                <span style="font-size: 12px;"></span>
                                <label style="font-size: 12px; font-weight: 500; color: #a371f7;">Albedo*</label>
                            </div>
                            <input type="file" id="wallpaperAlbedoInput" accept="image/*" onchange="handleWallpaperTextureUpload('albedo', this)" style="display: none;">
                            <div onclick="document.getElementById('wallpaperAlbedoInput').click()" style="border: 2px dashed rgba(163, 113, 247, 0.3); border-radius: 6px; padding: 12px; text-align: center; cursor: pointer; background: rgba(163, 113, 247, 0.05); min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                                <div id="albedoPreview"></div>
                                <div id="albedoPlaceholder">
                                    <div style="font-size: 16px; margin-bottom: 3px;"></div>
                                    <div style="font-size: 11px; color: #7d8590;">Base Color</div>
                                </div>
                            </div>
                        </div>

                        <!-- Normal Texture -->
                        <div>
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                <span style="font-size: 12px;"></span>
                                <label style="font-size: 12px; font-weight: 500; color: #58a6ff;">Normal</label>
                            </div>
                            <input type="file" id="wallpaperNormalInput" accept="image/*" onchange="handleWallpaperTextureUpload('normal', this)" style="display: none;">
                            <div onclick="document.getElementById('wallpaperNormalInput').click()" style="border: 2px dashed rgba(88, 166, 255, 0.3); border-radius: 6px; padding: 12px; text-align: center; cursor: pointer; background: rgba(88, 166, 255, 0.05); min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                                <div id="normalPreview"></div>
                                <div id="normalPlaceholder">
                                    <div style="font-size: 16px; margin-bottom: 3px;"></div>
                                    <div style="font-size: 11px; color: #7d8590;">Bumps</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Roughness Texture -->
                        <div>
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                <span style="font-size: 12px;"></span>
                                <label style="font-size: 12px; font-weight: 500; color: #ffa500;">Roughness</label>
                            </div>
                            <input type="file" id="wallpaperRoughnessInput" accept="image/*" onchange="handleWallpaperTextureUpload('roughness', this)" style="display: none;">
                            <div onclick="document.getElementById('wallpaperRoughnessInput').click()" style="border: 2px dashed rgba(255, 165, 0, 0.3); border-radius: 6px; padding: 12px; text-align: center; cursor: pointer; background: rgba(255, 165, 0, 0.05); min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                                <div id="roughnessPreview"></div>
                                <div id="roughnessPlaceholder">
                                    <div style="font-size: 16px; margin-bottom: 3px;"></div>
                                    <div style="font-size: 11px; color: #7d8590;">Shine</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Height Texture -->
                        <div>
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                                <span style="font-size: 12px;"></span>
                                <label style="font-size: 12px; font-weight: 500; color: #10b981;">Height</label>
                            </div>
                            <input type="file" id="wallpaperHeightInput" accept="image/*" onchange="handleWallpaperTextureUpload('height', this)" style="display: none;">
                            <div onclick="document.getElementById('wallpaperHeightInput').click()" style="border: 2px dashed rgba(16, 185, 129, 0.3); border-radius: 6px; padding: 12px; text-align: center; cursor: pointer; background: rgba(16, 185, 129, 0.05); min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                                <div id="heightPreview"></div>
                                <div id="heightPlaceholder">
                                    <div style="font-size: 16px; margin-bottom: 3px;"></div>
                                    <div style="font-size: 11px; color: #7d8590;">Depth</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wall Dimensions -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; color: #58a6ff; font-size: 12px; margin-bottom: 4px;">Width (m)</label>
                        <input type="number" class="futuristic-input" id="wallWidth" value="2.4" min="0.5" max="10" step="0.1" style="padding: 6px 8px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; color: #58a6ff; font-size: 12px; margin-bottom: 4px;">Height (m)</label>
                        <input type="number" class="futuristic-input" id="wallHeight" value="2.4" min="0.5" max="5" step="0.1" style="padding: 6px 8px; font-size: 13px;">
                    </div>
                    <div>
                        <label style="display: block; color: #58a6ff; font-size: 12px; margin-bottom: 4px;">Tile Repeat</label>
                        <input type="number" class="futuristic-input" id="tileRepeat" value="4" min="1" max="10" step="1" style="padding: 6px 8px; font-size: 13px;">
                    </div>
                </div>

                <!-- Progress Bar -->
                <div id="wallpaperUploadProgress" style="display: none; margin-bottom: 15px;">
                    <div style="background: rgba(240, 246, 252, 0.1); border-radius: 6px; overflow: hidden; height: 6px; margin-bottom: 8px;">
                        <div id="wallpaperProgressBar" style="background: linear-gradient(90deg, #a371f7, #667eea); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div style="text-align: center; font-size: 12px; color: #7d8590;">
                        <span id="wallpaperProgressPercentage">0%</span> - Generating wallpaper...
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; padding: 0 20px 20px; margin-top: 10px;">
                    <button type="button" onclick="closeWallpaperUploadModal()" style="flex: 1; padding: 10px; background: rgba(240, 246, 252, 0.1); color: #7d8590; border: 1px solid rgba(240, 246, 252, 0.2); border-radius: 8px; cursor: pointer; font-size: 14px;">Cancel</button>
                    <button type="button" onclick="uploadWallpaper()" id="wallpaperUploadButton" disabled style="flex: 2; padding: 10px; background: rgba(163, 113, 247, 0.2); color: #a371f7; border: 1px solid rgba(163, 113, 247, 0.3); border-radius: 8px; cursor: pointer; font-size: 14px; opacity: 0.6;"> Upload Albedo first</button>
                </div>
            </form>
            
            <div id="wallpaperUploadProgress" class="upload-progress" style="display: none;">
                <div class="progress-label" id="wallpaperUploadStatus">Processing textures...</div>
                <div class="progress-container">
                    <div class="progress-track">
                        <div id="wallpaperProgressBar" class="progress-fill"></div>
                        <div class="progress-glow"></div>
                    </div>
                    <div class="progress-percentage" id="wallpaperProgressPercentage">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div class="password-modal" id="userEditModal" style="display: none;">
        <div class="modal-content futuristic-upload">
            <div class="upload-header">
                <div class="upload-icon-container">
                    <div class="upload-icon-bg">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
                <h3 class="upload-title" id="editModalTitle"> Manage User</h3>
                <p class="upload-subtitle" id="editModalSubtitle">Edit user settings and permissions</p>
            </div>
            
            <div class="user-edit-sections">
                <!-- Password Reset Section -->
                <div class="edit-section">
                    <h4 class="section-title"> Password Management</h4>
                    
                    <!-- Current Password Display -->
                    <div class="input-group">
                        <label class="input-label">Current Password:</label>
                        <div class="input-group password-input-group">
                            <input type="password" id="currentPasswordDisplay" value="" class="futuristic-input" readonly>
                            <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('currentPasswordDisplay')" title="Show/Hide Password">
                                <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path class="eye-open" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle class="eye-open" cx="12" cy="12" r="3"/>
                                    <path class="eye-closed" d="m9.88 9.88a3 3 0 1 0 4.24 4.24" style="display: none;"/>
                                    <path class="eye-closed" d="m2 2 20 20" style="display: none;"/>
                                    <path class="eye-closed" d="M6.71 6.71C4.5 8.82 2 12 2 12s4 8 11 8c1.78 0 3.3-.46 4.65-1.15" style="display: none;"/>
                                    <path class="eye-closed" d="M17.29 17.29C19.5 15.18 22 12 22 12s-4-8-11-8c-1.78 0-3.3.46-4.65 1.15" style="display: none;"/>
                                </svg>
                            </button>
                            <div class="input-line"></div>
                        </div>
                        <div class="password-note">
                            <small style="color: #7d8590; font-style: italic;">
                                 Passwords are securely hashed - original password cannot be displayed
                            </small>
                        </div>
                    </div>
                    
                    <!-- New Password Field -->
                    <div class="input-group">
                        <label class="input-label">New Password (optional):</label>
                        <div class="input-group password-input-group">
                            <input type="password" id="editNewPassword" placeholder="Enter new password to change" class="futuristic-input">
                            <button type="button" class="password-toggle-btn" onclick="togglePasswordVisibility('editNewPassword')" title="Show/Hide Password">
                                <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path class="eye-open" d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle class="eye-open" cx="12" cy="12" r="3"/>
                                    <path class="eye-closed" d="m9.88 9.88a3 3 0 1 0 4.24 4.24" style="display: none;"/>
                                    <path class="eye-closed" d="m2 2 20 20" style="display: none;"/>
                                    <path class="eye-closed" d="M6.71 6.71C4.5 8.82 2 12 2 12s4 8 11 8c1.78 0 3.3-.46 4.65-1.15" style="display: none;"/>
                                    <path class="eye-closed" d="M17.29 17.29C19.5 15.18 22 12 22 12s-4-8-11-8c-1.78 0-3.3.46-4.65 1.15" style="display: none;"/>
                                </svg>
                            </button>
                            <div class="input-line"></div>
                        </div>
                    </div>
                    <button type="button" class="modal-button secondary" onclick="resetUserPassword()" style="width: 100%; margin-top: 10px;">
                        Generate Random Password
                    </button>
                </div>
                
                <!-- Customer Info Section (only for customer role) -->
                <div class="edit-section" id="customerInfoSection" style="display: none;">
                    <h4 class="section-title"> Customer Information</h4>
                    <div class="input-group">
                        <input type="text" id="editCustomerId" placeholder="Customer ID (e.g., napo)" class="futuristic-input">
                        <div class="input-line"></div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="editCustomerName" placeholder="Customer Display Name" class="futuristic-input">
                        <div class="input-line"></div>
                    </div>
                    
                    <!-- Customer Logo Section -->
                    <div class="customer-logo-section">
                        <h5 class="subsection-title"> Customer Logo</h5>
                        <div class="logo-management">
                            <div class="current-logo" id="currentCustomerLogo">
                                <div class="logo-placeholder">No logo uploaded</div>
                            </div>
                            <div class="logo-actions">
                                <button type="button" class="action-button secondary" onclick="showCustomerLogoUpload()">
                                     Upload Logo
                                </button>
                                <button type="button" class="action-button danger" id="removeLogoBtn" onclick="removeCustomerLogo()" style="display: none;">
                                     Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Account Status Section -->
                <div class="edit-section">
                    <h4 class="section-title"> Account Status</h4>
                    <button type="button" id="toggleStatusBtn" class="modal-button danger" onclick="toggleUserStatus()" style="width: 100%;">
                        Deactivate Account
                    </button>
                    <p id="protectedUserNote" style="display: none; color: #7d8590; font-size: 0.8rem; text-align: center; margin-top: 10px;">
                        Admin users are protected and cannot be deactivated.
                    </p>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="modal-button secondary" onclick="closeUserEditModal()">Cancel</button>
                <button type="button" class="modal-button primary futuristic-primary" onclick="saveUserChanges()">
                    <span class="button-text">Save Changes</span>
                    <div class="button-glow"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="password-modal" id="userModal" style="display: none;">
        <div class="modal-content futuristic-upload">
            <div class="upload-header">
                <div class="upload-icon-container">
                    <div class="upload-icon-bg">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M12.5 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8ZM16 11l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
                <h3 class="upload-title">Create New User</h3>
                <p class="upload-subtitle">Add customer or admin accounts</p>
            </div>
            
            <form id="userForm">
                <div class="input-group">
                    <input type="text" id="newUsername" placeholder="Username" class="futuristic-input" required>
                    <div class="input-line"></div>
                </div>
                
                <div class="input-group">
                    <input type="password" id="newPassword" placeholder="Password" class="futuristic-input" required>
                    <div class="input-line"></div>
                </div>
                
                <div class="input-group">
                    <select id="newRole" class="futuristic-input" required>
                        <option value="">Select Role</option>
                        <option value="customer">Customer</option>
                        <option value="admin">Administrator</option>
                    </select>
                    <div class="input-line"></div>
                </div>
                
                <div id="customerFields" style="display: none;">
                    <div class="input-group">
                        <input type="text" id="newCustomerId" placeholder="Customer ID (e.g., napo)" class="futuristic-input">
                        <div class="input-line"></div>
                    </div>
                    
                    <div class="input-group">
                        <input type="text" id="newCustomerName" placeholder="Customer Display Name (e.g., Napo)" class="futuristic-input">
                        <div class="input-line"></div>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="modal-button secondary" onclick="closeUserModal()">Cancel</button>
                    <button type="submit" class="modal-button primary futuristic-primary" id="createUserButton">
                        <span class="button-text">Create User</span>
                        <div class="button-glow"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Variant Modal -->
    <div class="password-modal" id="variantModal" style="display: none;">
        <div class="modal-content futuristic-upload" style="max-width: 500px;">
            <h3 class="upload-title" id="variantModalTitle" style="margin-bottom: 20px;">Add Variant</h3>
            
            <form id="variantForm">
                <!-- Title Input -->
                <div class="input-group" style="margin-bottom: 25px;">
                    <input type="text" id="variantName" placeholder="Variant title" required class="futuristic-input" style="font-size: 1rem;">
                    <div class="input-line"></div>
                </div>
                
                <!-- Product URL Input -->
                <div class="input-group" style="margin-bottom: 25px;">
                    <input type="url" id="variantProductUrl" placeholder="Variant Product URL (optional)" class="futuristic-input">
                    <div class="input-line"></div>
                    <small class="field-hint">URL where users return after viewing this variant in AR</small>
                </div>
                
                <!-- Upload Area -->
                <div class="modern-file-upload" onclick="document.getElementById('variantFile').click()" id="fileUploadArea" style="margin-bottom: 25px;">
                    <div class="upload-content">
                        <div class="upload-icon-modern">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7,10 12,15 17,10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </div>
                        <div class="upload-text-modern">
                            <span class="upload-primary">Drop GLB file or click to browse</span>
                            <span class="upload-secondary">Max 100MB</span>
                        </div>
                    </div>
                    <div class="upload-border"></div>
                </div>
                
                <input type="file" id="variantFile" accept=".glb,.gltf" style="display: none;" onchange="updateVariantFileName()" required>
                <div id="variantFileName" class="file-name-modern" style="display: none;"></div>
                
                <input type="hidden" name="variantType" value="upload">
                
                <div class="modal-buttons">
                    <button type="button" class="modal-button secondary" onclick="closeVariantModal()">Close</button>
                    <div style="font-size: 0.9rem; color: #7d8590; text-align: center; margin-left: 10px;">
                        File will upload automatically when selected
                    </div>
                </div>
            </form>
            
            <div id="variantUploadProgress" class="upload-progress" style="display: none;">
                <div class="progress-label" id="variantUploadStatus">Creating variant...</div>
                <div class="progress-container">
                    <div class="progress-track">
                        <div class="progress-fill" id="variantProgressBar" style="width: 0%;">
                            <div class="progress-glow"></div>
                        </div>
                    </div>
                    <div class="progress-percentage" id="variantProgressPercentage">0%</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Upload Modal -->
    <div class="password-modal" id="imageUploadModal" style="display: none;">
        <div class="modal-content futuristic-upload" style="max-width: 500px;">
            <h3 class="upload-title">Upload Image</h3>
            <p class="upload-subtitle">Upload logos and brand assets</p>
            
            <form id="imageUploadForm">
                <!-- Image Type Selection -->
                <div class="input-group" style="margin-bottom: 20px;">
                    <select id="imageType" class="futuristic-input" style="width: 100%; background: rgba(13, 17, 23, 0.8); color: #f0f6fc;">
                        <option value="logo">Company Logo</option>
                        <option value="customer_logo">Customer Logo</option>
                        <option value="brand">Brand Asset</option>
                        <option value="general">General Image</option>
                    </select>
                    <div class="input-line"></div>
                </div>
                
                <!-- Upload Area -->
                <div class="modern-file-upload" onclick="document.getElementById('imageFile').click()" id="imageFileUploadArea" style="margin-bottom: 25px;">
                    <div class="upload-content">
                        <div class="upload-icon-modern">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                        </div>
                        <div class="upload-text-modern">
                            <span class="upload-primary">Drop image or click to browse</span>
                            <span class="upload-secondary">JPG, PNG, WebP, SVG (Max 10MB)</span>
                        </div>
                    </div>
                    <div class="upload-border"></div>
                </div>
                
                <input type="file" id="imageFile" accept=".jpg,.jpeg,.png,.webp,.svg" style="display: none;" onchange="updateImageFileName()">
                <div id="imageFileName" class="file-name-modern" style="display: none;"></div>
                
                <div class="modal-buttons">
                    <button type="button" class="modal-button secondary" onclick="closeImageUploadModal()">Close</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Furniture Settings Modal -->
    <div class="settings-modal" id="furnitureSettingsModal">
        <div class="settings-modal-content">
            <div class="settings-modal-header">
                <h3 class="settings-modal-title" id="settingsModalTitle">
                     Furniture Settings - Loading...
                </h3>
            </div>
            
            <div class="settings-modal-body">
                <!-- Sharing & Links Section -->
                <div class="settings-section">
                    <div class="settings-section-title"> Sharing & Links</div>
                    
                    <div class="settings-action">
                        <div class="settings-action-info">
                            <div class="settings-action-label">Product URL</div>
                            <div class="settings-action-desc" id="productUrlDesc">Add or edit the product page URL</div>
                        </div>
                        <button class="settings-action-button" id="editUrlButton" onclick="handleEditUrl()">
                            Edit
                        </button>
                    </div>
                    
                    <div class="settings-action">
                        <div class="settings-action-info">
                            <div class="settings-action-label">Copy AR Link</div>
                            <div class="settings-action-desc">Copy the shareable AR viewing link</div>
                        </div>
                        <button class="settings-action-button" id="copyLinkButton" onclick="handleCopyLink()">
                            Copy
                        </button>
                    </div>
                </div>
                
                <!-- Customer Management Section -->
                <div class="settings-section">
                    <div class="settings-section-title"> Customer Management</div>
                    
                    <div class="settings-action">
                        <div class="settings-action-info">
                            <div class="settings-action-label">Assign to Customer</div>
                            <div class="settings-action-desc" id="assignmentDesc">Not assigned to any customer</div>
                        </div>
                        <button class="settings-action-button" id="assignButton" onclick="handleAssignCustomer()">
                            Assign
                        </button>
                    </div>
                </div>
                
                <!-- Customization Section -->
                <div class="settings-section">
                    <div class="settings-section-title"> Customization</div>
                    
                    <div class="settings-action">
                        <div class="settings-action-info">
                            <div class="settings-action-label">Add Variant</div>
                            <div class="settings-action-desc">Add color or texture variants</div>
                        </div>
                        <button class="settings-action-button" id="addVariantButton" onclick="handleAddVariant()">
                            Add
                        </button>
                    </div>
                    
                    <div class="settings-action" id="manageVariantsAction" style="display: none;">
                        <div class="settings-action-info">
                            <div class="settings-action-label">Manage Variants</div>
                            <div class="settings-action-desc" id="variantCountDesc">No variants available</div>
                        </div>
                        <button class="settings-action-button" onclick="handleManageVariants()">
                            Manage
                        </button>
                    </div>
                </div>
                
                <!-- Danger Zone Section -->
                <div class="settings-section">
                    <div class="settings-section-title"> Danger Zone</div>
                    
                    <div class="settings-action">
                        <div class="settings-action-info">
                            <div class="settings-action-label">Delete Furniture</div>
                            <div class="settings-action-desc">Permanently remove this furniture and all variants</div>
                        </div>
                        <button class="settings-action-button danger" id="deleteButton" onclick="handleDeleteFurniture()">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="settings-modal-footer">
                <button class="settings-close-button" onclick="closeFurnitureSettingsModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Export Kit Modal -->
    <div class="password-modal" id="exportModal" style="display: none;">
        <div class="modal-content futuristic-upload">
            <div class="upload-header">
                <div class="upload-icon-container">
                    <div class="upload-icon-bg" style="background: linear-gradient(135deg, #f85149, #ff6b6b);">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2L15.09 8.26L22 9L17 14.74L18.18 21.02L12 18L5.82 21.02L7 14.74L2 9L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
                <h3 class="upload-title"> Export Customer Integration Kit</h3>
                <p class="upload-subtitle">Generate downloadable packages with QR codes and embed links</p>
            </div>

            <form id="exportForm">
                <!-- Customer Selection -->
                <div class="form-group">
                    <label for="exportCustomerSelect">Select Customer</label>
                    <select id="exportCustomerSelect" class="form-control" required>
                        <option value="">Choose a customer...</option>
                    </select>
                </div>

                <!-- Export Format -->
                <div class="form-group">
                    <label for="exportFormatSelect">Export Format</label>
                    <select id="exportFormatSelect" class="form-control">
                        <option value="json">JSON - Raw data format</option>
                        <option value="html" selected>HTML - Ready-to-use web page</option>
                        <option value="csv">CSV - Spreadsheet format</option>
                    </select>
                </div>

                <!-- QR Code Options -->
                <div class="form-group">
                    <label>QR Code Customization</label>
                    <div class="qr-options">
                        <div class="form-row">
                            <div class="form-col">
                                <label for="qrSize">Size (pixels)</label>
                                <select id="qrSize" class="form-control">
                                    <option value="200">200x200 (Mobile)</option>
                                    <option value="256" selected>256x256 (Standard)</option>
                                    <option value="512">512x512 (High Res)</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label for="qrErrorLevel">Error Correction</label>
                                <select id="qrErrorLevel" class="form-control">
                                    <option value="L">Low (~7%)</option>
                                    <option value="M" selected>Medium (~15%)</option>
                                    <option value="Q">High (~25%)</option>
                                    <option value="H">Maximum (~30%)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="qrDarkColor">Dark Color</label>
                                <input type="color" id="qrDarkColor" class="form-control color-picker" value="#000000">
                            </div>
                            <div class="form-col">
                                <label for="qrLightColor">Light Color</label>
                                <input type="color" id="qrLightColor" class="form-control color-picker" value="#ffffff">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Options -->
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeEmbedCodes" checked>
                        Include embed codes for websites
                    </label>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="includeBrandInfo" checked>
                        Include branding information
                    </label>
                </div>

                <!-- Export Status -->
                <div id="exportStatus" class="export-status" style="display: none;">
                    <div class="status-icon"></div>
                    <div class="status-text">Preparing your export...</div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="modal-button secondary" onclick="closeExportModal()">
                        Cancel
                    </button>
                    <button type="submit" class="modal-button primary futuristic-primary" id="exportButton">
                         Generate Export Kit
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let deleteTarget = null;
        
        // Error reporting utility
        async function showErrorReporting(errorMessage, reportData) {
            const reportButton = document.createElement('button');
            reportButton.innerHTML = ' Report this issue to support';
            reportButton.style.cssText = 'margin-top: 10px; padding: 8px 16px; background: #f85149; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;';
            
            reportButton.onclick = async () => {
                const userDescription = prompt('Please describe what you were doing when this error occurred (optional):');
                
                try {
                    await fetch('/api/feedback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'error',
                            comment: `Error: ${errorMessage}\n\nUser description: ${userDescription || 'None provided'}\n\nTechnical details: ${JSON.stringify(reportData, null, 2)}`,
                            customerId: 'admin',
                            itemId: 'system',
                            itemName: 'Admin System',
                            userAgent: navigator.userAgent
                        })
                    });
                    
                    alert(' Issue reported successfully! Our team will investigate.');
                    reportButton.remove();
                } catch (error) {
                    alert(' Unable to submit report. Please contact support directly.');
                }
            };
            
            return reportButton;
        }

        // Enhanced error handling with report option
        function handleAPIError(error, response) {
            console.error('API Error:', error);
            
            if (response && response.showReportButton && response.reportData) {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'margin: 10px; padding: 15px; background: #ffeaea; border: 1px solid #f85149; border-radius: 6px;';
                errorDiv.innerHTML = `<p style="color: #d1242f; margin: 0 0 10px 0;">${response.error}</p>`;
                
                showErrorReporting(response.error, response.reportData).then(reportButton => {
                    errorDiv.appendChild(reportButton);
                });
                
                // Try to find a suitable container to show the error
                const container = document.getElementById('modelsContainer') || document.body;
                container.insertBefore(errorDiv, container.firstChild);
            }
        }
        
        // Check authentication before loading any data
        let isAuthenticated = false;
        
        function checkAuthentication() {
            // Check if user is authenticated via session storage
            const authToken = sessionStorage.getItem('adminAuthenticated');
            const userRole = localStorage.getItem('user_role');
            
            // Verify both tokens exist and role is admin
            if (!authToken || authToken !== 'true' || userRole !== 'admin') {
                // Clear any invalid tokens
                sessionStorage.removeItem('adminAuthenticated');
                localStorage.removeItem('user_role');
                localStorage.removeItem('username');
                localStorage.removeItem('customer_id');
                
                // Redirect to login page if not authenticated
                window.location.href = '/login.html';
                return false;
            }
            isAuthenticated = true;
            return true;
        }
        
        // Load models ONLY if authenticated
        if (checkAuthentication()) {
            // Show the body content after authentication is verified
            document.body.style.display = 'block';
            loadModels();
        }
        
        // Initialize customers after customerManager is defined
        // This will be called after the CustomerDataManager class is instantiated
        
        async function loadModels() {
            try {
                // Save current collapse states before refreshing
                saveCurrentCollapseStates();

                const response = await fetch('/api/models');
                if (!response.ok) throw new Error('Failed to load models');
                
                const data = await response.json();
                
                // Store models data globally for variant switching
                window.currentModelsData = data.models;
                
                // Initialize all product URL buttons to show original state
                setTimeout(() => {
                    data.models.forEach(model => {
                        const modelCard = document.querySelector(`[data-model-id="${model.id}"]`);
                        if (modelCard) {
                            const card = modelCard.closest('.model-card');
                            if (card) {
                                updateProductUrlButton(card, model.id, 'original');
                            }
                        }
                        
                        // Trigger dimension validation if dimensions exist
                        if (model.width_meters || model.height_meters || model.depth_meters) {
                            console.log(' Triggering dimension validation for model:', model.id);
                            validateModelDimensions(
                                model.id,
                                model.width_meters,
                                model.height_meters, 
                                model.depth_meters,
                                model.dimension_unit || 'cm'
                            );
                        }
                    });
                }, 100);
                
                // Update main stats
                document.getElementById('totalModels').textContent = data.stats.totalModels || 0;
                document.getElementById('totalViews').textContent = data.stats.totalViews || 0;
                document.getElementById('totalSize').textContent = formatFileSize(data.stats.totalSize || 0);
                
                
                // Group models by customer
                displayGroupedModels(data.models);
                
            } catch (error) {
                console.error('Error loading furniture:', error);
                document.getElementById('modelsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>Error Loading Furniture</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Initialize customers using centralized manager
        async function initializeCustomers() {
            await customerManager.loadFromAPI();
        }
        
        // Legacy function for backward compatibility
        async function loadCustomers() {
            await customerManager.loadFromAPI();
        }
        
        // Update sidebar customer count for specific customer
        function updateSidebarCustomerCount(customerId, count) {
            const customerItems = document.querySelectorAll('.customer-item');
            customerItems.forEach(item => {
                const customerName = item.querySelector('.customer-name').textContent.trim();
                const customer = customerManager.getAllCustomers().find(c => c.name === customerName);
                
                if (customer && customer.id === customerId) {
                    const countBadge = item.querySelector('.customer-count');
                    if (countBadge) {
                        countBadge.textContent = count;
                    }
                }
            });
        }
        
        // Refresh all assign dropdowns with latest customer data
        function refreshAssignDropdowns() {
            // This will be called when assign dropdowns are opened
            // No need to update all at once for performance
        }
        
        function updateCustomerSelect(customers) {
            const select = document.getElementById('customerSelect');
            select.innerHTML = '';
            
            // Add default customers
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = `${customer.id}:${customer.name}`;
                option.textContent = customer.name;
                select.appendChild(option);
            });
            
            // Ensure NAPO is always available
            if (!customers.find(c => c.id === 'napo')) {
                const napoOption = document.createElement('option');
                napoOption.value = 'napo:NAPO';
                napoOption.textContent = 'NAPO';
                select.insertBefore(napoOption, select.firstChild);
            }
        }
        
        function displayGroupedModels(models) {
            if (!models || models.length === 0) {
                document.getElementById('modelsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>No Furniture Yet</h3>
                        <p>Upload your first furniture piece to get started!</p>
                        <br>
                        <button class="action-button" onclick="toggleUploadModal()"> Upload Furniture</button>
                    </div>
                `;
                return;
            }
            
            // Group models by customer
            const customerGroups = {};
            models.forEach(model => {
                const customerKey = model.customer_id || 'unassigned';
                const customerName = model.customer_name || 'Unassigned';
                
                if (!customerGroups[customerKey]) {
                    customerGroups[customerKey] = {
                        id: customerKey,
                        name: customerName,
                        models: [],
                        totalViews: 0,
                        totalSize: 0
                    };
                }
                
                customerGroups[customerKey].models.push(model);
                customerGroups[customerKey].totalViews += model.view_count || 0;
                customerGroups[customerKey].totalSize += model.file_size || 0;
            });
            
            let html = '<div class="customer-groups">';
            
            // Sort customers (NAPO first, then others)
            const sortedCustomers = Object.values(customerGroups).sort((a, b) => {
                if (a.id === 'napo') return -1;
                if (b.id === 'napo') return 1;
                return a.name.localeCompare(b.name);
            });
            
            sortedCustomers.forEach(customer => {
                console.log('Creating customer group:', customer.id, customer.name);
                html += `
                    <div class="customer-group collapsed" data-customer="${customer.id}">
                        <div class="customer-header" onclick="toggleCustomerGroup('${customer.id.replace(/'/g, "\\'")}')">
                            <div class="customer-name">
                                ${customer.name}
                                <span class="customer-badge">${customer.models.length}</span>
                            </div>
                            <div class="customer-stats">
                                ${customer.totalViews} views  ${formatFileSize(customer.totalSize)}
                                <span class="expand-icon"></span>
                            </div>
                        </div>
                        <div class="customer-content">
                            <div class="models-grid">
                                ${customer.models.map(model => generateModelCard(model)).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('modelsContainer').innerHTML = html;

            // Restore saved collapse states from localStorage
            const collapsedGroups = JSON.parse(localStorage.getItem('collapsedCustomerGroups') || '{}');
            document.querySelectorAll('[data-customer]').forEach(group => {
                const customerId = group.getAttribute('data-customer');
                // If we have a saved state for this customer
                if (collapsedGroups.hasOwnProperty(customerId)) {
                    if (collapsedGroups[customerId] === false) {
                        // User wants this group expanded
                        group.classList.remove('collapsed');
                    } else {
                        // User wants this group collapsed (or it's the default)
                        group.classList.add('collapsed');
                    }
                }
                // If no saved state, keep default collapsed state
            });
        }
        
        function generateModelCard(model) {
            const viewUrl = `https://newfurniture.live/view?id=${model.id}`;
            // Temporary fix: use working Cloudinary URL for the broken couch model
            let modelUrl = model.cloudinary_url || `/api/model/${model.id}`;
            if (model.cloudinary_url && model.cloudinary_url.includes('1756571179025-couch.glb')) {
                modelUrl = 'https://res.cloudinary.com/djjixqxzy/raw/upload/v1757948384/furniture-models/couch_green_pyupsh.glb';
                console.log(` Using working URL for couch model: ${modelUrl}`);
            }
            console.log(` Model preview URL for ${model.title}:`, modelUrl);
            console.log(` Stored cloudinary_url for ${model.title}:`, model.cloudinary_url);

            // Check if this is a wallpaper
            const isWallpaper = model.metadata && model.metadata.type === 'wallpaper';
            const albedoUrl = isWallpaper && model.metadata ? model.metadata.albedoUrl : null;

            return `
                <div class="model-card">
                    <div class="model-preview">
                        ${isWallpaper && albedoUrl ? `
                            <div class="wallpaper-preview" onclick="window.open('${viewUrl}', '_blank')" style="width: 100%; height: 200px; background: url('${albedoUrl}') center/cover; border-radius: 12px; position: relative; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div style="position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;"> Wallpaper</div>
                                <div style="background: rgba(0,0,0,0.5); color: white; padding: 8px 12px; border-radius: 8px; font-size: 14px;">Click to View in AR</div>
                            </div>
                        ` : `
                            <model-viewer
                                class="model-viewer"
                                src="${modelUrl}"
                                alt="${model.title || 'Furniture Piece'}"
                                camera-controls
                                auto-rotate
                                auto-rotate-delay="2000"
                                rotation-per-second="15deg"
                                shadow-intensity="1"
                                camera-orbit="45deg 55deg auto"
                                loading="eager"
                                poster=""
                                environment-image="neutral"
                                exposure="1"
                                onloading="console.log(' Loading model:', this.src)"
                                onload="console.log(' Model loaded successfully:', this.src)"
                                onerror="console.error(' Model failed to load:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div slot="progress-bar" style="display: none;"></div>
                            </model-viewer>
                            <div style="display: none; align-items: center; justify-content: center; height: 200px; background: #1c2128; color: #7d8590; font-size: 14px;">
                                 Preview not available
                            </div>
                        `}
                    </div>
                    
                    <div class="model-info">
                        <div class="model-title editable-title" data-model-id="${model.id}" ondblclick="startEditTitle(this)">${model.title || 'Untitled'}</div>
                        <div class="model-description">${model.description || 'No description provided'}</div>
                        
                        <div class="model-meta">
                            <span class="model-id" style="display: none;">${model.id}</span>
                            <span>${formatDate(model.upload_date)}</span>
                        </div>
                        
                        <div class="model-stats">
                            <div class="stat-item">
                                <div class="stat-value">${model.view_count || 0}</div>
                                <div class="stat-label">Views</div>
                            </div>
                        </div>
                        
                        <!-- Dimensions Section -->
                        ${model.width_meters || model.height_meters || model.depth_meters ? `
                            <div class="dimensions-info" data-model-id="${model.id}" style="margin: 12px 0; padding: 8px; background: rgba(88, 166, 255, 0.1); border-radius: 8px; border: 1px solid rgba(88, 166, 255, 0.2);">
                                <div style="font-size: 11px; color: #58a6ff; font-weight: 500; margin-bottom: 4px;"> Dimensions (${model.dimension_unit || 'cm'})</div>
                                <div style="font-size: 10px; color: #7d8590;">
                                    ${[
                                        model.width_meters ? `W: ${formatDimensionFromMeters(model.width_meters, model.dimension_unit || 'cm')}` : null,
                                        model.height_meters ? `H: ${formatDimensionFromMeters(model.height_meters, model.dimension_unit || 'cm')}` : null,
                                        model.depth_meters ? `D: ${formatDimensionFromMeters(model.depth_meters, model.dimension_unit || 'cm')}` : null
                                    ].filter(Boolean).join('  ')}
                                </div>
                                <div class="dimension-validation" id="validation-${model.id}" style="margin-top: 4px; font-size: 9px; display: none;"></div>
                            </div>
                        ` : ''}
                        
                        ${model.variants && model.variants.length > 0 ? `
                            <div class="variants-circles">
                                <!-- Always show original as first variant with extracted color -->
                                <div class="variant-wrapper">
                                    <div class="variant-circle original-variant"
                                         style="background: ${model.dominant_color || '#6b7280'};"
                                         title="Original"
                                         data-model-id="${model.id}"
                                         onclick="switchToVariant('${model.id}', 'original', '${modelUrl}')">
                                    </div>
                                    <div class="variant-delete"
                                         title="Delete Original"
                                         onclick="deleteMainVariant('${model.id}', event)"></div>
                                </div>
                                ${model.variants.map(variant => `
                                    <div class="variant-wrapper">
                                        <div class="variant-circle ${variant.is_primary ? 'primary' : ''}"
                                             style="background-color: ${variant.hex_color};"
                                             title="${variant.variant_name}"
                                             onclick="switchToVariant('${model.id}', '${variant.id}', '${variant.cloudinary_url}', '${variant.hex_color}', '${variant.variant_type || 'upload'}')">
                                             ${variant.is_primary ? '' : ''}
                                        </div>
                                        <div class="variant-delete"
                                             title="Delete ${variant.variant_name}"
                                             onclick="deleteVariant('${variant.id}', '${model.id}', event)"></div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="card-actions-consolidated">
                            <a href="/view?id=${model.id}" target="_blank" class="action-button primary">
                                 View
                            </a>
                            <button class="action-button primary" onclick="copyToClipboard('${viewUrl}', this)">
                                 Copy Link
                            </button>
                            <button class="action-button settings" onclick="openFurnitureSettingsModal(${JSON.stringify(model).replace(/"/g, '&quot;')})">
                                 Settings
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function saveCurrentCollapseStates() {
            const collapsedGroups = JSON.parse(localStorage.getItem('collapsedCustomerGroups') || '{}');
            document.querySelectorAll('[data-customer]').forEach(group => {
                const customerId = group.getAttribute('data-customer');
                collapsedGroups[customerId] = group.classList.contains('collapsed');
            });
            localStorage.setItem('collapsedCustomerGroups', JSON.stringify(collapsedGroups));
        }

        function toggleCustomerGroup(customerId) {
            console.log('Toggling customer group:', customerId);
            // Find the group by iterating through all customer groups to avoid CSS selector escaping issues
            const groups = document.querySelectorAll('[data-customer]');
            let group = null;
            for (const g of groups) {
                if (g.getAttribute('data-customer') === customerId) {
                    group = g;
                    break;
                }
            }
            console.log('Found group element:', group);
            if (!group) {
                console.error('Could not find group with ID:', customerId);
                console.log('Available groups:', document.querySelectorAll('[data-customer]'));
                return;
            }
            group.classList.toggle('collapsed');

            // Save state to localStorage
            const collapsedGroups = JSON.parse(localStorage.getItem('collapsedCustomerGroups') || '{}');
            collapsedGroups[customerId] = group.classList.contains('collapsed');
            localStorage.setItem('collapsedCustomerGroups', JSON.stringify(collapsedGroups));
        }
        
        function deleteModel(id, cloudinaryPublicId) {
            deleteTarget = { id, cloudinaryPublicId };
            
            if (confirm('Are you sure you want to delete this model?')) {
                // Find the delete button and show loading state
                const deleteButton = document.querySelector(`button[onclick*="${id}"]`);
                if (deleteButton) {
                    deleteButton.disabled = true;
                    deleteButton.innerHTML = '<span class="loading-spinner"></span> Removing...';
                    deleteButton.style.opacity = '0.7';
                }
                confirmDelete();
            }
        }
        
        async function confirmDelete() {
            try {
                const response = await fetch('/api/models', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(deleteTarget)
                });
                
                if (!response.ok) throw new Error('Failed to delete model');
                
                // Reload models
                loadModels();
                
            } catch (error) {
                alert('Error deleting model: ' + error.message);
                
                // Reset button state on error
                if (deleteTarget) {
                    const deleteButton = document.querySelector(`button[onclick*="${deleteTarget.id}"]`);
                    if (deleteButton) {
                        deleteButton.disabled = false;
                        deleteButton.innerHTML = ' Remove';
                        deleteButton.style.opacity = '1';
                    }
                }
            }
        }
        
        
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            });
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return '0 MB';
            const mb = bytes / (1024 * 1024);
            if (mb < 1) {
                const kb = bytes / 1024;
                return kb.toFixed(1) + ' KB';
            }
            return mb.toFixed(1) + ' MB';
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
        
        // Format dimensions from meters to display unit
        function formatDimensionFromMeters(meters, unit) {
            if (!meters) return '0';
            
            switch(unit) {
                case 'm': 
                    return meters.toFixed(2);
                case 'in':
                    return (meters / 0.0254).toFixed(1);
                case 'ft':
                    return (meters / 0.3048).toFixed(2);
                default: // cm
                    return (meters * 100).toFixed(0);
            }
        }
        
        // Validate model dimensions against user input
        function validateModelDimensions(modelId, expectedWidth, expectedHeight, expectedDepth, unit) {
            const modelViewer = document.querySelector(`[data-model-id="${modelId}"] model-viewer`);
            if (!modelViewer) return;
            
            const validationDiv = document.getElementById(`validation-${modelId}`);
            if (!validationDiv) return;
            
            // Add small delay to ensure model is loaded
            setTimeout(() => {
                try {
                    const actualDimensions = modelViewer.getDimensions();
                    if (actualDimensions) {
                        console.log(` Model ${modelId} actual dimensions (meters):`, actualDimensions);
                        
                        const tolerance = 0.1; // 10cm tolerance
                        const warnings = [];
                        
                        const checkDimension = (actual, expected, name) => {
                            if (expected && actual && Math.abs(actual - expected) > tolerance) {
                                const actualFormatted = formatDimensionFromMeters(actual, unit);
                                const expectedFormatted = formatDimensionFromMeters(expected, unit);
                                warnings.push(`${name}: model ${actualFormatted}${unit} vs input ${expectedFormatted}${unit}`);
                            }
                        };
                        
                        checkDimension(actualDimensions.x, expectedWidth, 'Width');
                        checkDimension(actualDimensions.y, expectedHeight, 'Height');  
                        checkDimension(actualDimensions.z, expectedDepth, 'Depth');
                        
                        if (warnings.length > 0) {
                            validationDiv.innerHTML = ` Scale mismatch: ${warnings.join(', ')}`;
                            validationDiv.style.color = '#f59e0b';
                            validationDiv.style.display = 'block';
                        } else if (expectedWidth || expectedHeight || expectedDepth) {
                            validationDiv.innerHTML = ` Dimensions match input`;
                            validationDiv.style.color = '#10b981';
                            validationDiv.style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.warn('Could not validate dimensions for model', modelId, error);
                }
            }, 2000);
        }
        
        let selectedFile = null;

        // Upload modal functions
        function toggleUploadModal() {
            document.getElementById('uploadModal').style.display = 'flex';
            setupDragAndDrop();
        }
        
        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            document.getElementById('uploadForm').reset();
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressPercentage').textContent = '0%';
            selectedFile = null;
            hideFilePreview();
        }
        
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            
            dropZone.onclick = () => fileInput.click();
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, handleDragEnter, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, handleDragLeave, false);
            });

            dropZone.addEventListener('drop', handleFileDrop, false);
            fileInput.addEventListener('change', handleFileSelect, false);
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function handleDragEnter(e) {
            document.getElementById('dropZone').classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            document.getElementById('dropZone').classList.remove('drag-over');
        }
        
        function handleFileDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        }
        
        function handleFile(file) {
            if (!file.name.match(/\.(glb|gltf)$/i)) {
                alert('Please select a GLB or GLTF file');
                return;
            }
            
            if (file.size > 100 * 1024 * 1024) {
                alert('File size must be less than 100MB');
                return;
            }
            
            selectedFile = file;
            showFilePreview(file);
            
            // Auto-fill title
            if (!document.getElementById('titleInput').value) {
                document.getElementById('titleInput').value = file.name.replace(/\.(glb|gltf)$/i, '');
            }
        }
        
        function showFilePreview(file) {
            document.getElementById('previewFileName').textContent = file.name;
            document.getElementById('previewFileSize').textContent = formatFileSize(file.size);
            document.getElementById('filePreviewContainer').style.display = 'block';
            document.getElementById('dropZone').style.display = 'none';
        }
        
        function hideFilePreview() {
            document.getElementById('filePreviewContainer').style.display = 'none';
            document.getElementById('dropZone').style.display = 'block';
        }
        
        function removeFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            hideFilePreview();
        }
        
        function formatFileSize(bytes) {
            const mb = bytes / (1024 * 1024);
            if (mb < 1) {
                return (bytes / 1024).toFixed(1) + ' KB';
            }
            return mb.toFixed(1) + ' MB';
        }
        
        // Handle upload form with direct Cloudinary upload
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedFile) {
                alert('Please select a furniture file');
                return;
            }

            const titleInput = document.getElementById('titleInput');
            const descriptionInput = document.getElementById('descriptionInput');
            const productUrlInput = document.getElementById('productUrlInput');
            const customerSelect = document.getElementById('customerSelect');

            // Parse customer selection
            const [customerId, customerName] = customerSelect.value.split(':');

            // Show progress
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadButton').disabled = true;
            document.getElementById('uploadStatus').textContent = 'Uploading furniture...';

            try {
                // Step 1: Upload directly to Cloudinary (bypasses Vercel's 4.5MB limit)
                document.getElementById('uploadStatus').textContent = 'Uploading to cloud storage...';
                document.getElementById('progressBar').style.width = '30%';
                document.getElementById('progressPercentage').textContent = '30%';

                const cloudinaryFormData = new FormData();
                cloudinaryFormData.append('file', selectedFile);
                cloudinaryFormData.append('upload_preset', 'furniture_unsigned');
                cloudinaryFormData.append('folder', 'furniture-models');

                const cloudinaryUpload = await fetch(
                    'https://api.cloudinary.com/v1_1/djjixqxzy/raw/upload',
                    {
                        method: 'POST',
                        body: cloudinaryFormData
                    }
                );

                if (!cloudinaryUpload.ok) {
                    const errorText = await cloudinaryUpload.text();
                    throw new Error(`Cloud upload failed: ${errorText}`);
                }

                const cloudinaryResult = await cloudinaryUpload.json();
                console.log(' Cloudinary upload successful:', cloudinaryResult.secure_url);

                // Step 2: Save metadata to database
                document.getElementById('uploadStatus').textContent = 'Saving to database...';
                document.getElementById('progressBar').style.width = '80%';
                document.getElementById('progressPercentage').textContent = '80%';

                const saveResponse = await fetch('/api/cloudinary-save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cloudinaryUrl: cloudinaryResult.secure_url,
                        cloudinaryPublicId: cloudinaryResult.public_id,
                        fileSize: cloudinaryResult.bytes,
                        title: titleInput.value || selectedFile.name.replace(/\.(glb|gltf)$/i, ''),
                        description: descriptionInput.value || '',
                        customerId: customerId,
                        customerName: customerName,
                        isVariant: false
                    })
                });

                if (!saveResponse.ok) {
                    const errorText = await saveResponse.text();
                    throw new Error(`Database save failed: ${errorText}`);
                }

                const result = await saveResponse.json();

                // Step 3: Complete
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressPercentage').textContent = '100%';
                document.getElementById('uploadStatus').textContent = ' Upload successful!';

                console.log(' Model uploaded successfully:', result);

                // Close modal and refresh models after 2 seconds
                setTimeout(() => {
                    closeUploadModal();
                    loadModels();
                }, 2000);

            } catch (error) {
                console.error('Upload failed:', error);
                document.getElementById('uploadStatus').textContent = ' Upload failed: ' + error.message;
                document.getElementById('uploadButton').disabled = false;
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('progressPercentage').textContent = '0%';
            }
        });
        
        // Auto-refresh every 30 seconds ONLY if authenticated
        setInterval(() => {
            if (isAuthenticated && checkAuthentication()) {
                loadModels();
            }
        }, 30000);
        
        // Centralized Customer Data Management
        class CustomerDataManager {
            constructor() {
                this.customers = new Map();
                this.listeners = new Set();
            }
            
            // Add or update customer
            setCustomer(customer) {
                const existed = this.customers.has(customer.id);
                this.customers.set(customer.id, customer);
                
                if (existed) {
                    this.notifyListeners('customerUpdated', customer);
                } else {
                    this.notifyListeners('customerAdded', customer);
                }
            }
            
            // Get customer by ID
            getCustomer(customerId) {
                return this.customers.get(customerId);
            }
            
            // Get all customers as array
            getAllCustomers() {
                return Array.from(this.customers.values()).sort((a, b) => a.name.localeCompare(b.name));
            }
            
            // Update customer count
            updateCustomerCount(customerId, count) {
                const customer = this.customers.get(customerId);
                if (customer) {
                    customer.count = count;
                    this.notifyListeners('customerCountUpdated', customer);
                }
            }
            
            // Check if customer exists
            hasCustomer(customerId) {
                return this.customers.has(customerId);
            }
            
            // Add event listener
            addListener(callback) {
                this.listeners.add(callback);
            }
            
            // Remove event listener
            removeListener(callback) {
                this.listeners.delete(callback);
            }
            
            // Notify all listeners of changes
            notifyListeners(event, data) {
                this.listeners.forEach(listener => {
                    try {
                        listener(event, data);
                    } catch (error) {
                        console.error('Customer data listener error:', error);
                    }
                });
            }
            
            // Load customers from API
            async loadFromAPI() {
                try {
                    const response = await fetch('/api/customers');
                    if (!response.ok) throw new Error('Failed to load customers');
                    
                    const data = await response.json();
                    data.customers.forEach(customer => {
                        this.customers.set(customer.id, customer);
                    });
                    
                    this.notifyListeners('customersLoaded', this.getAllCustomers());
                } catch (error) {
                    console.error('Error loading customers:', error);
                }
            }
        }
        
        // Global customer manager instance
        const customerManager = new CustomerDataManager();
        
        // Initialize customer data manager listeners and start initialization
        customerManager.addListener((event, data) => {
            switch(event) {
                case 'customersLoaded':
                case 'customerAdded':
                case 'customerUpdated':
                    // Update sidebar customer list
                    updateSidebarCustomers(customerManager.getAllCustomers());
                    // Update assign dropdowns
                    refreshAssignDropdowns();
                    // Update upload modal dropdown
                    updateCustomerSelect(customerManager.getAllCustomers());
                    break;
                    
                case 'customerCountUpdated':
                    // Update sidebar counts
                    updateSidebarCustomerCount(data.id, data.count);
                    break;
            }
        });
        
        // Now initialize customers (after customerManager is ready) - ONLY if authenticated
        if (isAuthenticated) {
            initializeCustomers();
        }
        
        // Sidebar functionality
        let currentCustomerFilter = null;
        let searchQuery = '';
        let allCustomers = []; // Keep for backward compatibility
        
        
        function updateSidebarCustomers(customers) {
            allCustomers = customers;
            const customerList = document.getElementById('customerList');
            customerList.innerHTML = '';
            
            // Add "All Furniture" option
            const allItem = document.createElement('li');
            allItem.className = `customer-item ${currentCustomerFilter === null ? 'active' : ''}`;
            allItem.setAttribute('data-customer-id', 'all');
            allItem.innerHTML = `
                <div class="customer-item-content">
                    <span class="customer-name">All Furniture</span>
                    <span class="customer-count">${customers.reduce((sum, c) => sum + c.count, 0)}</span>
                </div>
            `;
            allItem.onclick = () => filterByCustomer(null);
            customerList.appendChild(allItem);
            
            // Add "Unassigned" option - only show if there are unassigned items
            const unassignedCustomer = customers.find(c => c.id === 'unassigned');
            const unassignedCount = unassignedCustomer?.count || 0;
            
            // Only show Unassigned section if there are unassigned items
            if (unassignedCount > 0) {
                const unassignedItem = document.createElement('li');
                unassignedItem.className = `customer-item ${currentCustomerFilter === 'unassigned' ? 'active' : ''}`;
                unassignedItem.setAttribute('data-customer-id', 'unassigned');
                unassignedItem.innerHTML = `
                    <div class="customer-item-content">
                        <span class="customer-name">Unassigned</span>
                        <span class="customer-count">${unassignedCount}</span>
                    </div>
                `;
                unassignedItem.onclick = () => filterByCustomer('unassigned', 'Unassigned');
                customerList.appendChild(unassignedItem);
            } else if (currentCustomerFilter === 'unassigned') {
                // If currently filtering by unassigned but no unassigned items exist, reset to "All"
                filterByCustomer(null);
            }
            
            console.log('Debug: Customers from API:', customers);
            console.log('Debug: Unassigned customer found:', unassignedCustomer);
            console.log('Debug: Unassigned count:', unassignedCount);
            
            // Add customer items (excluding unassigned which we show separately)
            customers.filter(customer => customer.id !== 'unassigned').forEach(customer => {
                const item = document.createElement('li');
                item.className = `customer-item ${currentCustomerFilter === customer.id ? 'active' : ''}`;
                item.setAttribute('data-customer-id', customer.id);
                item.innerHTML = `
                    <div class="customer-item-content">
                        <span class="customer-name">${customer.name}</span>
                        <span class="customer-count">${customer.count}</span>
                    </div>
                `;
                item.onclick = () => filterByCustomer(customer.id, customer.name);
                customerList.appendChild(item);
            });
            
        }
        
        function filterByCustomer(customerId, customerName = null) {
            // Always navigate to Dashboard first (if not already there)
            if (currentPage !== 'dashboard') {
                console.log(` Switching from ${currentPage} to Dashboard to show customer: ${customerName || customerId}`);
                navigateToPage('dashboard');
            }
            
            currentCustomerFilter = customerId;
            
            // Update active state in sidebar
            document.querySelectorAll('.customer-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and highlight the clicked customer
            const customerIdToFind = customerId === null ? 'all' : customerId;
            const clickedCustomer = document.querySelector(`.customer-item[data-customer-id="${customerIdToFind}"]`);
            if (clickedCustomer) {
                clickedCustomer.classList.add('active');
            } else if (event && event.target) {
                // Fallback to event target if available
                const customerItem = event.target.closest('.customer-item');
                if (customerItem) {
                    customerItem.classList.add('active');
                }
            }
            
            // Filter displayed models
            const customerGroups = document.querySelectorAll('.customer-group');
            customerGroups.forEach(group => {
                const groupCustomerId = group.getAttribute('data-customer');
                if (currentCustomerFilter === null) {
                    // Show all
                    group.style.display = 'block';
                } else {
                    // Show only matching customer
                    group.style.display = groupCustomerId === currentCustomerFilter ? 'block' : 'none';
                }
            });
            
            // Update header to show current filter
            const headerTitle = document.querySelector('#dashboardPage .header h1');
            if (customerId === null) {
                headerTitle.textContent = ' Admin Dashboard';
            } else {
                headerTitle.textContent = ` ${customerName || 'Customer'} Dashboard`;
            }
        }
        
        function handleSearch(query) {
            searchQuery = query.toLowerCase();
            
            // If no query, show current filter
            if (!searchQuery) {
                filterByCustomer(currentCustomerFilter);
                return;
            }
            
            // Search through all cards
            const modelCards = document.querySelectorAll('.model-card');
            const customerGroups = document.querySelectorAll('.customer-group');
            
            // First hide all groups
            customerGroups.forEach(group => {
                group.style.display = 'none';
            });
            
            // Show cards that match search
            let hasResults = false;
            modelCards.forEach(card => {
                const title = card.querySelector('.model-title')?.textContent?.toLowerCase() || '';
                const description = card.querySelector('.model-description')?.textContent?.toLowerCase() || '';
                const customerName = card.closest('.customer-group')?.querySelector('.customer-name')?.textContent?.toLowerCase() || '';
                
                const matches = title.includes(searchQuery) || 
                               description.includes(searchQuery) || 
                               customerName.includes(searchQuery);
                
                if (matches) {
                    hasResults = true;
                    // Show the parent group
                    const group = card.closest('.customer-group');
                    if (group) {
                        group.style.display = 'block';
                    }
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
            
            if (!hasResults) {
                // Show empty state in main area
                document.getElementById('modelsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>No Results Found</h3>
                        <p>No furniture matches "${query}"</p>
                    </div>
                `;
            }
        }
        
        // Open user modal with customer role pre-selected
        function openUserModalForCustomer() {
            toggleUserModal();
            // Pre-select customer role
            document.getElementById('newRole').value = 'customer';
            // Trigger change event to show customer fields
            document.getElementById('newRole').dispatchEvent(new Event('change'));
            // Focus on username field
            setTimeout(() => {
                document.getElementById('newUsername').focus();
            }, 100);
        }

        function showAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'block';
            document.getElementById('addCustomerNameInput').focus();
        }
        
        function hideAddCustomerForm() {
            document.getElementById('addCustomerForm').style.display = 'none';
            document.getElementById('addCustomerNameInput').value = '';
        }
        
        function handleCustomerNameKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveNewCustomer();
            } else if (event.key === 'Escape') {
                event.preventDefault();
                hideAddCustomerForm();
            }
        }
        
        async function saveNewCustomer() {
            const customerName = document.getElementById('addCustomerNameInput').value.trim();
            if (!customerName) return;
            
            try {
                hideAddCustomerForm();
                
                // Create customer ID from name (simple slug)
                const customerId = customerName.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');
                
                // Check if already exists in centralized manager
                if (customerManager.hasCustomer(customerId)) {
                    alert('Customer already exists!');
                    return;
                }
                
                // Add to centralized customer manager
                customerManager.setCustomer({
                    id: customerId,
                    name: customerName,
                    count: 0
                });
                
            } catch (error) {
                alert('Failed to add customer: ' + error.message);
            }
        }
        
        // Update the existing loadCustomers function to also update sidebar
        const originalLoadCustomers = loadCustomers;
        loadCustomers = async function() {
            await originalLoadCustomers();
            
            // Also fetch for sidebar
            try {
                const response = await fetch('/api/customers');
                if (response.ok) {
                    const data = await response.json();
                    updateSidebarCustomers(data.customers);
                }
            } catch (error) {
                console.error('Error loading customers for sidebar:', error);
            }
        };
        
        
        
        function updateCustomerBadges() {
            document.querySelectorAll('.customer-group').forEach(group => {
                const badge = group.querySelector('.customer-badge');
                const cards = group.querySelectorAll('.model-card');
                if (badge) {
                    badge.textContent = cards.length;
                }
            });
        }
        
        // Assign Dropdown Functions
        function toggleAssignDropdown(button, modelId, currentCustomerId, currentCustomerName) {
            // Close any other open dropdowns
            document.querySelectorAll('.assign-dropdown.show').forEach(dropdown => {
                if (dropdown !== button.parentNode) {
                    dropdown.classList.remove('show');
                }
            });
            
            const dropdown = button.parentNode;
            const content = dropdown.querySelector('.assign-dropdown-content');
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                return;
            }
            
            // Populate dropdown with customers
            populateAssignDropdown(content, modelId, currentCustomerId, currentCustomerName);
            dropdown.classList.add('show');
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove('show');
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        }
        
        function populateAssignDropdown(content, modelId, currentCustomerId, currentCustomerName) {
            content.innerHTML = '';
            
            // Show current assignment
            if (currentCustomerId && currentCustomerName) {
                const currentOption = document.createElement('div');
                currentOption.className = 'assign-option current';
                currentOption.innerHTML = ` Currently: ${currentCustomerName}`;
                content.appendChild(currentOption);
            }
            
            // Add all customers from centralized manager
            const customers = customerManager.getAllCustomers();
            customers.forEach(customer => {
                if (customer.id !== currentCustomerId) {
                    const option = document.createElement('div');
                    option.className = 'assign-option';
                    option.textContent = customer.name;
                    option.onclick = () => assignFurnitureToCustomer(modelId, customer.id, customer.name);
                    content.appendChild(option);
                }
            });
            
            // Add "Create New Customer" option
            const newOption = document.createElement('div');
            newOption.className = 'assign-option new-customer';
            newOption.innerHTML = '+ Create New Customer';
            newOption.onclick = () => assignToNewCustomer(modelId);
            content.appendChild(newOption);
        }
        
        async function assignFurnitureToCustomer(modelId, customerId, customerName) {
            try {
                // Close dropdown
                document.querySelectorAll('.assign-dropdown.show').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
                
                // No confirmation needed - just assign directly
                
                // Update database via API
                const response = await fetch('/api/assign', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ modelId, customerId, customerName })
                });
                
                if (!response.ok) {
                    const responseText = await response.text();
                    console.error('Assignment API Error Response:', responseText);
                    
                    try {
                        const error = JSON.parse(responseText);
                        throw new Error(error.error || 'Assignment failed');
                    } catch (jsonError) {
                        throw new Error(`API returned non-JSON response: ${responseText.substring(0, 100)}...`);
                    }
                }
                
                const responseText = await response.text();
                console.log('Assignment API Success Response:', responseText);
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (jsonError) {
                    console.error('Success response is not valid JSON:', responseText);
                    throw new Error(`API returned non-JSON success response: ${responseText.substring(0, 100)}...`);
                }
                
                // Update UI immediately
                updateModelCardAssignment(modelId, customerId, customerName);
                
                alert(` Furniture assigned to ${customerName}!`);
                
                // Refresh data to ensure consistency
                loadModels();
                loadCustomers();
                
            } catch (error) {
                console.error('Assignment error:', error);
                alert('Failed to assign furniture: ' + error.message);
            }
        }
        
        function updateModelCardAssignment(modelId, customerId, customerName) {
            // Find the model card
            const modelCard = Array.from(document.querySelectorAll('.model-card')).find(card => 
                card.querySelector('.model-id').textContent === modelId
            );
            
            if (!modelCard) return;
            
            // Find or create target customer group
            let targetGroup = document.querySelector(`[data-customer="${customerId}"]`);
            
            if (!targetGroup) {
                // Create new customer group
                const groupsContainer = document.querySelector('.customer-groups');
                targetGroup = document.createElement('div');
                targetGroup.className = 'customer-group collapsed';
                targetGroup.setAttribute('data-customer', customerId);
                targetGroup.innerHTML = `
                    <div class="customer-header" onclick="toggleCustomerGroup('${customerId.replace(/'/g, "\\'")}')">
                        <div class="customer-name">
                            ${customerName}
                            <span class="customer-badge">0</span>
                        </div>
                        <div class="customer-stats">
                            0 views  0 B
                            <span class="expand-icon"></span>
                        </div>
                    </div>
                    <div class="customer-content">
                        <div class="models-grid">
                        </div>
                    </div>
                `;
                
                // Insert in alphabetical order
                const existingGroups = Array.from(groupsContainer.children);
                let inserted = false;
                for (let group of existingGroups) {
                    const groupName = group.querySelector('.customer-name')?.textContent.trim() || '';
                    if (customerName.localeCompare(groupName) < 0) {
                        groupsContainer.insertBefore(targetGroup, group);
                        inserted = true;
                        break;
                    }
                }
                if (!inserted) {
                    groupsContainer.appendChild(targetGroup);
                }
            }
            
            // Move the card
            const targetGrid = targetGroup.querySelector('.models-grid');
            targetGrid.appendChild(modelCard);
            
            // Update assign button to reflect new assignment
            const assignButton = modelCard.querySelector('.assign-button');
            assignButton.setAttribute('onclick', `toggleAssignDropdown(this, '${modelId}', '${customerId}', '${customerName}')`);
            
            // Update customer badges
            updateCustomerBadges();
        }
        
        async function assignToNewCustomer(modelId) {
            const customerName = prompt('Enter new customer name:');
            if (!customerName?.trim()) return;
            
            const customerId = customerName.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');
            
            // Check if already exists in centralized manager
            if (customerManager.hasCustomer(customerId)) {
                alert('Customer already exists!');
                return;
            }
            
            // Add to centralized customer manager (this will trigger all UI updates)
            customerManager.setCustomer({
                id: customerId,
                name: customerName,
                count: 0
            });
            
            // Now assign to this customer
            await assignFurnitureToCustomer(modelId, customerId, customerName);
        }

        // Feedback Management Functions
        async function loadFeedback() {
            try {
                console.log(' Loading feedback...');
                
                // Get filter values
                const customerFilter = document.getElementById('customerFilter')?.value || '';
                const typeFilter = document.getElementById('typeFilter')?.value || '';
                const modelFilter = document.getElementById('modelFilter')?.value || '';
                
                // Build query string
                let queryParams = new URLSearchParams();
                if (customerFilter) queryParams.append('customer', customerFilter);
                if (typeFilter) queryParams.append('type', typeFilter);
                if (modelFilter) queryParams.append('model', modelFilter);
                
                const queryString = queryParams.toString();
                const url = `/api/feedback${queryString ? '?' + queryString : ''}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load feedback');
                
                const data = await response.json();
                console.log(' Feedback data:', data);
                
                displayFeedback(data.feedback || []);
                updateFeedbackStats(data.feedback || []);
                
            } catch (error) {
                console.error('Error loading feedback:', error);
                document.getElementById('feedbackContainer').innerHTML = `
                    <div class="error-message">
                        <p> Failed to load feedback</p>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function displayFeedback(feedback) {
            const container = document.getElementById('feedbackContainer');
            
            if (!feedback || feedback.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No feedback found</h3>
                        <p>No customer feedback matches your current filters.</p>
                    </div>
                `;
                return;
            }
            
            const html = `
                <div class="feedback-table">
                    <div class="feedback-header">
                        <div class="feedback-col">Date</div>
                        <div class="feedback-col">Customer</div>
                        <div class="feedback-col">Product</div>
                        <div class="feedback-col">Type</div>
                        <div class="feedback-col">Categories</div>
                        <div class="feedback-col">Comment</div>
                    </div>
                    ${feedback.map(fb => `
                        <div class="feedback-row ${fb.feedback_type}">
                            <div class="feedback-col">
                                <div class="feedback-date">
                                    ${new Date(fb.created_at).toLocaleDateString()}
                                    <span class="feedback-time">${new Date(fb.created_at).toLocaleTimeString()}</span>
                                </div>
                            </div>
                            <div class="feedback-col">
                                <span class="feedback-customer">${fb.customer_id}</span>
                            </div>
                            <div class="feedback-col">
                                <span class="feedback-model" title="${fb.model_id}">${fb.model_name || 'Unknown'}</span>
                            </div>
                            <div class="feedback-col">
                                <span class="feedback-type-badge ${fb.feedback_type}">
                                    ${fb.feedback_type === 'positive' ? '' : ''} ${fb.feedback_type}
                                </span>
                            </div>
                            <div class="feedback-col">
                                <div class="feedback-categories">
                                    ${(fb.categories || []).map(cat => `<span class="category-tag">${cat}</span>`).join('')}
                                </div>
                            </div>
                            <div class="feedback-col">
                                <div class="feedback-comment">${fb.comment || '<em>No comment</em>'}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function updateFeedbackStats(feedback) {
            const total = feedback.length;
            const positive = feedback.filter(fb => fb.feedback_type === 'positive').length;
            const negative = feedback.filter(fb => fb.feedback_type === 'negative').length;
            
            document.getElementById('totalFeedback').textContent = total;
            document.getElementById('positiveFeedback').textContent = positive;
            document.getElementById('negativeFeedback').textContent = negative;
        }
        
        async function loadFeedbackFilters() {
            try {
                // Load customers for filter
                const customersResponse = await fetch('/api/customers');
                if (customersResponse.ok) {
                    const customersData = await customersResponse.json();
                    const customerFilter = document.getElementById('customerFilter');
                    if (customerFilter && customersData.customers) {
                        customersData.customers.forEach(customer => {
                            const option = document.createElement('option');
                            option.value = customer.customer_id;
                            option.textContent = `${customer.customer_name} (${customer.customer_id})`;
                            customerFilter.appendChild(option);
                        });
                    }
                }
                
                // Load models for filter
                const modelsResponse = await fetch('/api/models');
                if (modelsResponse.ok) {
                    const modelsData = await modelsResponse.json();
                    const modelFilter = document.getElementById('modelFilter');
                    if (modelFilter && modelsData.models) {
                        const uniqueModels = {};
                        modelsData.models.forEach(model => {
                            if (!uniqueModels[model.id]) {
                                uniqueModels[model.id] = model.title;
                                const option = document.createElement('option');
                                option.value = model.id;
                                option.textContent = model.title;
                                modelFilter.appendChild(option);
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading feedback filters:', error);
            }
        }
        
        // User Management Functions - Moved to dedicated page
        
        function toggleUserModal() {
            document.getElementById('userModal').style.display = 'flex';
        }
        
        async function loadUsers() {
            const userList = document.getElementById('usersContainer');
            if (!userList) {
                console.error('usersContainer element not found');
                return;
            }
            userList.innerHTML = '<div class="loading-users" style="padding: 20px; text-align: center; color: #7d8590;">Loading users...</div>';
            
            try {
                const response = await fetch('/api/users');
                if (response.ok) {
                    const users = await response.json();
                    displayUsers(users);
                } else {
                    userList.innerHTML = '<div style="padding: 20px; text-align: center; color: #f85149;">Failed to load users</div>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                userList.innerHTML = '<div style="padding: 20px; text-align: center; color: #f85149;">Error loading users</div>';
            }
        }
        
        function displayUsers(users) {
            const userList = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                userList.innerHTML = '<div style="padding: 20px; text-align: center; color: #7d8590;">No users found</div>';
                return;
            }
            
            const userHTML = users.map(user => {
                const isAdmin = user.username === 'admin' || user.role === 'admin';
                return `
                    <div class="user-item">
                        <div class="user-item-content">
                            <div class="user-info">
                                <div class="user-name">${user.username}</div>
                                <div class="user-role-container">
                                    <span class="user-role">${user.role}</span>
                                    <button class="user-settings-btn" onclick="openUserEditModal('${user.id}', '${user.username}', '${user.role}', '${user.customer_id || ''}', '${user.customer_name || ''}', ${user.is_active}, ${isAdmin})" title="Manage User">
                                        
                                    </button>
                                </div>
                            </div>
                            ${user.total_views ? `<div class="user-views">Views: ${user.total_views}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            userList.innerHTML = userHTML;
        }
        
        // Global variables for user edit modal
        let currentEditUserId = null;
        let currentEditUserData = {};
        
        function openUserEditModal(userId, username, role, customerId, customerName, isActive, isAdmin) {
            currentEditUserId = userId;
            currentEditUserData = {
                username,
                role,
                customerId,
                customerName,
                isActive,
                isAdmin
            };
            
            // Update modal title
            document.getElementById('editModalTitle').textContent = ` Manage User: ${username}`;
            
            // Show/hide customer info section
            const customerSection = document.getElementById('customerInfoSection');
            if (role === 'customer') {
                customerSection.style.display = 'block';
                document.getElementById('editCustomerId').value = customerId || '';
                document.getElementById('editCustomerName').value = customerName || '';
            } else {
                customerSection.style.display = 'none';
            }
            
            // Update status button
            const statusBtn = document.getElementById('toggleStatusBtn');
            const protectedNote = document.getElementById('protectedUserNote');
            
            if (isAdmin) {
                statusBtn.style.display = 'none';
                protectedNote.style.display = 'block';
            } else {
                statusBtn.style.display = 'block';
                protectedNote.style.display = 'none';
                statusBtn.textContent = isActive ? 'Deactivate Account' : 'Activate Account';
                statusBtn.className = isActive ? 'modal-button danger' : 'modal-button primary';
            }
            
            // Clear password field
            document.getElementById('editNewPassword').value = '';
            
            // Show modal
            document.getElementById('userEditModal').style.display = 'flex';
        }
        
        function closeUserEditModal() {
            document.getElementById('userEditModal').style.display = 'none';
            currentEditUserId = null;
            currentEditUserData = {};
        }
        
        function resetUserPassword() {
            const chars = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('editNewPassword').value = password;
        }
        
        async function toggleUserStatus() {
            if (!currentEditUserId) return;
            
            const action = currentEditUserData.isActive ? 'deactivate' : 'activate';
            if (!confirm(`Are you sure you want to ${action} user "${currentEditUserData.username}"?`)) return;
            
            try {
                const response = await fetch(`/api/users/${currentEditUserId}/toggle`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    currentEditUserData.isActive = !currentEditUserData.isActive;
                    const statusBtn = document.getElementById('toggleStatusBtn');
                    statusBtn.textContent = currentEditUserData.isActive ? 'Deactivate Account' : 'Activate Account';
                    statusBtn.className = currentEditUserData.isActive ? 'modal-button danger' : 'modal-button primary';
                    
                    loadUsers(); // Refresh the list
                    alert(`User ${action}d successfully`);
                } else {
                    alert('Failed to update user status');
                }
            } catch (error) {
                console.error('Error updating user status:', error);
                alert('Error updating user status');
            }
        }
        
        async function saveUserChanges() {
            if (!currentEditUserId) return;
            
            const newPassword = document.getElementById('editNewPassword').value.trim();
            const customerId = document.getElementById('editCustomerId').value.trim();
            const customerName = document.getElementById('editCustomerName').value.trim();
            
            try {
                let hasChanges = false;
                
                // Update password if provided
                if (newPassword) {
                    const passwordResponse = await fetch(`/api/users/${currentEditUserId}/password`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: newPassword })
                    });
                    
                    if (!passwordResponse.ok) {
                        alert('Failed to update password');
                        return;
                    }
                    hasChanges = true;
                }
                
                // Update customer info if role is customer and fields have changed
                if (currentEditUserData.role === 'customer' && 
                    (customerId !== currentEditUserData.customerId || customerName !== currentEditUserData.customerName)) {
                    
                    const customerResponse = await fetch(`/api/users/${currentEditUserId}/customer`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            customerId: customerId || currentEditUserData.customerId,
                            customerName: customerName || currentEditUserData.customerName
                        })
                    });
                    
                    if (!customerResponse.ok) {
                        alert('Failed to update customer information');
                        return;
                    }
                    hasChanges = true;
                }
                
                if (hasChanges) {
                    alert('User updated successfully!');
                    loadUsers(); // Refresh the list
                    closeUserEditModal();
                } else {
                    alert('No changes made');
                    closeUserEditModal();
                }
                
            } catch (error) {
                console.error('Error saving user changes:', error);
                alert('Error saving changes');
            }
        }
        
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.parentElement.querySelector('.password-toggle-btn');
            const eyeIcon = button.querySelector('.eye-icon');
            const openPaths = eyeIcon.querySelectorAll('.eye-open');
            const closedPaths = eyeIcon.querySelectorAll('.eye-closed');
            
            if (input.type === 'password') {
                // Show password
                input.type = 'text';
                // Hide open eye, show closed eye
                openPaths.forEach(path => path.style.display = 'none');
                closedPaths.forEach(path => path.style.display = 'block');
            } else {
                // Hide password
                input.type = 'password';
                // Show open eye, hide closed eye
                openPaths.forEach(path => path.style.display = 'block');
                closedPaths.forEach(path => path.style.display = 'none');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                // Clear authentication tokens
                sessionStorage.removeItem('adminAuthenticated');
                localStorage.removeItem('user_role');
                localStorage.removeItem('username');
                localStorage.removeItem('customer_id');
                
                // Clear session and redirect to login
                fetch('/api/logout', { method: 'POST' })
                    .then(() => {
                        window.location.href = '/login.html';
                    })
                    .catch(() => {
                        // Even if logout API fails, redirect anyway
                        window.location.href = '/login.html';
                    });
            }
        }
        
        // Title editing functions (same as customer view)
        let currentEditElement = null;
        
        function startEditTitle(element) {
            if (currentEditElement) {
                cancelEdit();
            }
            
            currentEditElement = element;
            const currentTitle = element.textContent;
            
            element.innerHTML = `
                <input type="text" 
                       class="title-edit-input" 
                       value="${currentTitle}" 
                       onblur="saveTitle(this)"
                       onkeydown="handleTitleKeydown(event, this)"
                       style="
                           background: rgba(22, 27, 34, 0.8);
                           border: 1px solid rgba(88, 166, 255, 0.5);
                           border-radius: 4px;
                           color: #e6edf3;
                           padding: 4px 8px;
                           font-size: inherit;
                           font-weight: inherit;
                           width: 100%;
                           outline: none;
                       ">
            `;
            
            const input = element.querySelector('.title-edit-input');
            input.focus();
            input.select();
        }
        
        function handleTitleKeydown(event, input) {
            if (event.key === 'Enter') {
                saveTitle(input);
            } else if (event.key === 'Escape') {
                cancelEdit();
            }
        }
        
        async function saveTitle(input) {
            if (!currentEditElement) return;
            
            const newTitle = input.value.trim();
            const modelId = currentEditElement.getAttribute('data-model-id');
            
            if (!newTitle) {
                cancelEdit();
                return;
            }
            
            try {
                // Show loading state
                input.disabled = true;
                input.style.opacity = '0.7';
                
                // API call to update title
                const response = await fetch('/api/models', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: modelId,
                        title: newTitle
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to update title');
                }
                
                // Update the display
                currentEditElement.textContent = newTitle;
                console.log(`Updated model ${modelId} title to: ${newTitle}`);
                
                currentEditElement = null;
                
            } catch (error) {
                console.error('Error updating title:', error);
                alert('Failed to save title. Please try again.');
                cancelEdit();
            }
        }
        
        function cancelEdit() {
            if (currentEditElement) {
                const originalTitle = currentEditElement.getAttribute('data-original-title') || currentEditElement.textContent;
                currentEditElement.textContent = originalTitle;
                currentEditElement = null;
            }
        }

        // Product URL editing functions
        let currentEditUrlElement = null;

        function startEditProductUrl(element) {
            if (currentEditUrlElement) {
                cancelUrlEdit();
            }
            
            currentEditUrlElement = element;
            
            // Check if we're editing a variant URL (when a variant is selected)
            const isEditingVariant = element.getAttribute('data-editing-variant') === 'true';
            const variantId = element.getAttribute('data-variant-id');
            const modelId = element.getAttribute('data-model-id');
            
            if (isEditingVariant && variantId) {
                // Redirect to variant editing
                startEditVariantUrl(element);
                return;
            }
            const isEmptyState = element.getAttribute('data-empty') === 'true';
            
            // Store the original URL (if any) as a data attribute
            const originalUrl = isEmptyState ? '' : (element.getAttribute('data-url') || '');
            element.setAttribute('data-original-url', originalUrl);
            
            // Create a form container
            const formContainer = document.createElement('div');
            formContainer.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, rgba(22, 27, 34, 0.98), rgba(30, 35, 42, 0.98));
                border: 1px solid rgba(88, 166, 255, 0.3);
                border-radius: 12px;
                padding: 24px;
                z-index: 10000;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                min-width: 400px;
            `;
            
            formContainer.innerHTML = `
                <h3 style="color: #e6edf3; margin: 0 0 16px 0; font-size: 1.1rem;">
                    ${isEmptyState ? 'Add Product URL' : 'Edit Product URL'}
                </h3>
                <input type="url" 
                       id="productUrlEditInput"
                       data-model-id="${modelId}"
                       value="${originalUrl}" 
                       placeholder="https://example.com/product" 
                       style="
                           width: 100%;
                           background: rgba(240, 246, 252, 0.1);
                           border: 1px solid rgba(88, 166, 255, 0.5);
                           color: #e6edf3;
                           padding: 10px 14px;
                           border-radius: 8px;
                           font-size: 0.95rem;
                           outline: none;
                           font-family: inherit;
                           margin-bottom: 16px;
                       ">
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button onclick="cancelUrlEdit()" style="
                        padding: 8px 16px;
                        background: rgba(125, 133, 144, 0.2);
                        border: 1px solid rgba(125, 133, 144, 0.3);
                        color: #7d8590;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 0.9rem;
                    ">Cancel</button>
                    <button onclick="saveProductUrlFromInput()" style="
                        padding: 8px 16px;
                        background: rgba(88, 166, 255, 0.2);
                        border: 1px solid rgba(88, 166, 255, 0.5);
                        color: #58a6ff;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 0.9rem;
                    ">Save</button>
                </div>
            `;
            
            document.body.appendChild(formContainer);
            currentEditUrlElement.formContainer = formContainer;
            
            // Focus the input
            const input = document.getElementById('productUrlEditInput');
            input.focus();
            input.select();
            
            // Handle Enter key
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveProductUrlFromInput();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelUrlEdit();
                }
            });
        }
        
        function saveProductUrlFromInput() {
            const input = document.getElementById('productUrlEditInput');
            if (input) {
                saveProductUrl(input);
            }
        }
        
        function handleUrlKeydown(event, input) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveProductUrl(input);
            } else if (event.key === 'Escape') {
                event.preventDefault();
                cancelUrlEdit();
            }
        }
        
        async function saveProductUrl(input) {
            const newUrl = input.value.trim();
            
            // Get model ID from the input's data attribute (set when modal was created)
            const modelId = input.getAttribute('data-model-id');
            
            if (!modelId) {
                console.error('No model ID found');
                return;
            }
            
            // Store references before they might become null
            const buttonElement = currentEditUrlElement;
            const formContainer = currentEditUrlElement ? currentEditUrlElement.formContainer : null;
            
            if (!buttonElement) {
                console.error('No button element found');
                return;
            }
            
            try {
                const response = await fetch('/api/models', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: modelId,
                        product_url: newUrl
                    })
                });
                
                if (response.ok) {
                    // Update the button display using stored reference
                    if (newUrl) {
                        buttonElement.innerHTML = ' Edit URL';
                        buttonElement.removeAttribute('data-empty');
                        buttonElement.setAttribute('data-url', newUrl);
                    } else {
                        buttonElement.innerHTML = ' Add URL';
                        buttonElement.setAttribute('data-empty', 'true');
                        buttonElement.removeAttribute('data-url');
                    }
                    console.log(`Updated model ${modelId} product URL to: ${newUrl}`);
                    
                    // Clean up the form using stored reference
                    if (formContainer) {
                        formContainer.remove();
                    }
                    currentEditUrlElement = null;
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update product URL');
                }
                
            } catch (error) {
                console.error('Error updating product URL:', error);
                alert(`Failed to update product URL: ${error.message}`);
            }
        }
        
        function cancelUrlEdit() {
            if (currentEditUrlElement && currentEditUrlElement.formContainer) {
                // Simply remove the modal
                currentEditUrlElement.formContainer.remove();
                currentEditUrlElement = null;
            }
        }

        // Variant URL editing functions
        let currentEditVariantElement = null;

        function startEditVariantUrl(element) {
            if (currentEditVariantElement) {
                cancelVariantUrlEdit();
            }
            
            currentEditVariantElement = element;
            
            const variantId = element.getAttribute('data-variant-id');
            const isEmptyState = element.getAttribute('data-empty') === 'true';
            
            // Get the original URL - check if it's stored in data attribute or fetch from models data
            let originalUrl = element.getAttribute('data-url') || '';
            
            if (!originalUrl && !isEmptyState && window.currentModelsData) {
                // Try to find the variant's current URL from models data
                const modelId = element.getAttribute('data-model-id') || element.closest('.model-card')?.querySelector('.model-id')?.textContent;
                const model = window.currentModelsData.find(m => m.id === modelId);
                const variant = model?.variants?.find(v => v.id === variantId);
                if (variant?.product_url) {
                    originalUrl = variant.product_url;
                }
            }
            
            // Create modal for variant URL editing
            const formContainer = document.createElement('div');
            formContainer.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(13, 17, 23, 0.95);
                border: 1px solid rgba(240, 246, 252, 0.1);
                border-radius: 12px;
                padding: 24px;
                z-index: 10000;
                min-width: 400px;
                backdrop-filter: blur(10px);
            `;
            
            formContainer.innerHTML = `
                <h3 style="color: #e6edf3; margin: 0 0 16px 0; font-size: 1.1rem;">
                    ${isEmptyState ? 'Add Variant URL' : 'Edit Variant URL'}
                </h3>
                <input type="url" 
                       id="variantUrlEditInput"
                       data-variant-id="${variantId}"
                       value="${originalUrl}" 
                       placeholder="https://example.com/product-variant" 
                       style="
                           width: 100%;
                           background: rgba(240, 246, 252, 0.1);
                           border: 1px solid rgba(88, 166, 255, 0.5);
                           color: #e6edf3;
                           padding: 10px 14px;
                           border-radius: 8px;
                           font-size: 0.95rem;
                           outline: none;
                           font-family: inherit;
                           margin-bottom: 16px;
                       ">
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button onclick="cancelVariantUrlEdit()" style="
                        padding: 8px 16px;
                        background: rgba(125, 133, 144, 0.2);
                        border: 1px solid rgba(125, 133, 144, 0.3);
                        color: #7d8590;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 0.9rem;
                    ">Cancel</button>
                    <button onclick="saveVariantUrlFromInput()" style="
                        padding: 8px 16px;
                        background: rgba(88, 166, 255, 0.2);
                        border: 1px solid rgba(88, 166, 255, 0.5);
                        color: #58a6ff;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 0.9rem;
                    ">Save</button>
                </div>
            `;
            
            document.body.appendChild(formContainer);
            currentEditVariantElement.formContainer = formContainer;
            
            const input = document.getElementById('variantUrlEditInput');
            input.focus();
            input.select();
        }

        function saveVariantUrlFromInput() {
            const input = document.getElementById('variantUrlEditInput');
            if (input) {
                saveVariantUrl(input);
            }
        }

        async function saveVariantUrl(input) {
            const newUrl = input.value.trim();
            const variantId = input.getAttribute('data-variant-id');
            
            if (!variantId) {
                console.error('No variant ID found');
                return;
            }
            
            const buttonElement = currentEditVariantElement;
            const formContainer = currentEditVariantElement ? currentEditVariantElement.formContainer : null;
            
            if (!buttonElement) {
                console.error('No button element found');
                return;
            }
            
            try {
                const response = await fetch('/api/variants', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: variantId,
                        product_url: newUrl
                    })
                });
                
                if (response.ok) {
                    // Update the button display
                    if (newUrl) {
                        buttonElement.innerHTML = '';
                        buttonElement.removeAttribute('data-empty');
                        buttonElement.setAttribute('data-url', newUrl);
                    } else {
                        buttonElement.innerHTML = '';
                        buttonElement.setAttribute('data-empty', 'true');
                        buttonElement.removeAttribute('data-url');
                    }
                    console.log(`Updated variant ${variantId} product URL to: ${newUrl}`);
                    
                    // Clean up the form
                    if (formContainer) {
                        formContainer.remove();
                    }
                    currentEditVariantElement = null;
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update variant URL');
                }
            } catch (error) {
                console.error('Error updating variant URL:', error);
                alert(`Failed to update variant URL: ${error.message}`);
            }
        }

        function cancelVariantUrlEdit() {
            if (currentEditVariantElement && currentEditVariantElement.formContainer) {
                currentEditVariantElement.formContainer.remove();
                currentEditVariantElement = null;
            }
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            document.getElementById('userForm').reset();
            document.getElementById('customerFields').style.display = 'none';
        }

        // Show/hide customer fields based on role selection
        document.getElementById('newRole').addEventListener('change', function() {
            const customerFields = document.getElementById('customerFields');
            if (this.value === 'customer') {
                customerFields.style.display = 'block';
                document.getElementById('newCustomerId').required = true;
                document.getElementById('newCustomerName').required = true;
            } else {
                customerFields.style.display = 'none';
                document.getElementById('newCustomerId').required = false;
                document.getElementById('newCustomerName').required = false;
            }
        });

        // Handle user creation form submission
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const button = document.getElementById('createUserButton');
            const buttonText = button.querySelector('.button-text');
            
            // Get form data
            const formData = new FormData(e.target);
            const userData = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                role: document.getElementById('newRole').value
            };

            // Add customer fields if role is customer
            if (userData.role === 'customer') {
                userData.customerId = document.getElementById('newCustomerId').value;
                userData.customerName = document.getElementById('newCustomerName').value;
            }

            // Show loading state
            button.disabled = true;
            buttonText.textContent = 'Creating User...';

            try {
                const response = await fetch('/api/create-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`User "${userData.username}" created successfully!\n\nLogin credentials:\nUsername: ${userData.username}\nPassword: ${userData.password}\nRole: ${userData.role}${userData.role === 'customer' ? `\nCustomer: ${userData.customerName}` : ''}`);
                    closeUserModal();
                    
                    // If creating a customer, immediately add to universal customer manager
                    if (userData.role === 'customer' && userData.customerId && userData.customerName) {
                        customerManager.setCustomer({
                            id: userData.customerId,
                            name: userData.customerName,
                            count: 0
                        });
                        console.log(' Customer added to universal system:', userData.customerName);
                    }
                    
                    // Refresh all customer-related UI
                    await customerManager.loadFromAPI();
                } else {
                    alert('Failed to create user: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Error creating user: ' + error.message);
            } finally {
                // Reset button state
                button.disabled = false;
                buttonText.textContent = 'Create User';
            }
        });

        // Variant Modal Functions
        let currentModelId = null;

        function openVariantModal(modelId, title) {
            currentModelId = modelId;
            document.getElementById('variantModal').style.display = 'flex';
            document.getElementById('variantModalTitle').textContent = 'Add Variant';
        }

        function closeVariantModal() {
            document.getElementById('variantModal').style.display = 'none';
            document.getElementById('variantForm').reset();
            document.getElementById('variantFileName').style.display = 'none';
            document.getElementById('variantProductUrl').value = ''; // Clear product URL
            // Reset upload area appearance
            const uploadArea = document.getElementById('fileUploadArea');
            uploadArea.style.borderColor = 'rgba(88, 166, 255, 0.3)';
            uploadArea.style.background = 'rgba(13, 17, 23, 0.5)';
            // Variant type is always upload now
            currentModelId = null;
        }

        // Variant type selection removed - always upload GLB files now

        function updateVariantFileName() {
            const fileInput = document.getElementById('variantFile');
            const fileName = document.getElementById('variantFileName');
            const uploadArea = document.getElementById('fileUploadArea');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileName.style.display = 'block';
                
                // Validate file type
                if (!file.name.match(/\.(glb|gltf)$/i)) {
                    fileName.textContent = ' Invalid file type (GLB/GLTF only)';
                    fileName.style.background = 'rgba(248, 81, 73, 0.1)';
                    fileName.style.borderColor = 'rgba(248, 81, 73, 0.3)';
                    fileName.style.color = '#f85149';
                } else if (file.size > 100 * 1024 * 1024) {
                    fileName.textContent = ' File too large (max 100MB)';
                    fileName.style.background = 'rgba(248, 81, 73, 0.1)';
                    fileName.style.borderColor = 'rgba(248, 81, 73, 0.3)';
                    fileName.style.color = '#f85149';
                } else {
                    fileName.textContent = ` ${file.name} (${(file.size / (1024 * 1024)).toFixed(1)} MB)`;
                    fileName.style.background = 'rgba(88, 166, 255, 0.1)';
                    fileName.style.borderColor = 'rgba(88, 166, 255, 0.3)';
                    fileName.style.color = '#58a6ff';
                    
                    // Auto-fill variant name from filename (without extension)
                    const variantNameInput = document.getElementById('variantName');
                    if (!variantNameInput.value.trim()) {
                        const nameWithoutExtension = file.name.replace(/\.(glb|gltf)$/i, '');
                        variantNameInput.value = nameWithoutExtension;
                        variantNameInput.placeholder = nameWithoutExtension;
                    }
                    
                    // Auto-upload the variant immediately after file selection
                    setTimeout(() => {
                        uploadVariantFile(file, variantNameInput.value || nameWithoutExtension);
                    }, 500); // Small delay to let UI update
                }
                
                // Update upload area appearance
                uploadArea.style.borderColor = 'rgba(88, 166, 255, 0.6)';
                uploadArea.style.background = 'rgba(88, 166, 255, 0.05)';
            } else {
                fileName.style.display = 'none';
                // Reset upload area
                uploadArea.style.borderColor = 'rgba(88, 166, 255, 0.3)';
                uploadArea.style.background = 'rgba(13, 17, 23, 0.5)';
            }
        }

        // Auto-upload function for variants - DIRECT CLOUDINARY UPLOAD
        async function uploadVariantFile(file, variantName) {
            // Capture the modelId early to ensure we have it
            const modelId = currentModelId;
            console.log(' Direct variant upload starting - modelId:', modelId);

            if (!modelId) {
                alert('Error: No model selected');
                return;
            }

            if (!file || !variantName.trim()) {
                console.error('Missing file or variant name');
                return;
            }

            // Update UI to show upload progress
            const fileName = document.getElementById('variantFileName');
            const hexColor = '#000000'; // Default color

            // Show file size for debugging
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            console.log(` Starting direct variant upload: ${fileSizeMB}MB`);

            try {
                // Step 1: Upload directly to Cloudinary (unsigned upload)
                fileName.textContent = `Uploading ${fileSizeMB}MB to Cloudinary...`;
                fileName.style.color = '#f1c40f';

                const cloudinaryFormData = new FormData();
                cloudinaryFormData.append('file', file);
                cloudinaryFormData.append('upload_preset', 'furniture_unsigned');
                cloudinaryFormData.append('folder', 'furniture-models');

                const cloudinaryUpload = await fetch(
                    'https://api.cloudinary.com/v1_1/djjixqxzy/raw/upload',
                    {
                        method: 'POST',
                        body: cloudinaryFormData
                    }
                );

                if (!cloudinaryUpload.ok) {
                    const errorText = await cloudinaryUpload.text();
                    throw new Error(`Cloudinary upload failed: ${errorText}`);
                }

                const cloudinaryResult = await cloudinaryUpload.json();
                console.log(' Variant Cloudinary upload successful:', cloudinaryResult);

                // Step 3: Save variant metadata to database
                fileName.textContent = 'Saving variant...';
                fileName.style.color = '#58a6ff';

                // Get variant product URL from form
                const variantProductUrl = document.getElementById('variantProductUrl').value.trim();

                const requestData = {
                    cloudinaryUrl: cloudinaryResult.secure_url,
                    cloudinaryPublicId: cloudinaryResult.public_id,
                    fileSize: cloudinaryResult.bytes,
                    parentModelId: modelId,
                    variantName: variantName,
                    hexColor: hexColor,
                    isVariant: true,
                    variantProductUrl: variantProductUrl || null
                };

                console.log(' Sending variant save request:', requestData);

                const saveResponse = await fetch('/api/cloudinary-save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!saveResponse.ok) {
                    const errorText = await saveResponse.text();
                    console.error(' Save variant error response:', errorText);
                    throw new Error(`Failed to save variant metadata: ${errorText}`);
                }

                const result = await saveResponse.json();

                console.log(' Variant uploaded successfully via direct Cloudinary upload:', result);

                // Update UI to show success
                fileName.textContent = ' Variant uploaded!';
                fileName.style.color = '#27ae60';

                // No popup alert - just close modal and reload
                closeVariantModal();

                // Extract and save dominant color for the new variant AFTER page reload
                if (result.success && result.id) {
                    // Store the variant ID for color extraction after reload
                    console.log(' Storing color extraction data:', { variantId: result.id, modelId: modelId });
                    sessionStorage.setItem('extractColorForVariant', JSON.stringify({
                        variantId: result.id,
                        modelId: modelId
                    }));
                }
                
                // Reload after a delay to allow debug info to be seen
                console.log(' Reloading in 5 seconds to show debug info...');
                setTimeout(() => {
                    location.reload();
                }, 5000);
                
            } catch (error) {
                console.error(' Direct variant upload failed:', error);

                // Show error in filename area
                fileName.textContent = ` Upload failed: ${error.message}`;
                fileName.style.color = '#f85149';
            }
        }

        // Keep the form submission handler for backwards compatibility (but it won't be used)
        document.getElementById('variantForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Auto-upload is now handled in updateVariantFileName()
            console.log('Form submission prevented - using auto-upload instead');
        });

        // Convert hex color to RGBA array (0-1 range) for model-viewer
        function hexToRGBA(hex) {
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            return [r, g, b, 1.0];
        }
        
        // Extract dominant color from rendered GLB using model-viewer screenshot
        async function extractDominantColor(modelViewer) {
            try {
                console.log(' Starting color extraction for model-viewer...');
                
                // Use model-viewer's toDataURL method to get a screenshot
                const dataURL = await modelViewer.toDataURL('image/png', 0.9);
                console.log(' Screenshot captured, analyzing pixels...');
                
                // Create an image and canvas to analyze pixels
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Set canvas size to sample area
                        const sampleSize = 150;
                        canvas.width = sampleSize;
                        canvas.height = sampleSize;
                        
                        // Draw the image scaled down to sample size
                        ctx.drawImage(img, 0, 0, sampleSize, sampleSize);
                        
                        // Get pixel data from center area (avoid background)
                        const centerSize = 100;
                        const centerOffset = (sampleSize - centerSize) / 2;
                        const imageData = ctx.getImageData(centerOffset, centerOffset, centerSize, centerSize);
                        const pixels = imageData.data;
                        
                        console.log(` Analyzing ${pixels.length / 4} pixels from center area...`);
                        
                        // Calculate dominant color with more lenient filtering
                        const colorCounts = {};
                        const threshold = 20; // Group similar colors (increased for better grouping)
                        let totalValidPixels = 0;
                        
                        for (let i = 0; i < pixels.length; i += 4) {
                            const r = pixels[i];
                            const g = pixels[i + 1];
                            const b = pixels[i + 2];
                            const a = pixels[i + 3];
                            
                            // More lenient filtering - accept more pixels
                            // Skip only fully transparent or pure black/white pixels
                            if (a < 100) continue; // Less strict alpha filtering
                            
                            const brightness = (r + g + b) / 3;
                            // Skip only very dark (< 30) or very bright (> 225) pixels
                            if (brightness < 30 || brightness > 225) continue;
                            
                            totalValidPixels++;
                            
                            // Group similar colors to find dominant shade
                            const groupedR = Math.floor(r / threshold) * threshold;
                            const groupedG = Math.floor(g / threshold) * threshold;
                            const groupedB = Math.floor(b / threshold) * threshold;
                            
                            const colorKey = `${groupedR},${groupedG},${groupedB}`;
                            colorCounts[colorKey] = (colorCounts[colorKey] || 0) + 1;
                        }
                        
                        console.log(` Found ${totalValidPixels} valid pixels in ${Object.keys(colorCounts).length} color groups`);
                        
                        // Debug: Log top 5 colors
                        const sortedColors = Object.entries(colorCounts)
                            .sort(([,a], [,b]) => b - a)
                            .slice(0, 5);
                        
                        console.log(' Top colors found:', sortedColors.map(([color, count]) => {
                            const [r, g, b] = color.split(',').map(Number);
                            const hex = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
                            return `${hex} (${count} pixels)`;
                        }));
                        
                        // Find the most common color
                        let dominantColor = '#6b7280';
                        let maxCount = 0;
                        
                        for (const [colorKey, count] of Object.entries(colorCounts)) {
                            if (count > maxCount) {
                                maxCount = count;
                                const [r, g, b] = colorKey.split(',').map(Number);
                                const hexR = Math.max(0, Math.min(255, r)).toString(16).padStart(2, '0');
                                const hexG = Math.max(0, Math.min(255, g)).toString(16).padStart(2, '0');
                                const hexB = Math.max(0, Math.min(255, b)).toString(16).padStart(2, '0');
                                dominantColor = `#${hexR}${hexG}${hexB}`;
                            }
                        }
                        
                        console.log(' Final dominant color:', dominantColor, `(${maxCount} pixels, ${(maxCount/totalValidPixels*100).toFixed(1)}%)`);
                        
                        // If we didn't find enough valid pixels, return a neutral color
                        if (totalValidPixels < 10) {
                            console.warn(' Not enough valid pixels found, using fallback color');
                            dominantColor = '#8b9198'; // Slightly warmer gray
                        }
                        
                        resolve(dominantColor);
                    };
                    
                    img.onerror = () => {
                        console.warn(' Failed to load model screenshot');
                        resolve('#6b7280');
                    };
                    
                    img.src = dataURL;
                });
                
            } catch (error) {
                console.warn(' Failed to extract visual dominant color:', error);
                return '#6b7280'; // Fallback gray
            }
        }
        
        function rgbToHsl(r, g, b) {
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [h, s, l];
        }
        
        function hslToRgb(h, s, l) {
            let r, g, b;
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            return [r, g, b];
        }
        
        function intelligentColorRemap(originalRgba, targetRgba) {
            const [or, og, ob] = originalRgba;
            const [tr, tg, tb] = targetRgba;
            
            // Convert to HSL for better color manipulation
            const [oh, os, ol] = rgbToHsl(or, og, ob);
            const [th, ts, tl] = rgbToHsl(tr, tg, tb);
            
            // Preserve original lightness and saturation characteristics
            // but shift the hue towards the target color
            const newH = th; // Use target hue
            const newS = Math.max(os * 0.7, ts * 0.5); // Blend saturation
            const newL = ol * (tl / 0.5); // Adjust lightness proportionally
            
            const [newR, newG, newB] = hslToRgb(newH, Math.min(newS, 1), Math.min(newL, 1));
            return [newR, newG, newB, originalRgba[3]];
        }
        
        function detectMaterialType(material) {
            // Analyze PBR properties to determine material type
            const pbr = material.pbrMetallicRoughness;
            if (!pbr) return 'unknown';
            
            const baseColor = pbr.baseColorFactor || [1, 1, 1, 1];
            const roughness = pbr.roughnessFactor || 1.0;
            const metallic = pbr.metallicFactor || 0.0;
            
            // Calculate material brightness
            const brightness = (baseColor[0] + baseColor[1] + baseColor[2]) / 3;
            
            // Wood detection: Low metallic, medium-high roughness, brownish tones
            const isWoodish = (
                metallic < 0.1 && // Wood is non-metallic
                roughness > 0.6 && // Wood is rougher
                (baseColor[0] > baseColor[2] || baseColor[1] > baseColor[2]) // Wood tends to be warmer (more red/yellow than blue)
            );
            
            // Fabric detection: Low metallic, high roughness, varied colors
            const isFabric = (
                metallic < 0.1 && // Fabric is non-metallic
                roughness > 0.7 && // Fabric is very rough
                brightness > 0.3 && // Not too dark (unlike leather)
                !isWoodish // Not wood
            );
            
            // Metal detection: High metallic
            const isMetal = metallic > 0.8;
            
            // Leather detection: Low metallic, medium roughness, darker colors
            const isLeather = (
                metallic < 0.1 &&
                roughness > 0.5 && roughness < 0.8 &&
                brightness < 0.4 // Leather tends to be darker
            );
            
            if (isMetal) return 'metal';
            if (isWoodish) return 'wood';
            if (isFabric) return 'fabric';
            if (isLeather) return 'leather';
            
            return 'unknown';
        }
        
        function shouldColorMaterial(materialType) {
            // Only color fabric-like materials, leave wood/metal/leather unchanged
            return materialType === 'fabric';
        }

        // Image Management Functions - Moved to dedicated page
        
        function showImageUploadModal() {
            document.getElementById('imageUploadModal').style.display = 'flex';
        }
        
        function closeImageUploadModal() {
            document.getElementById('imageUploadModal').style.display = 'none';
            document.getElementById('imageUploadForm').reset();
            document.getElementById('imageFileName').style.display = 'none';
            const uploadArea = document.getElementById('imageFileUploadArea');
            uploadArea.style.borderColor = 'rgba(88, 166, 255, 0.3)';
            uploadArea.style.background = 'rgba(13, 17, 23, 0.5)';
        }
        
        // Furniture Settings Modal Functions
        let currentSettingsModel = null;
        
        function openFurnitureSettingsModal(model) {
            currentSettingsModel = model;
            
            // Update modal title
            document.getElementById('settingsModalTitle').textContent = 
                ` Furniture Settings - ${model.title}`;
            
            // Update Product URL section
            const editUrlButton = document.getElementById('editUrlButton');
            const productUrlDesc = document.getElementById('productUrlDesc');
            if (model.product_url) {
                productUrlDesc.textContent = `Current URL: ${model.product_url}`;
                editUrlButton.textContent = 'Edit';
            } else {
                productUrlDesc.textContent = 'Add a product page URL';
                editUrlButton.textContent = 'Add';
            }
            
            // Update Assignment section
            const assignmentDesc = document.getElementById('assignmentDesc');
            const assignButton = document.getElementById('assignButton');
            if (model.customer_name) {
                assignmentDesc.textContent = `Assigned to ${model.customer_name}`;
                assignButton.textContent = 'Change';
            } else {
                assignmentDesc.textContent = 'Not assigned to any customer';
                assignButton.textContent = 'Assign';
            }
            
            // Update Variants section
            const manageVariantsAction = document.getElementById('manageVariantsAction');
            const variantCountDesc = document.getElementById('variantCountDesc');
            if (model.variants && model.variants.length > 0) {
                const variantCount = model.variants.length;
                variantCountDesc.textContent = `${variantCount} variant${variantCount === 1 ? '' : 's'} available`;
                manageVariantsAction.style.display = 'block';
            } else {
                manageVariantsAction.style.display = 'none';
            }
            
            // Show modal
            document.getElementById('furnitureSettingsModal').style.display = 'flex';
        }
        
        function closeFurnitureSettingsModal() {
            document.getElementById('furnitureSettingsModal').style.display = 'none';
            currentSettingsModel = null;
        }
        
        // Settings Modal Action Handlers
        function handleEditUrl() {
            if (!currentSettingsModel) return;
            closeFurnitureSettingsModal();

            // Create a mock element with the required attributes
            const mockElement = {
                getAttribute: function(attr) {
                    if (attr === 'data-model-id') return currentSettingsModel.id;
                    if (attr === 'data-empty') return currentSettingsModel.product_url ? 'false' : 'true';
                    if (attr === 'data-url') return currentSettingsModel.product_url || '';
                    if (attr === 'data-editing-variant') return 'false';
                    if (attr === 'data-variant-id') return null;
                    return null;
                },
                setAttribute: function(attr, value) {
                    // Mock setAttribute for the function
                }
            };

            // Call the existing product URL edit function
            startEditProductUrl(mockElement);
        }
        
        function handleCopyLink() {
            if (!currentSettingsModel) return;
            const viewUrl = `${window.location.origin}/view?id=${currentSettingsModel.id}`;
            copyToClipboard(viewUrl, document.getElementById('copyLinkButton'));
        }
        
        function handleAssignCustomer() {
            if (!currentSettingsModel) return;
            closeFurnitureSettingsModal();

            // Create a modal-style customer selection UI
            const assignModal = document.createElement('div');
            assignModal.className = 'password-modal';
            assignModal.style.display = 'flex';
            assignModal.innerHTML = `
                <div class="modal-content futuristic-upload" style="max-width: 400px;">
                    <div class="upload-header">
                        <h3 class="upload-title"> Assign to Customer</h3>
                        <p class="upload-subtitle">Select customer for "${currentSettingsModel.title}"</p>
                    </div>

                    <div id="customerSelectionList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Customer options will be populated here -->
                    </div>

                    <div class="modal-buttons" style="margin-top: 20px;">
                        <button type="button" class="modal-button secondary" onclick="closeAssignModal()">Cancel</button>
                        <button type="button" class="modal-button primary" onclick="assignToNewCustomerFromModal()">Add New Customer</button>
                    </div>
                </div>
            `;

            document.body.appendChild(assignModal);

            // Populate customer list
            const customerList = assignModal.querySelector('#customerSelectionList');
            const customers = customerManager.getAllCustomers();

            if (customers.length === 0) {
                customerList.innerHTML = '<div style="color: #7d8590; text-align: center; padding: 20px;">No customers available</div>';
            } else {
                customers.forEach(customer => {
                    const isSelected = currentSettingsModel.customer_id === customer.id;
                    const customerOption = document.createElement('div');
                    customerOption.className = 'customer-option';
                    customerOption.style.cssText = `
                        padding: 12px 16px;
                        border: 1px solid ${isSelected ? '#58a6ff' : 'rgba(240, 246, 252, 0.1)'};
                        border-radius: 8px;
                        margin-bottom: 8px;
                        cursor: pointer;
                        background: ${isSelected ? 'rgba(88, 166, 255, 0.1)' : 'rgba(240, 246, 252, 0.05)'};
                        transition: all 0.2s ease;
                    `;
                    customerOption.innerHTML = `
                        <div style="font-weight: 500; color: #e6edf3; margin-bottom: 4px;">${customer.name}</div>
                        <div style="font-size: 12px; color: #7d8590;">ID: ${customer.id}</div>
                        ${isSelected ? '<div style="color: #58a6ff; font-size: 12px; margin-top: 4px;"> Currently assigned</div>' : ''}
                    `;

                    customerOption.addEventListener('click', () => window.assignCustomerFromModal(customer.id, customer.name));
                    customerList.appendChild(customerOption);
                });
            }

            // Add global functions for modal actions
            window.closeAssignModal = function() {
                assignModal.remove();
                delete window.closeAssignModal;
                delete window.assignToNewCustomerFromModal;
                delete window.assignCustomerFromModal;
            };

            window.assignToNewCustomerFromModal = function() {
                const customerName = prompt('Enter new customer name:');
                if (!customerName?.trim()) return;

                const customerId = customerName.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');

                // Check if already exists
                if (customerManager.hasCustomer(customerId)) {
                    alert('Customer already exists!');
                    return;
                }

                // Add to customer manager
                customerManager.addCustomer(customerId, customerName);
                window.closeAssignModal();
                assignFurnitureToCustomer(currentSettingsModel.id, customerId, customerName);
            };

            window.assignCustomerFromModal = function(customerId, customerName) {
                window.closeAssignModal();
                assignFurnitureToCustomer(currentSettingsModel.id, customerId, customerName);
            };
        }
        
        function handleAddVariant() {
            if (!currentSettingsModel) return;
            // Store model data before closing modal (which sets currentSettingsModel to null)
            const modelId = currentSettingsModel.id;
            const modelTitle = currentSettingsModel.title;
            closeFurnitureSettingsModal();
            openVariantModal(modelId, modelTitle);
        }
        
        function handleManageVariants() {
            if (!currentSettingsModel) return;
            closeFurnitureSettingsModal();

            // Create variant management modal
            const variantModal = document.createElement('div');
            variantModal.className = 'password-modal';
            variantModal.style.display = 'flex';
            variantModal.innerHTML = `
                <div class="modal-content futuristic-upload" style="max-width: 600px;">
                    <div class="upload-header">
                        <h3 class="upload-title"> Manage Variants</h3>
                        <p class="upload-subtitle">Manage color and texture variants for "${currentSettingsModel.title}"</p>
                    </div>

                    <div class="variants-management-section">
                        <!-- Original/Main Variant -->
                        <div class="variant-item" style="padding: 16px; border: 1px solid rgba(240, 246, 252, 0.1); border-radius: 8px; margin-bottom: 12px; background: rgba(240, 246, 252, 0.05);">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="variant-circle"
                                     style="width: 40px; height: 40px; border-radius: 50%; background: ${currentSettingsModel.dominant_color || '#6b7280'}; border: 2px solid rgba(240, 246, 252, 0.2);">
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #e6edf3;">Original</div>
                                    <div style="font-size: 12px; color: #7d8590;">Main model color</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="modal-button secondary" style="padding: 6px 12px; font-size: 12px;" onclick="switchToVariantFromModal('${currentSettingsModel.id}', 'original', '${currentSettingsModel.cloudinary_url}')">
                                         View
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Variants -->
                        <div id="additionalVariants">
                            <!-- Variants will be populated here -->
                        </div>
                    </div>

                    <div class="modal-buttons" style="margin-top: 20px;">
                        <button type="button" class="modal-button secondary" onclick="closeVariantManagementModal()">Close</button>
                        <button type="button" class="modal-button primary" onclick="addNewVariantFromModal()">+ Add Variant</button>
                    </div>
                </div>
            `;

            document.body.appendChild(variantModal);

            // Populate additional variants
            const additionalVariantsContainer = variantModal.querySelector('#additionalVariants');
            if (currentSettingsModel.variants && currentSettingsModel.variants.length > 0) {
                currentSettingsModel.variants.forEach(variant => {
                    const variantItem = document.createElement('div');
                    variantItem.className = 'variant-item';
                    variantItem.style.cssText = `
                        padding: 16px;
                        border: 1px solid rgba(240, 246, 252, 0.1);
                        border-radius: 8px;
                        margin-bottom: 12px;
                        background: rgba(240, 246, 252, 0.05);
                    `;
                    variantItem.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="variant-circle"
                                 style="width: 40px; height: 40px; border-radius: 50%; background: ${variant.hex_color}; border: 2px solid rgba(240, 246, 252, 0.2);">
                                ${variant.is_primary ? '' : ''}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500; color: #e6edf3;">${variant.variant_name}</div>
                                <div style="font-size: 12px; color: #7d8590;">${variant.variant_type || 'Upload'} variant</div>
                                ${variant.product_url ? `<div style="font-size: 11px; color: #58a6ff; margin-top: 2px;"> Has product URL</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="modal-button secondary" style="padding: 6px 12px; font-size: 12px;" onclick="switchToVariantFromModal('${currentSettingsModel.id}', '${variant.id}', '${variant.cloudinary_url}', '${variant.hex_color}', '${variant.variant_type || 'upload'}')">
                                     View
                                </button>
                                <button class="modal-button danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteVariantFromModal('${variant.id}', '${currentSettingsModel.id}')">
                                     Delete
                                </button>
                            </div>
                        </div>
                    `;
                    additionalVariantsContainer.appendChild(variantItem);
                });
            } else {
                additionalVariantsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #7d8590;">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <div style="font-size: 16px; margin-bottom: 8px;">No variants yet</div>
                        <div style="font-size: 14px;">Add color or texture variants to give customers more options</div>
                    </div>
                `;
            }

            // Add global functions for modal actions
            window.closeVariantManagementModal = function() {
                variantModal.remove();
                delete window.closeVariantManagementModal;
                delete window.addNewVariantFromModal;
                delete window.switchToVariantFromModal;
                delete window.deleteVariantFromModal;
            };

            window.addNewVariantFromModal = function() {
                window.closeVariantManagementModal();
                openVariantModal(currentSettingsModel.id, currentSettingsModel.title);
            };

            window.switchToVariantFromModal = function(modelId, variantId, cloudinaryUrl, hexColor, variantType) {
                window.closeVariantManagementModal();
                switchToVariant(modelId, variantId, cloudinaryUrl, hexColor, variantType);
            };

            window.deleteVariantFromModal = function(variantId, modelId) {
                if (confirm('Are you sure you want to delete this variant?')) {
                    // Create a mock event object
                    const mockEvent = {
                        stopPropagation: function() {}
                    };
                    deleteVariant(variantId, modelId, mockEvent);
                    window.closeVariantManagementModal();
                }
            };
        }
        
        function handleDeleteFurniture() {
            if (!currentSettingsModel) return;
            closeFurnitureSettingsModal();
            deleteModel(currentSettingsModel.id, currentSettingsModel.cloudinary_public_id);
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const settingsModal = document.getElementById('furnitureSettingsModal');
            if (event.target === settingsModal) {
                closeFurnitureSettingsModal();
            }
        });
        
        async function updateImageFileName() {
            const fileInput = document.getElementById('imageFile');
            const fileName = document.getElementById('imageFileName');
            const uploadArea = document.getElementById('imageFileUploadArea');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileName.style.display = 'block';
                
                // Validate file type
                if (!file.name.match(/\.(jpg|jpeg|png|webp|svg)$/i)) {
                    fileName.textContent = ' Invalid file type';
                    fileName.style.background = 'rgba(248, 81, 73, 0.1)';
                    fileName.style.borderColor = 'rgba(248, 81, 73, 0.3)';
                    fileName.style.color = '#f85149';
                    return;
                } else if (file.size > 10 * 1024 * 1024) {
                    fileName.textContent = ' File too large (max 10MB)';
                    fileName.style.background = 'rgba(248, 81, 73, 0.1)';
                    fileName.style.borderColor = 'rgba(248, 81, 73, 0.3)';
                    fileName.style.color = '#f85149';
                    return;
                } else {
                    fileName.textContent = ` Uploading ${file.name}...`;
                    fileName.style.background = 'rgba(88, 166, 255, 0.1)';
                    fileName.style.borderColor = 'rgba(88, 166, 255, 0.3)';
                    fileName.style.color = '#58a6ff';
                }
                
                uploadArea.style.borderColor = 'rgba(88, 166, 255, 0.6)';
                uploadArea.style.background = 'rgba(88, 166, 255, 0.05)';
                
                // Auto-upload the file
                await uploadImageFile();
            } else {
                fileName.style.display = 'none';
                uploadArea.style.borderColor = 'rgba(88, 166, 255, 0.3)';
                uploadArea.style.background = 'rgba(13, 17, 23, 0.5)';
            }
        }
        
        async function uploadImageFile() {
            const fileInput = document.getElementById('imageFile');
            const imageType = document.getElementById('imageType').value;
            const fileName = document.getElementById('imageFileName');
            
            if (!fileInput.files.length) return;
            
            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('imageType', imageType);
                
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    fileName.textContent = ` Uploaded successfully!`;
                    setTimeout(() => {
                        closeImageUploadModal();
                        loadImages();
                    }, 1500);
                } else {
                    fileName.textContent = ` Upload couldn't complete. Please try again.`;
                    fileName.style.color = '#f85149';
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                fileName.textContent = ` Upload error: ${error.message}`;
                fileName.style.color = '#f85149';
            }
        }
        
        // Old image functions removed - now handled by dedicated Images page
        
        // Prevent form submission since we're auto-uploading
        document.getElementById('imageUploadForm').addEventListener('submit', (e) => {
            e.preventDefault();
        });
        
        // Switch to variant function (handles both upload and color variants)
        function switchToVariant(modelId, variantId, variantUrl, hexColor = null, variantType = 'upload') {
            console.log('Switching to variant:', { modelId, variantId, variantUrl, hexColor, variantType });
            
            // Find the model-viewer element for this model
            const modelCards = document.querySelectorAll('.model-card');
            modelCards.forEach(card => {
                const modelViewer = card.querySelector('model-viewer');
                const hiddenModelId = card.querySelector('.model-id');
                
                if (hiddenModelId && hiddenModelId.textContent === modelId) {
                    // All variants are GLB file variants now - no color changing
                    console.log('Loading GLB variant:', variantUrl);
                    modelViewer.src = variantUrl;
                    
                    // Update the copy link URL to include variant parameter
                    updateCopyLinkUrl(card, modelId, variantId);
                    
                    // Update the main product URL button state based on selected variant
                    updateProductUrlButton(card, modelId, variantId);
                }
            });
        }
        
        function updateProductUrlButton(card, modelId, variantId) {
            const productUrlButton = card.querySelector('.product-url-action');
            if (!productUrlButton) return;
            
            // Get the current models data to find the variant info
            const modelsData = window.currentModelsData || [];
            const model = modelsData.find(m => m.id === modelId);
            if (!model) return;
            
            if (variantId === 'original') {
                // Switching to original - use model's product_url
                if (model.product_url) {
                    productUrlButton.innerHTML = ' Edit URL';
                    productUrlButton.removeAttribute('data-empty');
                } else {
                    productUrlButton.innerHTML = ' Add URL';
                    productUrlButton.setAttribute('data-empty', 'true');
                }
                // Clear variant attributes when switching back to original
                productUrlButton.removeAttribute('data-variant-id');
                productUrlButton.removeAttribute('data-editing-variant');
            } else {
                // Switching to a variant - find the variant's product_url
                const variant = model.variants?.find(v => v.id === variantId);
                if (variant) {
                    if (variant.product_url) {
                        productUrlButton.innerHTML = ' Edit Variant URL';
                        productUrlButton.removeAttribute('data-empty');
                        // Store variant info for editing
                        productUrlButton.setAttribute('data-variant-id', variantId);
                        productUrlButton.setAttribute('data-editing-variant', 'true');
                    } else {
                        productUrlButton.innerHTML = ' Add Variant URL';
                        productUrlButton.setAttribute('data-empty', 'true');
                        productUrlButton.setAttribute('data-variant-id', variantId);
                        productUrlButton.setAttribute('data-editing-variant', 'true');
                    }
                } else {
                    // Fallback to model URL if variant not found
                    if (model.product_url) {
                        productUrlButton.innerHTML = ' Edit URL';
                        productUrlButton.removeAttribute('data-empty');
                    } else {
                        productUrlButton.innerHTML = ' Add URL';
                        productUrlButton.setAttribute('data-empty', 'true');
                    }
                    productUrlButton.removeAttribute('data-variant-id');
                    productUrlButton.removeAttribute('data-editing-variant');
                }
            }
        }
        
        function updateCopyLinkUrl(card, modelId, variantId) {
            const copyButton = card.querySelector('button[onclick*="copyToClipboard"]');
            if (copyButton) {
                let newUrl;
                if (variantId === 'original') {
                    // Original variant - no variant parameter needed
                    newUrl = `https://newfurniture.live/view?id=${modelId}`;
                } else {
                    // Specific variant - include variant parameter
                    newUrl = `https://newfurniture.live/view?id=${modelId}&variant=${variantId}`;
                }
                
                // Update the onclick attribute with the new URL
                copyButton.setAttribute('onclick', `copyToClipboard('${newUrl}', this)`);
                console.log(' Updated copy link URL:', newUrl);
            }
        }
        
        // Update original variant colors ONLY for models without saved colors
        function updateOriginalVariantColors() {
            const modelCards = document.querySelectorAll('.model-card');
            modelCards.forEach(card => {
                const modelViewer = card.querySelector('model-viewer');
                const originalVariant = card.querySelector('.original-variant');
                
                if (modelViewer && originalVariant) {
                    // Check if the model already has a saved dominant color
                    const currentBackground = originalVariant.style.background;
                    const hasDefaultColor = !currentBackground || 
                                          currentBackground.includes('rgb(107, 114, 128)') || 
                                          currentBackground.includes('#6b7280');
                    
                    // Only extract color if it's using the default gray color
                    if (hasDefaultColor) {
                        console.log('Model missing dominant color, extracting...');
                        const updateColor = async () => {
                            // Add a small delay to ensure the model is fully rendered
                            setTimeout(async () => {
                                const dominantColor = await extractDominantColor(modelViewer);
                                console.log('Extracted dominant color for model:', dominantColor);
                                originalVariant.style.background = dominantColor;
                                
                                // Save the extracted color to prevent re-extraction
                                const modelId = card.querySelector('.model-id')?.textContent;
                                if (modelId) {
                                    try {
                                        await fetch('/api/update-color', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                            },
                                            body: JSON.stringify({
                                                modelId,
                                                dominantColor
                                            })
                                        });
                                    } catch (error) {
                                        console.error('Error saving extracted color:', error);
                                    }
                                }
                            }, 1000);
                        };
                        
                        if (modelViewer.loaded) {
                            updateColor();
                        } else {
                            modelViewer.addEventListener('load', updateColor, { once: true });
                        }
                    }
                }
            });
        }
        
        // Extract and save model color after upload
        async function extractAndSaveModelColor(modelId) {
            try {
                console.log('Extracting color for uploaded model:', modelId);
                
                // Find the model card that was just uploaded
                const modelCards = document.querySelectorAll('.model-card');
                let targetModelViewer = null;
                
                for (const card of modelCards) {
                    const hiddenModelId = card.querySelector('.model-id');
                    if (hiddenModelId && hiddenModelId.textContent === modelId) {
                        targetModelViewer = card.querySelector('model-viewer');
                        break;
                    }
                }
                
                if (!targetModelViewer) {
                    console.warn('Model viewer not found for uploaded model');
                    return;
                }
                
                // Wait for model to load and extract color
                const waitForLoad = () => new Promise(resolve => {
                    if (targetModelViewer.loaded) {
                        resolve();
                    } else {
                        targetModelViewer.addEventListener('load', resolve, { once: true });
                    }
                });
                
                await waitForLoad();
                
                // Small delay to ensure model is rendered
                setTimeout(async () => {
                    const dominantColor = await extractDominantColor(targetModelViewer);
                    console.log('Extracted dominant color for new model:', dominantColor);
                    
                    // Save to database
                    try {
                        const response = await fetch('/api/update-color', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                modelId,
                                dominantColor
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log(' Saved dominant color to database:', result);
                            
                            // Update the UI immediately
                            const originalVariant = targetModelViewer.closest('.model-card')?.querySelector('.original-variant');
                            if (originalVariant) {
                                originalVariant.style.background = dominantColor;
                            }
                        } else {
                            console.error('Failed to save dominant color');
                        }
                    } catch (error) {
                        console.error('Error saving dominant color:', error);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error extracting model color:', error);
            }
        }

        // Extract and save variant color after upload - FIXED to load actual variant GLB
        async function extractAndSaveVariantColor(variantId, modelId) {
            try {
                console.log(' Extracting color for uploaded variant:', variantId, 'on model:', modelId);
                
                // Find the model card with this model ID
                const modelCards = document.querySelectorAll('.model-card');
                let targetModelViewer = null;
                let targetVariantElement = null;
                let variantUrl = null;
                
                for (const card of modelCards) {
                    const hiddenModelId = card.querySelector('.model-id');
                    if (hiddenModelId && hiddenModelId.textContent === modelId) {
                        targetModelViewer = card.querySelector('model-viewer');
                        // Find the specific variant element and get its URL
                        const variants = card.querySelectorAll('.variant-circle');
                        for (const variant of variants) {
                            const onclick = variant.getAttribute('onclick');
                            if (onclick && onclick.includes(variantId)) {
                                targetVariantElement = variant;
                                // Extract the variant URL from the onclick attribute (3rd parameter in switchToVariant call)
                                // Format: switchToVariant('modelId', 'variantId', 'variantUrl', 'hexColor', 'variantType')
                                const match = onclick.match(/switchToVariant\('[^']*',\s*'[^']*',\s*'([^']*)'/);
                                if (match) {
                                    variantUrl = match[1];
                                    console.log(' Extracted variant URL:', variantUrl);
                                } else {
                                    console.warn(' Could not extract variant URL from onclick:', onclick);
                                }
                                break;
                            }
                        }
                        break;
                    }
                }
                
                if (!targetModelViewer) {
                    console.warn(' Model viewer not found for variant color extraction');
                    return;
                }
                
                if (!variantUrl) {
                    console.warn(' Variant URL not found for color extraction');
                    return;
                }
                
                console.log(' Found variant URL:', variantUrl);
                
                // Store the original model URL to restore later
                const originalSrc = targetModelViewer.src;
                
                // Load the new variant GLB into the model viewer
                console.log(' Temporarily loading variant GLB for color extraction...');
                targetModelViewer.src = variantUrl;
                
                // Wait for the variant model to load
                const waitForVariantLoad = () => new Promise(resolve => {
                    if (targetModelViewer.loaded) {
                        resolve();
                    } else {
                        targetModelViewer.addEventListener('load', resolve, { once: true });
                    }
                });
                
                await waitForVariantLoad();
                
                // Small delay to ensure variant is rendered
                setTimeout(async () => {
                    try {
                        const dominantColor = await extractDominantColor(targetModelViewer);
                        console.log(' Extracted color from variant GLB:', dominantColor);
                        
                        // Restore original model
                        console.log(' Restoring original model...');
                        targetModelViewer.src = originalSrc;
                        
                        // Save variant color to database
                        const response = await fetch('/api/update-variant-color', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                variantId,
                                dominantColor
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log(' Saved variant color to database:', result);
                            
                            // Update the variant circle color in UI
                            if (targetVariantElement) {
                                targetVariantElement.style.background = dominantColor;
                                console.log(' Updated variant circle color in UI');
                            }
                        } else {
                            console.error(' Failed to save variant color to database');
                        }
                    } catch (error) {
                        console.error(' Error during color extraction:', error);
                        // Always restore original model even if error occurs
                        targetModelViewer.src = originalSrc;
                    }
                }, 2000); // Longer delay for variant rendering
                
            } catch (error) {
                console.error(' Error extracting variant color:', error);
            }
        }
        
        // Delete a variant
        async function deleteVariant(variantId, modelId, event) {
            // Stop event propagation to prevent triggering the variant click
            event.stopPropagation();

            if (!confirm('Are you sure you want to delete this variant?')) {
                return;
            }

            try {
                const response = await fetch('/api/models', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: variantId,
                        type: 'variant'
                    })
                });

                if (response.ok) {
                    console.log(' Variant deleted successfully');
                    // Refresh the models to reflect the change
                    loadModels();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete variant');
                }

            } catch (error) {
                console.error('Error deleting variant:', error);
                alert('Failed to delete variant: ' + error.message);
            }
        }

        // Delete main/original variant (deletes the entire model)
        async function deleteMainVariant(modelId, event) {
            // Stop event propagation to prevent triggering the variant click
            event.stopPropagation();

            if (!confirm('Are you sure you want to delete the original model? This will delete the entire furniture item including all variants.')) {
                return;
            }

            try {
                const response = await fetch('/api/models', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: modelId,
                        type: 'model'
                    })
                });

                if (response.ok) {
                    console.log(' Model deleted successfully');
                    // Refresh the models to reflect the change
                    loadModels();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete model');
                }

            } catch (error) {
                console.error('Error deleting model:', error);
                alert('Failed to delete model: ' + error.message);
            }
        }
        
        // Update colors when page loads (for existing models)
        document.addEventListener('DOMContentLoaded', () => {
            // Only update colors if authenticated
            if (isAuthenticated) {
                setTimeout(updateOriginalVariantColors, 3000); // Give models time to load and render
            }
            
            // Check if we need to extract color for a newly uploaded variant
            const extractColorData = sessionStorage.getItem('extractColorForVariant');
            if (extractColorData) {
                try {
                    const { variantId, modelId } = JSON.parse(extractColorData);
                    console.log(' Found variant color extraction request:', variantId, 'for model:', modelId);
                    
                    // Clear the session storage
                    sessionStorage.removeItem('extractColorForVariant');
                    
                    // Extract color after models are loaded and rendered
                    setTimeout(async () => {
                        console.log(' Starting delayed color extraction for new variant...');
                        await extractAndSaveVariantColor(variantId, modelId);
                    }, 5000); // Wait 5 seconds for models to fully load and render
                    
                } catch (error) {
                    console.error('Error parsing variant color extraction data:', error);
                    sessionStorage.removeItem('extractColorForVariant');
                }
            }
        });

        // ========================================
        // MODERN PAGE NAVIGATION SYSTEM
        // ========================================
        
        let currentPage = 'dashboard';
        let allImages = [];
        let filteredImages = [];
        
        // Universal Page Navigation
        function navigateToPage(pageName, updateURL = true) {
            console.log(` Navigation requested to: ${pageName}`);
            
            // Update URL hash to preserve state on refresh
            if (updateURL) {
                window.location.hash = pageName;
            }
            
            // Hide all pages
            const allPages = document.querySelectorAll('.page');
            console.log(` Found ${allPages.length} pages to hide`);
            allPages.forEach(page => {
                console.log(` Hiding page:`, page.id);
                page.style.display = 'none';
            });
            
            // Show selected page
            const targetPageId = pageName + 'Page';
            const targetPage = document.getElementById(targetPageId);
            console.log(` Looking for page with ID: ${targetPageId}`, targetPage);
            
            if (targetPage) {
                targetPage.style.display = 'block';
                currentPage = pageName;
                console.log(` Successfully showed page: ${targetPageId}`);
            } else {
                console.error(` Target page not found: ${targetPageId}`);
            }
            
            // Update navigation active state
            const allNavLinks = document.querySelectorAll('.sidebar-nav-link');
            console.log(` Found ${allNavLinks.length} nav links`);
            allNavLinks.forEach(link => {
                link.classList.remove('active');
            });
            
            const activeLink = document.querySelector(`[data-page="${pageName}"]`);
            console.log(` Looking for nav link with data-page="${pageName}"`, activeLink);
            if (activeLink) {
                activeLink.classList.add('active');
                console.log(` Successfully activated nav link for: ${pageName}`);
            }
            
            // Initialize page-specific functionality
            console.log(` Initializing page-specific functionality for: ${pageName}`);
            switch(pageName) {
                case 'images':
                    console.log(` Loading images page...`);
                    loadImagesPage();
                    break;
                case 'users':
                    console.log(` Loading users page...`);
                    loadUsersPage();
                    break;
                case 'feedback':
                    console.log(` Loading feedback page...`);
                    loadFeedbackFilters();
                    loadFeedback();
                    break;
                case 'requests':
                    console.log(` Loading requests page...`);
                    loadRequests();
                    loadRequestsFilters();
                    break;
                case 'dashboard':
                    console.log(` Dashboard page (no initialization needed)`);
                    break;
                default:
                    console.warn(` Unknown page: ${pageName}`);
            }
            
            console.log(` Navigation completed to: ${pageName}`);
        }
        
        // ========================================
        // IMAGES PAGE FUNCTIONALITY
        // ========================================
        
        async function loadImagesPage() {
            try {
                console.log(' Loading images page...');
                const response = await fetch('/api/images');
                console.log(' Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(' API Response:', result);
                    
                    const images = result.images || [];
                    console.log(' Images found:', images.length);
                    
                    allImages = images;
                    filteredImages = [...allImages];
                    
                    console.log(' Populating customer filter...');
                    populateCustomerFilter();
                    
                    console.log(' Displaying images grid...');
                    displayImagesGrid();
                } else {
                    console.error(' Failed to load images:', response.status, response.statusText);
                    document.getElementById('imagesGrid').innerHTML = `
                        <div class="empty-state">
                            <h3>Failed to Load Images</h3>
                            <p>Status: ${response.status} - ${response.statusText}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(' Error loading images page:', error);
                document.getElementById('imagesGrid').innerHTML = `
                    <div class="empty-state">
                        <h3>Error Loading Images</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function populateCustomerFilter() {
            const customerFilter = document.getElementById('imageCustomerFilter');
            if (!customerFilter) return;
            
            // Clear existing options (keep "All Customers")
            customerFilter.innerHTML = '<option value="all">All Customers</option>';
            
            // Get customers from universal customer manager
            const allCustomers = customerManager.getAllCustomers();
            console.log(' Populating customer filter with:', allCustomers.length, 'customers');
            
            // Add customer options from universal system
            allCustomers.forEach(customer => {
                if (customer.id !== 'unassigned') { // Skip unassigned
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = customer.name;
                    customerFilter.appendChild(option);
                }
            });
            
            // Also add customers from images that might not be in universal system yet
            const imageCustomers = [...new Set(allImages
                .filter(img => img.customer_id && img.customer_id !== 'unassigned')
                .map(img => ({ id: img.customer_id, name: img.customer_name || img.customer_id }))
            )];
            
            imageCustomers.forEach(imgCustomer => {
                // Only add if not already in the list
                const existingOption = customerFilter.querySelector(`option[value="${imgCustomer.id}"]`);
                if (!existingOption) {
                    const option = document.createElement('option');
                    option.value = imgCustomer.id;
                    option.textContent = imgCustomer.name;
                    customerFilter.appendChild(option);
                }
            });
            
            console.log(' Customer filter populated with', customerFilter.options.length - 1, 'customers');
        }
        
        function filterImages() {
            const typeFilter = document.getElementById('imageTypeFilter').value;
            const customerFilter = document.getElementById('imageCustomerFilter').value;
            const searchFilter = document.getElementById('imageSearchFilter').value.toLowerCase();
            
            filteredImages = allImages.filter(image => {
                // Type filter
                if (typeFilter !== 'all' && image.image_type !== typeFilter) return false;
                
                // Customer filter
                if (customerFilter !== 'all' && image.customer_id !== customerFilter) return false;
                
                // Search filter
                if (searchFilter && !image.filename.toLowerCase().includes(searchFilter)) return false;
                
                return true;
            });
            
            displayImagesGrid();
        }
        
        function displayImagesGrid() {
            const grid = document.getElementById('imagesGrid');
            console.log(' Display grid called, grid element:', grid);
            console.log(' Filtered images count:', filteredImages.length);
            
            if (filteredImages.length === 0) {
                console.log(' No images to display');
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>No Images Found</h3>
                        <p>Try adjusting your filters or upload some images</p>
                    </div>
                `;
                return;
            }
            
            console.log(' Rendering', filteredImages.length, 'images');
            
            grid.innerHTML = filteredImages.map(image => `
                <div class="image-card">
                    <div class="image-preview">
                        <img src="${image.cloudinary_url}" alt="${image.filename}" loading="lazy">
                    </div>
                    <div class="image-info">
                        <div class="image-title">${image.filename}</div>
                        <div class="image-meta">
                            ${Math.round(image.file_size / 1024)} KB  
                            ${image.width}x${image.height}
                        </div>
                        <div class="image-actions">
                            <span class="image-type-badge">${image.image_type}</span>
                            <button class="image-delete-btn" onclick="deleteImageFromGrid('${image.id}', '${image.cloudinary_public_id}')">
                                
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function deleteImageFromGrid(id, cloudinaryPublicId) {
            if (!confirm('Delete this image?')) return;
            
            try {
                const response = await fetch('/api/images', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, cloudinaryPublicId })
                });
                
                if (response.ok) {
                    // Remove from local arrays
                    allImages = allImages.filter(img => img.id !== id);
                    filteredImages = filteredImages.filter(img => img.id !== id);
                    
                    // Refresh display
                    displayImagesGrid();
                    populateCustomerFilter();
                } else {
                    alert('Failed to delete image');
                }
            } catch (error) {
                console.error('Error deleting image:', error);
                alert('Error deleting image');
            }
        }
        
        // ========================================
        // USERS PAGE FUNCTIONALITY
        // ========================================
        
        async function loadUsersPage() {
            try {
                console.log(' Loading users page...');
                const usersContainer = document.getElementById('usersContainer');
                console.log(' Users container:', usersContainer);
                
                if (!usersContainer) {
                    console.error(' Users container not found!');
                    return;
                }
                
                // Load users from API
                console.log(' Fetching users from API...');
                const response = await fetch('/api/users');
                if (!response.ok) {
                    throw new Error(`Failed to load users: ${response.status}`);
                }
                
                const responseData = await response.json();
                console.log(' API Response:', responseData);
                
                // Handle both array response and object response
                const users = Array.isArray(responseData) ? responseData : (responseData.users || []);
                console.log(' Users loaded:', users.length);
                
                if (!users || users.length === 0) {
                    usersContainer.innerHTML = `
                        <div class="empty-state" style="padding: 40px; text-align: center; color: #7d8590;">
                            <h3>No Users Found</h3>
                            <p>Create your first user using the "Add User" button above</p>
                        </div>
                    `;
                    return;
                }
                
                // Generate users HTML
                usersContainer.innerHTML = users.map(user => {
                    const isAdmin = user.role === 'admin';
                    const roleDisplay = user.role === 'customer' ? 'Customer' : 'Administrator';
                    const statusClass = user.is_active ? 'active' : 'inactive';
                    const statusText = user.is_active ? 'Active' : 'Inactive';
                    
                    return `
                        <div class="user-card ${statusClass}">
                            <div class="user-avatar">
                                ${user.role === 'admin' ? '' : ''}
                            </div>
                            <div class="user-info">
                                <div class="user-name">${user.username}</div>
                                <div class="user-role-container">
                                    <span class="user-role">${roleDisplay}</span>
                                    ${user.customer_name ? `<span class="user-customer"> ${user.customer_name}</span>` : ''}
                                </div>
                                <div class="user-meta">
                                    <span class="user-status status-${statusClass}">${statusText}</span>
                                    <span class="user-created">Created: ${new Date(user.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div class="user-actions">
                                <button class="user-action-btn edit" onclick="openUserEditModal('${user.id}', '${user.username}', '${user.role}', '${user.customer_id || ''}', '${user.customer_name || ''}', ${user.is_active}, ${isAdmin})">
                                     Edit
                                </button>
                                ${!isAdmin ? `
                                    <button class="user-action-btn danger" onclick="toggleUserStatus('${user.id}', ${user.is_active})">
                                        ${user.is_active ? ' Deactivate' : ' Activate'}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log(' Users page populated successfully');
                
            } catch (error) {
                console.error(' Error loading users page:', error);
                usersContainer.innerHTML = `
                    <div class="empty-state" style="padding: 40px; text-align: center; color: #f85149;">
                        <h3>Error Loading Users</h3>
                        <p>${error.message}</p>
                        <button onclick="loadUsersPage()" class="user-action-btn">Retry</button>
                    </div>
                `;
            }
        }
        
        // ========================================
        // INITIALIZE PAGE SYSTEM
        // ========================================
        
        // Restore page from URL hash on page load
        function restorePageFromURL() {
            const hash = window.location.hash.substring(1); // Remove # from hash
            const validPages = ['dashboard', 'images', 'users', 'feedback', 'requests'];
            
            if (hash && validPages.includes(hash)) {
                navigateToPage(hash, false); // Don't update URL since we're reading from it
            } else {
                navigateToPage('dashboard', false); // Default to dashboard
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Only initialize if authenticated
            if (isAuthenticated) {
                console.log(' Modern page system initialized');
                
                // Restore current page from URL
                restorePageFromURL();
                
                // Hide variant delete buttons for non-admin users
                hideVariantDeletesForCustomers();
            }
        });
        
        // Hide variant delete buttons for customer users
        function hideVariantDeletesForCustomers() {
            const currentUser = document.getElementById('loggedInUsername')?.textContent;
            if (currentUser && currentUser !== 'admin') {
                console.log(' Customer user detected, hiding variant delete buttons');
                const deleteButtons = document.querySelectorAll('.variant-delete');
                deleteButtons.forEach(btn => {
                    btn.style.display = 'none';
                });
                
                // Also hide when new models are loaded
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                            // Check if new variant delete buttons were added
                            const newDeleteButtons = document.querySelectorAll('.variant-delete');
                            newDeleteButtons.forEach(btn => {
                                if (btn.style.display !== 'none') {
                                    btn.style.display = 'none';
                                }
                            });
                        }
                    });
                });
                
                // Observe changes to the models container
                const modelsContainer = document.getElementById('modelsContainer');
                if (modelsContainer) {
                    observer.observe(modelsContainer, { childList: true, subtree: true });
                }
            }
        }
        
        // ========================================
        // CUSTOMER LOGO MANAGEMENT
        // ========================================
        
        let currentCustomerLogoData = null;
        
        async function showCustomerLogoUpload() {
            // Get current customer info
            const customerId = document.getElementById('editCustomerId').value.trim();
            const customerName = document.getElementById('editCustomerName').value.trim();
            
            if (!customerId || !customerName) {
                alert('Please save customer information first');
                return;
            }
            
            // Update the image upload modal to be customer-specific
            document.getElementById('imageType').value = 'customer_logo';
            
            // Store customer info for the upload
            window.currentCustomerForLogo = { id: customerId, name: customerName };
            
            // Show the image upload modal
            showImageUploadModal();
        }
        
        async function loadCustomerLogo(customerId) {
            if (!customerId) return;
            
            try {
                const response = await fetch(`/api/images?imageType=customer_logo&customerId=${customerId}`);
                if (response.ok) {
                    const { images } = await response.json();
                    const customerLogo = images && images.length > 0 ? images[0] : null;
                    
                    const logoContainer = document.getElementById('currentCustomerLogo');
                    const removeBtn = document.getElementById('removeLogoBtn');
                    
                    if (customerLogo) {
                        logoContainer.innerHTML = `<img src="${customerLogo.cloudinary_url}" alt="Customer Logo">`;
                        removeBtn.style.display = 'block';
                        currentCustomerLogoData = customerLogo;
                    } else {
                        logoContainer.innerHTML = '<div class="logo-placeholder">No logo uploaded</div>';
                        removeBtn.style.display = 'none';
                        currentCustomerLogoData = null;
                    }
                }
            } catch (error) {
                console.error('Error loading customer logo:', error);
            }
        }
        
        async function removeCustomerLogo() {
            if (!currentCustomerLogoData || !confirm('Remove this customer logo?')) return;
            
            try {
                const response = await fetch('/api/images', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: currentCustomerLogoData.id,
                        cloudinaryPublicId: currentCustomerLogoData.cloudinary_public_id
                    })
                });
                
                if (response.ok) {
                    // Reset logo display
                    document.getElementById('currentCustomerLogo').innerHTML = 
                        '<div class="logo-placeholder">No logo uploaded</div>';
                    document.getElementById('removeLogoBtn').style.display = 'none';
                    currentCustomerLogoData = null;
                } else {
                    alert('Failed to remove logo');
                }
            } catch (error) {
                console.error('Error removing logo:', error);
                alert('Error removing logo');
            }
        }
        
        // Enhanced openUserEditModal to load customer logo
        const originalOpenUserEditModal = openUserEditModal;
        openUserEditModal = function(userId, username, role, customerId, customerName, isActive, isAdmin) {
            originalOpenUserEditModal(userId, username, role, customerId, customerName, isActive, isAdmin);
            
            // Load customer logo if it's a customer
            if (role === 'customer' && customerId) {
                setTimeout(() => loadCustomerLogo(customerId), 500);
            }
        };
        
        // Enhanced image upload to handle customer logos
        const originalUploadImageFile = uploadImageFile;
        uploadImageFile = async function() {
            const fileInput = document.getElementById('imageFile');
            const imageType = document.getElementById('imageType').value;
            const fileName = document.getElementById('imageFileName');
            
            if (!fileInput.files.length) return;
            
            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('imageType', imageType);
                
                // If uploading customer logo, add customer info
                if (imageType === 'customer_logo' && window.currentCustomerForLogo) {
                    formData.append('customerId', window.currentCustomerForLogo.id);
                    formData.append('customerName', window.currentCustomerForLogo.name);
                }
                
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    fileName.textContent = ` Uploaded successfully!`;
                    
                    // If it's a customer logo, refresh the logo display
                    if (imageType === 'customer_logo' && window.currentCustomerForLogo) {
                        setTimeout(() => {
                            loadCustomerLogo(window.currentCustomerForLogo.id);
                        }, 1000);
                    }
                    
                    setTimeout(() => {
                        closeImageUploadModal();
                        if (currentPage === 'images') {
                            loadImagesPage();
                        }
                    }, 1500);
                } else {
                    fileName.textContent = ` Upload couldn't complete. Please try again.`;
                    fileName.style.color = '#f85149';
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                fileName.textContent = ` Upload error: ${error.message}`;
                fileName.style.color = '#f85149';
            } finally {
                // Clean up customer logo context
                window.currentCustomerForLogo = null;
            }
        };
        
        // ===== REQUESTS MANAGEMENT =====
        async function loadRequests() {
            try {
                const statusFilter = document.getElementById('statusFilterAdmin')?.value || '';
                const customerFilter = document.getElementById('customerFilterAdmin')?.value || '';
                
                // Get all requests first
                const response = await fetch('/api/requests');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                let requests = data.requests || [];
                
                // Apply client-side filtering
                if (statusFilter) {
                    requests = requests.filter(r => r.status === statusFilter);
                }
                if (customerFilter) {
                    requests = requests.filter(r => r.customer_id === customerFilter);
                }
                
                displayRequests(requests);
                updateRequestsStats(requests);
                
            } catch (error) {
                console.error('Error loading requests:', error);
                document.getElementById('requestsContainer').innerHTML = 
                    '<div class="error">Error loading requests: ' + error.message + '</div>';
            }
        }
        
        function displayRequests(requests) {
            const container = document.getElementById('requestsContainer');
            
            if (!requests || requests.length === 0) {
                container.innerHTML = '<div class="empty-state">No requests found</div>';
                return;
            }
            
            const requestsHTML = requests.map(request => {
                const statusColor = getRequestStatusColor(request.status);
                const statusIcon = getRequestStatusIcon(request.status);
                const createdDate = new Date(request.created_at).toLocaleDateString();
                
                return `
                    <div class="request-admin-card" style="background: linear-gradient(135deg, rgba(22, 27, 34, 0.95) 0%, rgba(30, 35, 42, 0.9) 100%); border: 1px solid rgba(240, 246, 252, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                        <div class="request-admin-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div class="request-admin-title" style="font-size: 1.1rem; font-weight: 600; color: #e6edf3;">${request.title || 'Custom Furniture Request'}</div>
                            <div class="request-admin-status ${request.status}" style="color: ${statusColor}; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; background: rgba(240, 246, 252, 0.1); border: 1px solid rgba(240, 246, 252, 0.2);">
                                ${statusIcon} ${request.status.charAt(0).toUpperCase() + request.status.slice(1)}
                            </div>
                        </div>
                        
                        <div class="request-admin-content" style="margin-bottom: 20px; color: #7d8590; line-height: 1.5;">
                            <div style="margin-bottom: 8px;"><strong style="color: #e6edf3;">Customer:</strong> ${request.customer_id}</div>
                            <div style="margin-bottom: 8px;"><strong style="color: #e6edf3;">Product URL:</strong> 
                                <a href="${request.product_url}" target="_blank" rel="noopener" style="color: #58a6ff; text-decoration: none;">
                                    ${request.product_url.length > 60 ? request.product_url.substring(0, 60) + '...' : request.product_url}
                                </a>
                            </div>
                            ${request.notes ? `<div style="margin-bottom: 8px;"><strong style="color: #e6edf3;">Notes:</strong> ${request.notes}</div>` : ''}
                            ${request.admin_notes ? `<div style="margin-bottom: 8px; background: rgba(88, 166, 255, 0.1); border: 1px solid rgba(88, 166, 255, 0.2); border-radius: 8px; padding: 10px;"><strong style="color: #79c0ff;">Admin Notes:</strong> ${request.admin_notes}</div>` : ''}
                            <div><strong style="color: #e6edf3;">Submitted:</strong> ${createdDate}</div>
                        </div>
                        
                        <div class="request-admin-actions" style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <select class="futuristic-input" id="status-${request.id}" onchange="updateRequestStatus('${request.id}')" style="width: auto; min-width: 140px;">
                                <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="in_progress" ${request.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                <option value="completed" ${request.status === 'completed' ? 'selected' : ''}>Completed</option>
                                <option value="cancelled" ${request.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                            <button class="action-button secondary" onclick="openRequestNotesModal('${request.id}', '${(request.admin_notes || '').replace(/'/g, "\\'")}')">
                                Add Notes
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = requestsHTML;
        }
        
        function updateRequestsStats(requests) {
            const total = requests.length;
            const pending = requests.filter(r => r.status === 'pending').length;
            const inProgress = requests.filter(r => r.status === 'in_progress').length;
            const completed = requests.filter(r => r.status === 'completed').length;
            
            document.getElementById('totalRequestsAdmin').textContent = total;
            document.getElementById('pendingRequestsAdmin').textContent = pending;
            document.getElementById('inProgressRequestsAdmin').textContent = inProgress;
            document.getElementById('completedRequestsAdmin').textContent = completed;
        }
        
        async function updateRequestStatus(requestId) {
            try {
                const statusSelect = document.getElementById(`status-${requestId}`);
                const newStatus = statusSelect.value;
                
                const response = await fetch('/api/requests', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: requestId,
                        status: newStatus
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                if (result.success) {
                    showNotification('Request status updated successfully', 'success');
                    loadRequests(); // Reload to reflect changes
                } else {
                    throw new Error(result.error || 'Update failed');
                }
                
            } catch (error) {
                console.error('Error updating request status:', error);
                showNotification('Error updating request status: ' + error.message, 'error');
            }
        }
        
        function openRequestNotesModal(requestId, currentNotes) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            modal.innerHTML = `
                <div class="modal-content" style="background: linear-gradient(135deg, rgba(22, 27, 34, 0.95) 0%, rgba(30, 35, 42, 0.9) 100%); border: 1px solid rgba(240, 246, 252, 0.2); border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #e6edf3; margin: 0;">Admin Notes</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; color: #7d8590; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;"></button>
                    </div>
                    <div class="modal-body" style="margin-bottom: 20px;">
                        <textarea id="adminNotesInput" placeholder="Enter admin notes that will be visible to the customer..." 
                                  style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid rgba(240, 246, 252, 0.2); border-radius: 8px; background: rgba(22, 27, 34, 0.8); color: #e6edf3; resize: vertical; font-family: inherit;">${currentNotes}</textarea>
                    </div>
                    <div class="modal-actions" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="action-button secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="action-button primary" onclick="saveAdminNotes('${requestId}')">Save Notes</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function saveAdminNotes(requestId) {
            try {
                const notes = document.getElementById('adminNotesInput').value.trim();
                
                const response = await fetch('/api/requests', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: requestId,
                        adminNotes: notes
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                if (result.success) {
                    showNotification('Admin notes saved successfully', 'success');
                    document.querySelector('.modal-overlay').remove();
                    loadRequests(); // Reload to reflect changes
                } else {
                    throw new Error(result.error || 'Save failed');
                }
                
            } catch (error) {
                console.error('Error saving admin notes:', error);
                showNotification('Error saving notes: ' + error.message, 'error');
            }
        }
        
        function getRequestStatusColor(status) {
            switch (status) {
                case 'pending': return '#f1c40f';
                case 'in_progress': return '#3498db';
                case 'completed': return '#2ecc71';
                case 'cancelled': return '#e74c3c';
                default: return '#95a5a6';
            }
        }
        
        function getRequestStatusIcon(status) {
            switch (status) {
                case 'pending': return '';
                case 'in_progress': return '';
                case 'completed': return '';
                case 'cancelled': return '';
                default: return '';
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10001;
                opacity: 0;
                transition: opacity 0.3s ease;
                max-width: 400px;
            `;
            
            switch (type) {
                case 'success':
                    notification.style.background = 'linear-gradient(45deg, #2ecc71, #27ae60)';
                    break;
                case 'error':
                    notification.style.background = 'linear-gradient(45deg, #e74c3c, #c0392b)';
                    break;
                default:
                    notification.style.background = 'linear-gradient(45deg, #3498db, #2980b9)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => notification.style.opacity = '1', 10);
            
            // Auto remove
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Wallpaper Upload Modal Functions
        let wallpaperTextures = {};
        
        function toggleWallpaperUploadModal() {
            document.getElementById('wallpaperUploadModal').style.display = 'flex';
            loadCustomersForWallpaper();
        }
        
        function closeWallpaperUploadModal() {
            document.getElementById('wallpaperUploadModal').style.display = 'none';
            document.getElementById('wallpaperUploadForm').reset();
            document.getElementById('wallpaperUploadProgress').style.display = 'none';
            document.getElementById('wallpaperProgressBar').style.width = '0%';
            document.getElementById('wallpaperProgressPercentage').textContent = '0%';
            wallpaperTextures = {};
            clearAllWallpaperPreviews();
        }

        function loadCustomersForWallpaper() {
            try {
                const select = document.getElementById('wallpaperCustomerSelect');
                select.innerHTML = '<option value="">Select Customer</option>';
                
                // Use existing customer manager directly
                const customers = customerManager.getAllCustomers();
                if (customers && customers.length > 0) {
                    customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = `${customer.id}:${customer.name}`;
                        option.textContent = customer.name;
                        select.appendChild(option);
                    });
                } else {
                    // Fallback NAPO option
                    const napoOption = document.createElement('option');
                    napoOption.value = 'napo:NAPO';
                    napoOption.textContent = 'NAPO';
                    select.appendChild(napoOption);
                }
            } catch (error) {
                console.error('Error loading customers for wallpaper:', error);
                showNotification('Failed to load customers', 'error');
            }
        }

        function handleWallpaperTextureUpload(textureType, inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('Please select a valid image file', 'error');
                inputElement.value = '';
                return;
            }

            // Store texture
            wallpaperTextures[textureType] = file;

            // Show preview
            const previewContainer = document.getElementById(`${textureType}Preview`);
            const placeholderElement = document.getElementById(`${textureType}Placeholder`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Hide placeholder and show preview
                if (placeholderElement) placeholderElement.style.display = 'none';
                
                previewContainer.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(88, 166, 255, 0.1); border: 1px solid rgba(88, 166, 255, 0.3); border-radius: 8px;">
                        <img src="${e.target.result}" style="width: 48px; height: 48px; object-fit: cover; border-radius: 6px;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="color: #58a6ff; font-weight: 500; font-size: 0.9rem; margin-bottom: 2px;">${textureType.charAt(0).toUpperCase() + textureType.slice(1)} Map</div>
                            <div style="color: #7d8590; font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.name}</div>
                            <div style="color: #7d8590; font-size: 0.7rem;">${(file.size / 1024).toFixed(1)} KB</div>
                        </div>
                        <button onclick="removeWallpaperTexture('${textureType}')" style="background: rgba(248, 81, 73, 0.1); color: #f85149; border: 1px solid rgba(248, 81, 73, 0.3); border-radius: 6px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem;"></button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);

            updateWallpaperUploadButton();
        }

        function removeWallpaperTexture(textureType) {
            delete wallpaperTextures[textureType];
            
            // Clear preview and show placeholder again
            const previewContainer = document.getElementById(`${textureType}Preview`);
            const placeholderElement = document.getElementById(`${textureType}Placeholder`);
            
            if (previewContainer) previewContainer.innerHTML = '';
            if (placeholderElement) placeholderElement.style.display = 'block';
            
            // Clear file input
            const input = document.getElementById(`wallpaper${textureType.charAt(0).toUpperCase() + textureType.slice(1)}Input`);
            if (input) input.value = '';
            
            updateWallpaperUploadButton();
        }

        function clearAllWallpaperPreviews() {
            ['albedo', 'normal', 'roughness', 'height'].forEach(type => {
                // Clear preview and show placeholder
                const previewContainer = document.getElementById(`${type}Preview`);
                const placeholderElement = document.getElementById(`${type}Placeholder`);
                
                if (previewContainer) previewContainer.innerHTML = '';
                if (placeholderElement) placeholderElement.style.display = 'block';
                
                // Clear file input
                const input = document.getElementById(`wallpaper${type.charAt(0).toUpperCase() + type.slice(1)}Input`);
                if (input) input.value = '';
            });
        }

        function updateWallpaperUploadButton() {
            const uploadBtn = document.getElementById('wallpaperUploadButton');
            
            if (!uploadBtn) {
                console.error('wallpaperUploadButton element not found! Available buttons:', 
                    document.querySelectorAll('#wallpaperUploadModal button'));
                return;
            }
            
            const hasAlbedo = wallpaperTextures.albedo;
            const textureCount = Object.keys(wallpaperTextures).length;
            
            if (hasAlbedo) {
                uploadBtn.disabled = false;
                if (textureCount === 1) {
                    uploadBtn.textContent = ' Generate AR Wallpaper';
                } else {
                    uploadBtn.textContent = ` Generate AR Wallpaper (${textureCount} textures)`;
                }
                uploadBtn.style.opacity = '1';
                uploadBtn.style.cursor = 'pointer';
            } else {
                uploadBtn.disabled = true;
                uploadBtn.textContent = ' Upload Albedo first';
                uploadBtn.style.opacity = '0.6';
                uploadBtn.style.cursor = 'not-allowed';
            }
        }

        async function uploadWallpaper() {
            const customerValue = document.getElementById('wallpaperCustomerSelect').value;
            const [customerId, customerName] = customerValue.split(':');
            const title = document.getElementById('wallpaperTitle').value;
            const width = parseFloat(document.getElementById('wallWidth').value) || 2.44;
            const height = parseFloat(document.getElementById('wallHeight').value) || 2.44;
            const tileRepeat = parseFloat(document.getElementById('tileRepeat').value) || 4;

            if (!customerValue || !customerId) {
                showNotification('Please select a customer', 'error');
                return;
            }

            if (!title.trim()) {
                showNotification('Please enter a wallpaper title', 'error');
                return;
            }

            if (!wallpaperTextures.albedo) {
                showNotification('Albedo texture is required', 'error');
                return;
            }

            // Show progress
            document.getElementById('wallpaperUploadProgress').style.display = 'block';
            const progressBar = document.getElementById('wallpaperProgressBar');
            const progressPercentage = document.getElementById('wallpaperProgressPercentage');

            try {
                // Create FormData
                const formData = new FormData();
                formData.append('customerId', customerId);
                formData.append('title', title);
                formData.append('width', width);
                formData.append('height', height);
                formData.append('tileRepeat', tileRepeat);

                // Add texture files
                Object.entries(wallpaperTextures).forEach(([type, file]) => {
                    formData.append(`${type}Texture`, file);
                });

                // Upload with progress
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressBar.style.width = percentComplete + '%';
                        progressPercentage.textContent = Math.round(percentComplete) + '%';
                    }
                });

                xhr.onload = function() {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            showNotification('Wallpaper uploaded successfully!', 'success');
                            closeWallpaperUploadModal();
                            loadModels(); // Refresh the model list
                        } else {
                            throw new Error(response.error || 'Upload failed');
                        }
                    } else {
                        throw new Error('Upload failed');
                    }
                };

                xhr.onerror = function() {
                    throw new Error('Network error during upload');
                };

                xhr.open('POST', '/api/upload-wallpaper');
                xhr.send(formData);

            } catch (error) {
                console.error('Upload error:', error);
                showNotification('Upload failed: ' + error.message, 'error');
                document.getElementById('wallpaperUploadProgress').style.display = 'none';
            }
        }
    </script>
        </div>
    </div>
</body>
</html>
<!-- test comment -->
